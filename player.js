"use strict";function RNG(e){this.m=2147483648,this.a=1103515245,this.c=12345,this.state=e?e:Math.floor(Math.random()*(this.m-1))}var GLOBAL_BRIGHTNESS=.05,GLOBAL_SATURATION=1,Color=function(e){return e},Color255=function(e){return Math.scale(e,1/255)},ColorFromHex=function(e){var t=[(16711680&e)>>16,(65280&e)>>8,255&e];return Vec.decPlaces(Vec.scale(t,1/255),3)},ColorHex=function(e){var t=Vec.floor(Vec.scale(e,255));return 65536*t[0]+256*t[1]+t[2]};_.bindFunctions=function(e){for(var t in e)_.isFunction(e[t])&&_.bindAll(e,t)},_.isEqual2=function(e,t){if(e==t)return!0;if(_.isArray(e)&&_.isArray(t)){if(e.length!=t.length)return!1;for(var i in e)if(e[i]!=t[i])return!1;return!0}return!1};var Vec={};_.valueSelect=function(e,t){var i=Math.floor(.999*t*e.length);return e[i]},Math.clamp=function(e,t,i){return Math.min(Math.max(e,t),i)},Math.sign=function(e){return 0>e?-1:1},Math.absMin=function(e,t){return Math.abs(e)<Math.abs(t)?e:t},Math.inOut=function(e,t){return e>=1?1:Math.pow(e,t)/(Math.pow(e,t)+Math.pow(1-e,t))},Math.area=function(e,t,i){var a=Math.cross(Math.sub(t,e),Math.sub(i,e));return.5*Math.length(a)},Vec.area=Math.area,Math.radians=function(e){return e/180*Math.PI},Math.degrees=function(e){return e/Math.PI*180},Math.dot=function(e,t){for(var i=0,a=0,s=e.length;s>a;a++)i+=e[a]*t[a];return i},Vec.dot=Math.dot,Vec.scalarProject=function(e,t){return Vec.dot(e,Vec.normalize(t))},Vec.project=function(e,t){return Vec.setLength(t,Vec.dot(e,Vec.normalize(t)))},Vec.projectPlane=function(e,t){return Vec.sub(e,Vec.project(e,t))},Math.cross=function(e,t){return[e[1]*t[2]-e[2]*t[1],-(e[0]*t[2]-e[2]*t[0]),e[0]*t[1]-e[1]*t[0]]},Vec.cross=Math.cross,Math.setLength=function(e,t){return Math.scale(Math.normalize(e),t)},Vec.setLength=Math.setLength,Math.addLength=function(e,t){return Math.add(e,Math.setLength(e,t))},Vec.addLength=Math.addLength,Vec.isZero=function(e){return!e[1]&&!e[2]&&!e[0]},Vec.floor=function(e){for(var t=[],i=0;i<e.length;i++)t[i]=Math.floor(e[i]);return t},Math.perpendicular=function(e,t){if(Vec.isZero(e)||Vec.isZero(t))return[0,1,0];var i=Vec.angleBetween(e,t);return.001>i||i>Math.PI-.001?0==e[0]&&0==e[2]?[1,0,0]:Math.normalize(Vec.cross(Math.normalize(e),[0,1,0])):Math.normalize(Math.cross(Math.normalize(e),Math.normalize(t)))},Vec.perpendicular=Math.perpendicular,Vec.copyInto=function(e,t){for(var i=0;i<e.length;i++)e[i]=t[i];return e},Math.invert=function(e){return Math.scale(e,-1)},Vec.invert=Math.invert,Math.copy=function(e){for(var t=[],i=0;i<e.length;i++)t[i]=e[i];return t},Vec.copy=Math.copy,Math.add=function(e,t){for(var i=[],a=0;a<e.length;a++)i[a]=e[a]+t[a];return i},Vec.add=Math.add,Math.sum=function(e){for(var t=0,i=0;i<e.length;i++)t+=e[i];return t},Math.sum3=function(e){return Math.add(Math.add(e[0],e[1]),e[2])},Vec.sum=function(e){for(var t=e[0],i=1,a=e.length;a>i;i++)t=Vec.add(t,e[i]);return t},Math.factorial=_.memoize(function(e){return 1>=e?1:e*Math.factorial(e-1)}),Math.choose=function(e,t){return Math.factorial(e)/(Math.factorial(t)*Math.factorial(e-t))},Math.average=function(e){for(var t=[0,0,0],i=0;i<e.length;i++)t=Math.add(t,e[i]);return Math.scale(t,1/e.length)},Vec.decPlaces=function(e,t){for(var i=[],a=0;a<e.length;a++)i[a]=Number(e[a].toFixed(t));return i},Vec.average=function(e){return Vec.scale(Vec.sum(e),1/e.length)},Math.linearTo=function(e,t,i){return t>e?Math.min(e+i,t):e>t?Math.max(e-i,t):e},Math.lerp=function(e,t,i){return i=Math.min(i,1),e*(1-i)+t*i},Vec.lerp=function(e,t,i){for(var a=[],s=0;s<e.length;s++)a.push(e[s]+(t[s]-e[s])*i);return a},Vec.bezier2=function(e,t){var i=e.length;return 1==i?e[0]:2==i?Vec.lerp(e[0],e[1],t):Vec.bezier([Vec.bezier(e.slice(0,i-1),t),Vec.bezier(e.slice(1,i),t)],t)},Vec.displace=function(e,t,i){return Vec.add(e,Vec.setLength(t,i))},Vec.moveTo=function(e,t,i){var a=Vec.sub(t,e),s=Vec.length(a);return Vec.add(e,Vec.setLength(a,Math.min(i,s)))},Vec.bezier=function(e,t){for(var i=e.length,a=[0,0,0],s=0;i>s;s++)a=Vec.add(a,Vec.scale(e[s],Math.pow(1-t,i-1-s)*Math.pow(t,s)*Math.choose(i-1,s)));return a},Math.multiply=function(e,t){for(var i=[],a=0;a<e.length;a++)i[a]=e[a]*t[a];return i},Vec.multiply=Math.multiply,Math.sub=function(e,t){for(var i=[],a=0;a<e.length;a++)i[a]=e[a]-t[a];return i},Vec.sub=Math.sub,Math.distancesq=function(e,t){for(var i=0,a=0,s=e.length;s>a;a++)i+=(e[a]-t[a])*(e[a]-t[a]);return i},Math.distance=function(e,t){return Math.sqrt(Math.distancesq(e,t))},Vec.distance=Math.distance,Vec.rectDistance=function(e,t){return Math.sum(Vec.abs(Vec.sub(e,t)))},Vec.distancesq=Math.distancesq,Math.length=function(e){return Math.distance(e,[0,0,0,0])},Vec.length=Math.length,Vec.lengthsq=function(e){return Math.distancesq(e,[0,0,0,0])},Math.scale=function(e,t){for(var i=[],a=0;a<e.length;a++)i[a]=e[a]*t;return i},Vec.scale=Math.scale,Vec.abs=function(e){for(var t=[],i=0;i<e.length;i++)t[i]=Math.abs(e[i]);return t},Vec.clone=_.clone,Vec.swapAxes=function(e){var t=[];return t[0]=e[1],t[1]=e[2],t[2]=e[0],t},Vec.toAxis=function(e){for(var t,i=_.clone(e),a=-1e4,s=i.length,r=0;s>r;r++)Math.abs(i[r])>a&&(a=Math.abs(i[r]),t=r);return i[t]=Math.sign(i[t]),i[(t+1)%s]=0,i[(t+2)%s]=0,i},Vec.STRING_AXIS={px:[1,0,0],nx:[-1,0,0],nz:[0,0,-1],pz:[0,0,1],ny:[0,-1,0],py:[0,1,0]},Vec.axisString=function(e){return e[0]>.1?"px":e[0]<-.1?"nx":e[1]>.1?"py":e[1]<-.1?"ny":e[2]>.1?"pz":e[2]<-.1?"nz":void 0},Math.normalize=function(e){var t=Math.distance(e,[0,0,0,0,0]);return Math.scale(e,1/t)},Vec.normalize=Math.normalize,Math.angleBetween=function(e,t){return Math.acos(Math.dot(Vec.normalize(e),Vec.normalize(t)))||0},Vec.angleBetween=Math.angleBetween,Vec.rotateAxisAngle=function(e,t,i){var a=[],s=Math.cos(i),r=Math.sin(i),n=1-s,o=t[0],l=t[1],h=t[2];return a[0]=e[0]*(n*o*o+s)+e[1]*(n*o*l-h*r)+e[2]*(n*o*h+l*r),a[1]=e[0]*(n*o*l+h*r)+e[1]*(n*l*l+s)+e[2]*(n*l*h-o*r),a[2]=e[0]*(n*o*h-l*r)+e[1]*(n*l*h+o*r)+e[2]*(n*h*h+s),a},Vec.randomAngle=function(){var e=Math.randomReal(.5*-Math.PI,.5*Math.PI),t=Math.randomReal(-Math.PI,Math.PI),i=Math.cos(e),a=Math.sin(e),s=Math.cos(t),r=Math.sin(t),n=1;return[n*i*s,n*a,-n*r*i]},Math.PI2=2*Math.PI,Math.angleDifference=function(e,t){var i=Math.abs(e-t)%Math.PI2;return i>Math.PI&&(i=Math.PI2-i),i},RNG.prototype.nextInt=function(){return this.state=(this.a*this.state+this.c)%this.m,this.state},RNG.prototype.nextFloat=function(){return this.nextInt()/(this.m-1)},Math.rng=new RNG(1),Math.srand=function(e){Math.rng.state=e},_.randomKey=function(e){var t,i=0;for(var a in e)i++,Math.randomReal(0,1)<1/i&&(t=a);return t},Math.randomInt=function(e,t){return Math.floor(e+(t-e+1)*Math.rng.nextFloat())},Math.randomReal=function(e,t){return e+(t-e)*Math.rng.nextFloat()},Vec.randomSphere=function(e,t,i){var a=Math.randomReal(e,t),s=Math.randomReal(0,2*Math.PI);i=i||1;var r=Math.randomReal(-i,i);return[Math.sqrt(1-r*r)*Math.cos(s)*a,Math.sqrt(1-r*r)*Math.sin(s)*a,r*a]},_.randomShuffle=function(e){for(var t,i,a=e.length;0!==a;)i=Math.floor(Math.randomReal(0,1)*a),a-=1,t=e[a],e[a]=e[i],e[i]=t;return e},Math.quantize=function(e,t,i,a){e=Math.clamp(e,t,i);var s=(i-t)/a;return e=t+Math.floor((e-t)/s)*s},Math.gaussReal=function(e,t,i){var a=0;i=i||2;for(var s=0;i>s;s++)a+=Math.randomReal(e,t);return a/i},Math.vary=function(e,t){return t=t||.1*e,e+Math.gaussReal(-t,t)},Vec.vary=function(e,t){for(var i=[],a=0,s=e.length;s>a;a++)i.push(Math.vary(e[a],t));return i},Vec.randomBox=function(e,t){return[Math.randomReal(e[0],t[0]),Math.randomReal(e[1],t[1]),Math.randomReal(e[2],t[2])]};var HTML={};HTML.tag=function(e,t){return"<"+t+">"+e+"</"+t+">"};var Str={};Str.asPercent=function(e){return 0==e?"--":Math.floor(100*e)+"%"};var Enum=function(e){for(var t={},i=0;i<e.length;i++)t[e[i]]=i;return t};$.fn.toggleClick=function(){var e=arguments;return this.click(function(){var t=$(this).data("iteration")||0;e[t].apply(this,arguments),t=(t+1)%e.length,$(this).data("iteration",t)})};var GAME={};!function(){GAME.now=function(){return window.performance&&window.performance.now?_.bind(window.performance.now,window.performance):_.bind(Date.now,Date)}(),GAME.SECONDS=1e3,GAME.MINUTES=60*GAME.SECONDS,GAME.HOURS=60*GAME.MINUTES,GAME.SYSTEM={Android:function(){return navigator.userAgent.match(/Android/i)}(),Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)}(),iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)}()},GAME.storage=function(){try{var e=window.localStorage,t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch(i){var a={};return{setItem:function(e,t){a[e]=t},getItem:function(e){return a[e]},removeItem:function(e){delete a[e]}}}}(),(GAME.SYSTEM.Android||GAME.SYSTEM.iOS||GAME.SYSTEM.Windows)&&(GAME.SYSTEM.MOBILE=1),GAME.lastTick=GAME.now(),GAME.tick=function(e){void 0!=e&&console.log(e,GAME.now()-GAME.lastTick),GAME.lastTick=GAME.now()},GAME.log=function(e){window.console&&console.log(e)},GAME.elog=function(e){window.console&&console.log("<! GAME ERROR !>",e)},GAME.templates={};var e=$(".hbs-template");_.map(e,function(e){GAME.templates[$(e).attr("name")]=Handlebars.compile(e.text)}),GAME.AudioEffect=function(e,t){this.audioCtx=t,this.gain=t.createGain(),this.gain.gain.value=0,this.targetVolume=e.volume||.1,this.osc=t.createOscillator();var i=t.createBufferSource();switch(i.buffer=e.noiseBuffer,i.loop=!0,this.noise=i,this.noiseGain=t.createGain(),this.noiseGain.gain.value=.01,i.connect(this.noiseGain),this.osc.type="square",this.osc.frequency.value=350,this.osc.connect(this.gain),this.masterVolume=1,this.gain.connect(t.destination),this.noiseGain.connect(t.destination),this.synthTime=0,this.type=e.type,e.type){case"JETPACK":this.noise.start(t.currentTime),this.osc.start(t.currentTime);break;case"DASH":this.noise.start(t.currentTime);break;case"ICE_BOMB":this.osc.frequency.value=1864.66,this.osc.frequency.setTargetAtTime(3135.96,t.currentTime+200,.1),this.osc.start(t.currentTime),this.noise.start(t.currentTime)}var a=_.bind(this.stop,this);_.delay(a,3e3)},GAME.AudioEffect.prototype.update=function(e){if(!this.finished)switch(this.synthTime+=e,this.type){case"JETPACK":this.osc.detune.value=100*-this.synthTime;var t=Math.sin(80*Math.pow(this.synthTime+1,-.5));this.gain.gain.value=t*Math.max(this.targetVolume-.01*this.synthTime,0)*this.masterVolume,this.noiseGain.gain.value=Math.max(this.targetVolume-.03*this.synthTime,0)*this.masterVolume;break;case"DASH":var i=Math.sin(50*this.synthTime);this.noiseGain.gain.value=Math.max(this.targetVolume-.2*this.synthTime,0)*this.masterVolume*i;break;case"ICE_BOMB":this.gain.gain.value=Math.max(this.targetVolume-.3*this.synthTime,0)*this.masterVolume,this.noiseGain.gain.value=Math.max(this.targetVolume-.3*this.synthTime,0)*this.masterVolume}},GAME.AudioEffect.prototype.stop=function(){if(!this.finished){this.finished=!0;var e=this.audioCtx;this.gain.gain.setValueAtTime(this.gain.gain.value,e.currentTime),this.noiseGain.gain.setValueAtTime(this.noiseGain.gain.value,e.currentTime);var t=.2;switch(this.gain.gain.linearRampToValueAtTime(.001,e.currentTime+t),this.noiseGain.gain.linearRampToValueAtTime(.001,e.currentTime+t),this.type){case"JETPACK":this.osc.stop(e.currentTime+t),this.noise.stop(e.currentTime+t);break;case"DASH":this.noise.stop(e.currentTime+t);break;case"ICE_BOMB":this.osc.stop(e.currentTime+t),this.noise.stop(e.currentTime+t)}}},GAME.Synth=function(e,t){if(this.audioCtx=t,this.gain=t.createGain(),this.gain2=t.createGain(),this.gain.gain.value=0,this.gain2.gain.value=0,this.targetVolume=e.volume||1,this.fadeInDur=1,this.osc=t.createOscillator(),this.osc2=t.createOscillator(),this.osc.connect(this.gain),this.osc2.connect(this.gain2),delete e.position,e.pan)this.panner=this.audioCtx.createPanner(),this.panner.panningModel="equalpower",this.panner.setPosition(e.pan,0,1-Math.abs(e.pan)),this.gain.connect(this.panner),this.gain2.connect(this.panner),this.panner.connect(t.destination);else if(e.position){var i=this.audioCtx.createPanner();i.panningMode="HRTF",i.distanceModel="inverse",i.refDistance=3,i.rolloffFactor=1,i.coneInnerAngle=360,i.coneOuterAngle=0,i.coneOuterGain=0;var a=e.position;i.setOrientation(-a[0],-a[1],-a[2]),i.setPosition(a[0],a[1],a[2]),this.panner=i,this.gain.connect(this.panner),this.gain2.connect(this.panner),this.panner.connect(t.destination)}else this.gain.connect(this.audioCtx.destination),this.gain2.connect(this.audioCtx.destination);this.osc.type=e.synthType1||"triangle",this.osc2.type=e.synthType2||"sine",this.osc.frequency.value=e.frequency,this.osc2.frequency.value=e.frequency;var s=e.delay||0;this.duration=e.duration||this.targetVolume/.09,this.start=t.currentTime+s;var r=this.start;try{this.osc.start(r),this.osc2.start(r)}catch(n){}this.humpTime=Math.clamp(.1*this.duration,.05,.15),e.prepare&&e.prepare(this,this.start),this.detune=e.detune||5,this.gain.gain.setValueAtTime(.001,r),this.gain2.gain.setValueAtTime(.001,r),this.gain.gain.linearRampToValueAtTime(this.targetVolume,r+this.humpTime),this.gain2.gain.linearRampToValueAtTime(this.targetVolume*(e.synth2Gain||.5),r+this.humpTime),this.gain.gain.linearRampToValueAtTime(.001,r+this.duration),this.gain2.gain.linearRampToValueAtTime(.001,r+this.duration),this.synthTime=-s,this.stop=_.bind(this.stop,this),this.duration?this.stopTimeout=_.delay(this.stop,1e3*(s+this.duration)):this.stopTimeout=_.delay(this.stop,1e3*(3+s))},GAME.Synth.prototype.update=function(e){if(!this.finished){if(this.synthTime+=e,this.synthTime>this.duration)return void this.stop();if(!(this.synthTime<0)&&this.osc){var t=Math.max(30*this.synthTime,5);this.osc.detune.value=this.detune+Math.sin(40*this.synthTime)*t,this.osc2.detune.value=-this.detune+Math.sin(40*this.synthTime)*t}}},GAME.Synth.prototype.stop=function(){var e=this.audioCtx;if(this.finished=!0,clearTimeout(this.stopTimeout),this.osc){this.gain.disconnect(),this.gain2.disconnect(),this.osc.disconnect(),this.osc2.disconnect();try{this.osc.stop(e.currentTime),this.osc2.stop(e.currentTime)}catch(t){}this.osc=void 0,this.osc2=void 0}},GAME.AudioManager=Backbone.Model.extend({initialize:function(){this.stopSynth=_.bind(this.stopSynth,this),this.synths=[],this.effects=[];var e=window.AudioContext||window.webkitAudioContext;return e?(this.audioCtx=this.audioCtx||new e,void this.setupWhiteNoise()):void this.disableSounds()},setupWhiteNoise:function(){for(var e=this.audioCtx,t=2*e.sampleRate,i=e.createBuffer(1,t,e.sampleRate),a=i.getChannelData(0),s=0;t>s;s++)a[s]=2*Math.random()-1;this.noiseBuffer=i},sounds:{},hasSound:function(e){return this.sounds[e]},loadSounds:function(e){if(this.audioCtx)for(var t in e){var i=e[t].volume||80,a=new XMLHttpRequest;a.open("GET",e[t].src+".mp3",!0),a.responseType="arraybuffer",this.sounds[t]={volume:i,callback:e[t].callback},a.onload=function(e,t,i){return function(){var a=t.response;i.audioCtx.decodeAudioData(a,function(t){i.sounds[e].buffer=t,i.sounds[e].callback&&i.sounds[e].callback()},function(e){})}}(t,a,this),a.send()}},orientListener:function(e,t,i){this.disabled},disableSounds:function(){this.disabled=!0,this.stopSynth()},enableSounds:function(){this.disabled=!1},stopEffects:function(){for(var e=0;e<this.effects.length;e++)this.effects[e].stop();this.effects=[]},stopSynth:function(){for(var e=0;e<this.synths.length;e++)this.synths[e].stop();for(var e=0;e<this.effects.length;e++)this.effects[e].stop();this.synths=[],this.effects=[],this.stopUpdating()},stopUpdating:function(){window.clearInterval(this.updateInterval),this.updateInterval=void 0},startUpdating:function(){if(!this.updateInterval){var e=this;this.lastUpdate=GAME.now(),this.updateInterval=window.setInterval(function(){var t=GAME.now();e.updateSynth(.001*(t-e.lastUpdate)),e.lastUpdate=t},5)}},midiFreq:function(e){var t=440;return t/32*Math.pow(2,(e-9)/12)},updateSynth:function(e){var t=!1;if(this.isPlayingSequence||0!=this.effects.length||0!=this.synths.length||this.stopUpdating(),this.isPlayingSequence){var i=.001*(GAME.now()-this.sequenceStart);this.sequenceTime+=e;var a=.075/12;if(a*=this.sequenceRate,this.sequenceIndex<this.activeSequence.notes.length)for(var s=this.activeSequence.notes[this.sequenceIndex];s.st*a<i+e;){if(s.et*a>i+e){var r=s.st*a-i;this.playSynth({delay:r,frequency:this.midiFreq(s.n+8),duration:(s.et-s.st)*a,volume:this.sequenceVolume*this.sequenceMasterVolume})}if(this.sequenceIndex+=1,this.sequenceIndex>=this.activeSequence.notes.length)break;s=this.activeSequence.notes[this.sequenceIndex]}i+e>this.activeSequence.info.duration&&(this.sequenceTime=this.sequenceTime-this.activeSequence.info.duration,this.sequenceStart=GAME.now()+1e3*(this.activeSequence.info.duration-i),this.sequenceIndex=0)}for(var n=0;n<this.synths.length;n++)this.synths[n].update(e),this.synths[n].finished&&(t=!0,this.synths[n]=void 0);t&&(this.synths=_.compact(this.synths));for(var o,n=0;n<this.effects.length;n++)this.effects[n].update(e),this.effects[n].finished&&(o=!0,this.effects[n]=void 0);o&&(this.effects=_.compact(this.effects))},playEffect:function(e){if(!this.disabled){this.startUpdating(),e.noiseBuffer=this.noiseBuffer;var t=new GAME.AudioEffect(e,this.audioCtx);return this.effects.push(t),t}},playSynth:function(e){if(!this.disabled){e.synthType1=e.synthType1||this.synthType1||"triangle",e.synthType2=e.synthType2||this.synthType2||"sine",e.detune=e.detune||this.detune||5,e.synth2Gain=e.synth2Gain||this.synth2Gain||.5;var t=new GAME.Synth(e,this.audioCtx);this.synths.push(t),this.startUpdating()}},stopSequence:function(){this.isPlayingSequence=0},setSequenceVolume:function(e){this.sequenceMasterVolume=e},playSequence:function(e,t){GAME.SYSTEM.MOBILE||(this.sequenceMasterVolume=this.sequenceMasterVolume||1,this.startUpdating(),this.sequenceTime=0,this.sequenceStart=GAME.now(),this.sequenceRate=t.rate||1,t.delay&&(this.sequenceTime=-t.delay,this.sequenceStart+=1e3*t.delay),this.activeSequence=e,this.activeSequence.info.duration*=this.sequenceRate,this.sequenceIndex=0,this.isPlayingSequence=1,this.sequenceVolume=t.volume)},playSound:function(e,t){if(!this.disabled&&(t=t||{},this.sounds[e]&&this.sounds[e].buffer)){var i={},a=this.audioCtx.createBufferSource();a.buffer=this.sounds[e].buffer;var s=this.audioCtx.createGain();if(s.gain.value=t.volume||this.sounds[e].volume,a.loop=t.loop||!1,t.loop&&(a.loop=!0,this.sounds[e].source=a),a.playbackRate.value=t.speed||1,t.position){var r=this.audioCtx.createPanner();r.panningMode="HRTF",r.distanceModel="inverse",r.refDistance=.01,r.maxDistance=.5,r.rolloffFactor=1,r.coneInnerAngle=360,r.coneOuterAngle=0,r.coneOuterGain=0,r.setOrientation(1,0,0);var n=t.position;r.setPosition(n[0],n[1],n[2]),s.gain.value=10*s.gain.value,a.connect(r),r.connect(s),i.panner=r}else a.connect(s);return s.connect(this.audioCtx.destination),a.start(this.audioCtx.currentTime+(t.delay||0)),i.source=a,i.gain=s,i}},stopSound:function(e){this.sounds[e]&&this.sounds[e].source&&this.sounds[e].source.stop()}}),GAME.Models={},GAME.Models.Model=Backbone.Model.extend({initialize:function(e){_.extend(this,e),_.isFunction(this.setup)&&this.setup()},getAPI:function(e,t,i,a){this.ajax(e,t,"GET",i,a)},postAPI:function(e,t,i,a){this.ajax(e,t,"POST",i,a)},ajax:function(e,t,i,a,s){this.clientVersion&&(t=t||{},t.client_version=this.clientVersion),$.ajax({url:e,data:t,type:i||"GET",success:a,error:s||this.printError,dataType:"json"})},printError:function(e,t,i){this.trigger("api-error"),this._htmlError=[e,t,i],console.log(e,t,i)},addPair:function(e,t,i){var a=this.attributes[e]||{};a[t]=i,this.trigger("change:"+e),this.trigger("all")},set:function(e,t){if(_.isObject(e))for(var i in e)this.set(i,e[i]);else _.isEqual2(this.attributes[e],t)||(this.attributes[e]=t,this.trigger("change:"+e),this.trigger("all"))},get:function(e){return this.attributes[e]},increase:function(e,t){this.set(e,this.get(e)+t)},onChange:function(e,t){var i=this;this.on("change:"+e,function(){t(i.get(e))})}}),GAME.State=GAME.Models.Model.extend({setup:function(){this.focusList=this.focusList||[]},pushFocus:function(e){this.focusList.push(e),this.set("focus",e)},popFocus:function(){0!=this.focusList.length&&(this.focusList.pop(),this.set("focus",_.last(this.focusList)))},setFocus:function(e){this.focusList=[e],this.set("focus",e)}}),GAME.User=GAME.Models.Model.extend({setup:function(){_.bindAll(this,"updateFacebookStatus")},network:0,connectGoogle:function(e,t,i){return window.gapi&&window.gapi.client?void i():(window.gapi_onload=function(){gapi.client.setApiKey(e),gapi.load("auth2",function(){var e=gapi.auth2.init({client_id:t,scope:"profile",fetch_basic_profile:!1});e.then(function(){i()})})},void $.getScript("https://apis.google.com/js/client:platform.js").done(function(){}).fail(function(){i({error:"GOOGLE_ERROR",message:"There was an error contacting the google login server"})}))},connectFacebook:function(e,t){return window.FB?void t():void $.getScript("//connect.facebook.net/en_US/sdk.js").done(function(){return"undefined"==typeof FB?void t("error"):(FB.init({appId:e,cookie:!0,xfbml:!0,version:"v2.4"}),void t())}).fail(function(){t({error:"FACEBOOK_ERROR",message:"There was an error contacting the facebook login server"})})},loginToFacebook:function(){window.FB&&window.FB.login(this.updateFacebookStatus)},loginToGoogle:function(e){if(window.gapi){var t=gapi.auth2.getAuthInstance().signIn({prompt:"select_account",scope:"profile",fetch_basic_profile:!1});return t.then(_.bind(this.updateGoogleStatus,this)),!1}},getFacebookStatus:function(e){var t=this;FB&&FB.getLoginStatus(function(i){t.updateFacebookStatus(i),e&&e()})},getCredentials:function(){return this.network?{network:this.network,network_data:this.networkData}:null},updateGoogleStatus:function(){var e=gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse();e.access_token&&(this.network="google",this.networkData={accessToken:e.access_token}),this.trigger("status-change")},updateFacebookStatus:function(e){"connected"==e.status?(this.network="facebook",this.networkData=e.authResponse):"facebook"==this.network&&(this.signedIn=!1,delete this.networkData),this.trigger("status-change")}}),GAME.KEY_CODES={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",32:"space",37:"left",38:"up",39:"right",40:"down",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",73:"i",74:"j",77:"m",80:"p",81:"q",82:"r",83:"s",84:"t",86:"v",87:"w",88:"x",89:"y",90:"z"},GAME.KeyPressed={},$(document).keydown(function(e){GAME.KEY_CODES[e.which]&&(GAME.KeyPressed[GAME.KEY_CODES[e.which]]=!0)}),$(document).keyup(function(e){GAME.KEY_CODES[e.which]&&(GAME.KeyPressed[GAME.KEY_CODES[e.which]]=!1)}),GAME.Views={},GAME.Views.View=Backbone.View.extend({initialize:function(e){_.extend(this,e),_.bindFunctions(this),void 0!==this.template&&(this.renderTemplate=GAME.templates[this.template]),_.isFunction(this.setup)&&this.setup(),_.isFunction(this.resize)&&($(window).resize(this.resize),this.resize())},_handlePopHistory:function(e){this.handlePopHistory(e.originalEvent)},handlePopHistory:function(){},historyBack:function(){var e=e||window.history;e&&e.back&&e.back()},pushHistory:function(e,t,i){var a=this,s=s||window.history;s&&s.pushState&&(s.pushState(e,t,i),window.onpopstate=function(e){a._handlePopHistory(e)})},getAPI:GAME.Models.Model.prototype.getAPI,ajax:GAME.Models.Model.prototype.ajax,postAPI:GAME.Models.Model.prototype.postAPI,printError:GAME.Models.Model.prototype.printError,renderFromTemplate:function(e){e=e||{},this.$el.html(this.renderTemplate(e))}}),GAME.Views.UI=GAME.Views.View.extend({events:{mousemove:"_handleMouseMove",mouseleave:"_handleMouseLeave",mouseup:"_handleMouseUp",mousewheel:"_handleMouseWheel",click:"_handleClick",keydown:"_handleKeypress"},initialize:function(e){this.mouseIsOver=!1,this.mouseOffset=[0,0],GAME.Views.View.prototype.initialize.call(this,e),$(document).keydown(this._handleKeypress),this.$el.keydown(this._handleKeypress),this.$el.on("touchstart",this.handleTouchStart),this.$el.on("touchmove",this.handleTouchMove),this.$el.on("touchend",this.handleTouchStop)},exitFullScreen:function(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()},goFullScreen:function(){function e(e){if(e.webkitRequestFullScreen)e.webkitRequestFullScreen(e.ALLOW_KEYBOARD_INPUT);else if(e.msRequestFullscreen)e.msRequestFullscreen();else{var t=e.requestFullscreen||e.requestFullscreen||e.mozRequestFullScreen;t&&t.call(e)}}this.$el[0];e($("body")[0])},allowPointerLocking:function(){document.addEventListener("pointerlockchange",this.pointerLocked,!1),document.addEventListener("mozpointerlockchange",this.pointerLocked,!1),document.addEventListener("webkitpointerlockchange",this.pointerLocked,!1),this.pointerLock=!1},unlockPointer:function(){this.pointerLock&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock())},lockPointer:function(){if(!this.pointerLock){var e=this.$el[0];e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock()}},handlePointerLockEvent:function(){},pointerLocked:function(){var e=this.$el[0];document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e?this.pointerLock=!0:this.pointerLock=!1,this.handlePointerLockEvent()},_handleClick:function(e){this.handleClick(e)},_handleMouseMove:function(e){this.mouseIsOver=!0;var t=e.originalEvent;this.pointerLock?(this.mouseDx=(t.movementX||t.mozMovementX||t.webkitMovementX||0)/this.$el.width(),this.mouseDy=(t.movementY||t.mozMovementY||t.webkitMovementY||0)/this.$el.height(),this.handleMouseDelta(this.mouseDx,this.mouseDy)):(this.mouseOffset=[e.pageX-this.$el.offset().left,e.pageY-this.$el.offset().top],(this.mouseOffset[0]>this.$el.width()||this.mouseOffset[0]<0||this.mouseOffset[1]>this.$el.height()||this.mouseOffset[1]<0)&&(this.mouseIsOver=!1)),this.mouseX=this.mouseOffset[0]/this.$el.width()-.5,this.mouseY=this.mouseOffset[1]/this.$el.height()-.5,this.mouseX*=2,this.mouseY*=-2},handleClick:function(){},handleMouseMove:function(){this.trigger("mouse_moved")},_handleMouseLeave:function(e){this.mouseIsOver=!1,this.handleMouseLeave()},handleMouseLeave:function(){this.trigger("mouse_out")},handleMouseDown:function(e){switch(e.which){case 1:this.handleClick();break;case 3:this.handleRightClick()}return!1},_handleMouseUp:function(e){this.handleMouseUp()},handleMouseUp:function(){},_handleMouseWheel:function(e,t,i,a){this.handleMouseWheel(i,a)},handleMouseWheel:function(e,t){},handleKeypress:function(e){},_handleKeypress:function(e){return this.handleKeypress(GAME.KEY_CODES[e.which])},_handleKeyup:function(e){this.handleKeyup(e.which)},handleKeyup:function(e){},handleRightClick:function(){}}),GAME.Format={timeFromMS:function(e,t){e/=1e3;var i=Math.floor(e/60),a=Math.floor(e%60),s=a.toFixed(void 0!=t?t:2);return 9.5>a&&(s="0"+s),i+":"+s}},GAME.HTMLAnim={},GAME.HTMLAnim.fadeOut=function(e,t,i){i&&e.stop(),e.animate({opacity:0},t,"easeInOutCubic",function(){$(this).hide()})},GAME.HTMLAnim.fadeIn=function(e,t,i){i&&e.stop(),e.show(),e.css({opacity:0}),e.animate({opacity:1},t,"easeInOutCubic")},GAME.HTMLAnim.NumberScroller=Backbone.View.extend({initialize:function(e){_.bindFunctions(this),_.extend(this,e),this.places=this.places||0,this.prefix=this.prefix||""},animateNumber:function(e,t,i){this.startValue=e,this.endValue=t,this.startTime=GAME.now(),this.duration=i||1e3,this.animation=setInterval(this.animateStep,50)},animateStep:function(){var e=(GAME.now()-this.startTime)/this.duration;e>1&&(clearInterval(this.animation),e=1);var t=Math.lerp(this.startValue,this.endValue,e);0==this.places?this.$el.html(this.prefix+Math.floor(t)):this.$el.html(this.prefix+t.toFixed(this.places))}}),GAME.HTMLAnim.TypeAnimator=Backbone.View.extend({initialize:function(e){_.bindFunctions(this),_.extend(this,e)},prepareText:function(e){for(var t=[],i=e,a=i.indexOf("<span");a>-1;){t.push({begin:"",text:i.substr(0,a),end:""}),i=i.slice(a);var s=i.indexOf(">")+1,r=i.substr(0,s);i=i.slice(s);var n=i.indexOf("</span>"),o=i.substr(0,n);i=i.slice(n+7),t.push({begin:r,text:o,end:"</span>"}),a=i.indexOf("<span")}return i.length>0&&t.push({begin:"",text:i,end:""}),t},animateText:function(e,t,i){this.$el.html(""),window.clearTimeout(this.clearTextTimeout),window.clearInterval(this.interval),this.text=e,this.texts=this.prepareText(e),this.textLength=0;for(var a=0;a<this.texts.length;a++)this.textLength+=this.texts[a].text.length;this.mode=t||"type",this.duration=i||50*this.textLength,this.startTime=GAME.now(),this.percentageComplete=0,this.interval=setInterval(this.step,50)},getTimeRemaining:function(){return(1-this.percentageComplete)*this.duration},finish:function(e){clearInterval(this.interval),e&&_.isFunction(this.callback)&&this.callback()},clearText:function(){this.$el.html(""),console.log("clearin")},step:function(){switch(this.percentageComplete=(GAME.now()-this.startTime)/this.duration,this.percentageComplete=Math.min(this.percentageComplete,1),this.mode){case"untype":var e=Math.floor((1-this.percentageComplete)*this.text.length),t=this.text.substr(0,e);this.$el.html(t);break;case"type":for(var e=Math.floor(this.percentageComplete*this.textLength),t="",i=0;i<this.texts.length;i++){var a=this.texts[i],s=a.text.length;if(t=[t,a.begin,a.text.substr(0,e),a.end].join(""),e-=s,0>=e)break}this.$el.html(t)}return this.percentageComplete>=1?void this.finish():void 0}}),GAME.Views.Draggable=GAME.Views.UI.extend({initialize:function(e){GAME.Views.UI.prototype.initialize.call(this,e),this.active=this.active||!0,void 0==this.domain&&GAME.elog("Draggable lacks domain")},handleMouseDown:function(){this.active&&this.handleSelected(!0)},handleMouseUp:function(){this.selected&&this.unfollowMouse()},handleSelected:function(e){this.selected=e,e?(this.domain.on("mouse_moved",this.followMouse,this),this.domain.on("mouse_up",this.unfollowMouse,this),this.domain.on("mouse_out",this.unfollowMouse,this)):(this.domain.off("mouse_moved",this.followMouse,this),this.domain.off("mouse_up",this.unfollowMouse,this),this.domain.off("mouse_out",this.unfollowMouse,this))},unfollowMouse:function(){this.handleSelected(!1)},followMouse:function(){this.centerAt(this.domain.mouseOffset)},centerAt:function(e){this.$el.css({top:Math.clamp(e[1]-.5*this.$el.height(),0,this.domain.$el.height()-this.$el.height()),left:Math.clamp(e[0]-.5*this.$el.width(),0,this.domain.$el.width()-this.$el.width())})}})}(),function(){var e=1,t=!1,i=!1,a=0;GAME.GFX={},THREE.Color.prototype.setColor=function(e){this.setRGB(e[0],e[1],e[2])};var s=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],r=new THREE.Vector3,n=(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Quaternion),o=new THREE.Quaternion,l=(new THREE.Quaternion,new THREE.Matrix4),h=new THREE.Plane,c=(new THREE.Triangle,new THREE.Ray);GAME.GFX.tempRaycaster=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3);var u=new THREE.Vector3(0,0,1),d=new THREE.Vector3(0,0,0),m=GAME.GFX;m.ZERO=d,m.UP=new THREE.Vector3(0,1,0),m.xAxis=new THREE.Vector3(1,0,0),m.yAxis=new THREE.Vector3(0,1,0),m.zAxis=new THREE.Vector3(0,0,1),m.TEMPVEC3=new THREE.Vector3(0,0,0),m.tempEuler=new THREE.Euler,m.tempMat4=new THREE.Matrix4,m.IDENTITY=new THREE.Matrix4,m.tempColor=new THREE.Color,m.tempRay=c,m.tempVec3=new THREE.Vector3,m.temp2Vec3=new THREE.Vector3,m.temp3Vec3=new THREE.Vector3,m.temp4Vec3=new THREE.Vector3,m.TEMP_GEOMETRY=new THREE.PlaneGeometry(1e-4,1e-4),m.EmptyGeometry=new THREE.Geometry,m.BlankMaterial=new THREE.Material,m.DefaultMaterial=new THREE.MeshLambertMaterial({vertexColors:THREE.FaceColors,color:16777215}),m.DefaultShinyMaterial=new THREE.MeshPhongMaterial({vertexColors:THREE.FaceColors,color:16777215,shininess:20,specular:16777181});var p=function(e){return new THREE.Vector3(e[0],e[1],e[2])};m.ArraytoV3=p,m.V3toArray=function(e){return[e.x,e.y,e.z]},m.WEBGL=function(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"));
}catch(t){return!1}}(),m.CANVAS=!!window.CanvasRenderingContext2D,m.colladaLoader=new THREE.ColladaLoader,m.refreshColladaLoader=function(){m.colladaLoader=new THREE.ColladaLoader},m.textureLoader=new THREE.TextureLoader,m.easeUp=function(e){return 1-(1-e)*(1-e)},m.easeDown=function(e){return e*e},m.lerp=function(e,t,i){for(var a=[],s=0;s<e.length;s++)a.push(e[s]+(t[s]-e[s])*i);return a},m.rotateV3AxisAngle=function(e,t,i){var a=Vec.rotateAxisAngle(e,Vec.normalize(t),i);return a},m.slerpVec2=function(e,t,i,a,s){var r=Vec.angleBetween(t,i),n=r*a;if(.001>n)return e;var o;r>Math.PI-.01&&s?(o=Vec.perpendicular(t,s),o=Vec.perpendicular(o,t)):o=Vec.perpendicular(t,i);var l=m.rotateV3AxisAngle(e,o,n);return l},m.slerpVec=function(e,t,i,a,s,r){var n=Vec.length(e),o=Vec.length(t),l=Math.lerp(n,o,i),h=Vec.angleBetween(e,t),c=h*i;if(void 0!==a&&a>c&&(c=Math.min(a,h)),void 0!=s&&c>s&&(c=Math.min(s,h)),.001>c)return Vec.setLength(e,l);var u=Vec.perpendicular(e,t);h>=Math.PI-.01&&r&&(u=Vec.perpendicular(e,r),u=Vec.perpendicular(u,e)),isNaN(u[0])&&console.log("crossnan",e,t);var d=Vec.setLength(m.rotateV3AxisAngle(e,u,c),l);return Vec.length(d)<1e-4||isNaN(d[0])?(console.log("Math death",e,t,i),[0,1,0]):d},m.slerpEuler=function(e,t,i){var a=m.tempEuler;return a.set(e[0],e[1],e[2],"XYZ"),n.setFromEuler(a),a.set(t[0],t[1],t[2],"XYZ"),o.setFromEuler(a),n.slerp(o,i),a.setFromQuaternion(n,"XYZ"),[a.x,a.y,a.z]},m.gpsToVec3=function(e,t,i){var a=e*Math.PI/180,s=t*Math.PI/180-.5*Math.PI,r=Math.cos(a),n=Math.sin(a),o=Math.cos(s),l=Math.sin(s),h=i;return[h*r*o,h*n,-h*l*r]},m.dispose=function(e,t){t._scene.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.map},m.sampleTriangle=function(e,t,i){var a=Vec.sub(t,e),s=Vec.sub(i,e),r=[Math.random(),Math.random()],n=e;if(Math.sum(r)>1){var o=Vec.sum(e,a,s);a=Vec.sub(i,o),s=Vec.sub(t,o),n=o}return Vec.add(n,Vec.add(Vec.scale(a,r[0]),Vec.scale(s,r[1])))},m.sampleFace=function(e,t){return m.sampleTriangle(vs[face.a].toArray(),vs[face.b].toArray(),vs[face.c].toArray())},m.remakeGeometry=function(e){var t=e.__directGeometry,i=e.faces,a=e.vertices,s=e.faceVertexUvs[0];if(t){for(var r=0,n=i.length;n>r;r++){var o=i[r],l=3*r,h=l+1,c=l+2;t.vertices[l]=a[o.a],t.vertices[h]=a[o.b],t.vertices[c]=a[o.c],t.normals[l]=o.normal,t.normals[h]=o.normal,t.normals[c]=o.normal,t.colors[l]=o.color,t.colors[h]=o.color,t.colors[c]=o.color,t.uvs[l]=s[r][0],t.uvs[h]=s[r][1],t.uvs[c]=s[r][2]}var u=e._bufferGeometry;u.attributes.position.copyVector3sArray(t.vertices),u.attributes.color.copyColorsArray(t.colors),u.attributes.uv.copyVector2sArray(t.uvs),u.attributes.normal.copyVector3sArray(t.normals),u.attributes.position.needsUpdate=!0,u.attributes.color.needsUpdate=!0,u.attributes.normal.needsUpdate=!0,u.attributes.uv.needsUpdate=!0}},m.Group=GAME.Models.Model.extend({initialize:function(e){_.bindFunctions(this),_.extend(this,e),this.euler=new THREE.Vector3,this.children=[],_.isFunction(this.setup)&&this.setup(),void 0===this.glObject&&(this.glObject=new THREE.Object3D),this.rotationalDrag=0},sortChildren:function(e){m.tempVec3.fromArray(e);for(var t=m.tempVec3,i=this.glObject.children,a=0;a<i.length;a++)i[a]._9=i[a].position.distanceToSquared(t);i.sort(function(e,t){return e._9<t._9?1:e._9>t._9?-1:0})},distanceTo:function(e){return _.isArray(e)?Vec.distance(this.getPosition(),e):Vec.distance(this.getPosition(),e.getPosition())},setScale:function(e){return _.isArray(e)?void this.glObject.scale.set(e[0],e[1],e[2]):(this.scale=e,void this.glObject.scale.set(e,e,e))},getScale:function(){return this.glObject.scale.x},faceDirection:function(e,t){t=t||[0,1,0],this.glObject.up.set(t[0],t[1],t[2]);var i=this.getPosition();this.glObject.lookAt(m.ArraytoV3(Vec.add(e,i)))},lookAt:function(e,t){t=t||[0,1,0],this.debugging&&console.log("LookAt",e,t),this.glObject.up.set(t[0],t[1],t[2]),this.glObject.lookAt(new THREE.Vector3(e[0],e[1],e[2]))},rotateAxisAngle:function(e,t){r.fromArray(e),this.glObject.quaternion.setFromAxisAngle(r,t)},setEuler:function(e){this.euler.set(e[0],e[1],e[2]),this.glObject.quaternion.setFromEuler(new THREE.Euler(e[0],e[1],e[2],"XYZ"))},getEuler:function(){return[this.euler.x,this.euler.y,this.euler.z]},getVectorToCamera:function(){return this.glObject.updateMatrixWorld(),r.set(0,0,1),this.glObject.worldToLocal(r),r.normalize(),[r.x,r.y,r.z]},setRotationalDrag:function(e){this.rotationalDrag=e},setRotationalVelocity:function(e){void 0===this.rotationVel?this.rotationVel=new THREE.Vector3(e[0],e[1],e[2]):this.rotationVel.set(e[0],e[1],e[2])},lerpRotationalVelocity:function(e,t){t=Math.clamp(t,0,1),r.set(e[0],e[1],e[2]),this.rotationVel=this.rotationVel||new THREE.Vector3,this.rotationVel.lerp(r,t)},add:function(e,t){if(_.isArray(e))for(var i=0;i<e.length;i++)this.add(e[i]);else e.parent&&e.parent.remove(e),this.children.push(e),e.parentID=this.children.length-1,e.parent=this,t?(e.glObject.parent=this.glObject,this.glObject.children.unshift(e.glObject)):this.glObject.add(e.glObject)},remove:function(e){e&&e.glObject&&(this.glObject.remove(e.glObject),this.children[e.parentID]=void 0,this.flagRemoval=!0)},clear:function(e){for(var t=0;t<this.children.length;t++)this.children[t]&&(this.children[t].clear(e),e&&this.children[t].destroy(),this.remove(this.children[t]))},transferTo:function(e){var t=this.getWorldPosition();this.parent.remove(this),e.add(this);var i=e.getLocalPosition(t);this.setPosition(i)},setPosition:function(e){this.debugging&&console.log("setPos",e),this.glObject.position.set(e[0],e[1],e[2])},setPositionFromGPS:function(e,t){var i=m.gpsToVec3(e[0],e[1],t);this.glObject.position.set(i[0],i[1],i[2]);var a=this.glObject.position.clone().multiplyScalar(1.2);this.glObject.lookAt(a)},getPosition:function(e){return[this.glObject.position.x,this.glObject.position.y,this.glObject.position.z]},getWorldPosition:function(e){var t=d.clone();return e&&t.set(e[0],e[1],e[2]),this.glObject.updateMatrixWorld(),this.glObject.localToWorld(t),[t.x,t.y,t.z]},getLocalPosition:function(e){var t=r;return t.set(e[0],e[1],e[2]),this.glObject.updateMatrixWorld(),this.glObject.worldToLocal(t),[t.x,t.y,t.z]},_update:function(e){for(var t=0,i=this.children.length;i>t;t++)this.children[t]&&this.children[t]._update(e);if(this.flagRemoval){this.children=_.compact(this.children);for(var t=0,i=this.children.length;i>t;t++)this.children[t].parentID=t;this.flagRemoval=!1}if(void 0!==this.rotationVel){r.copy(this.rotationVel);var a=Math.clamp(this.rotationalDrag*e,0,1);r.multiplyScalar(a),this.rotationVel.sub(r),r.copy(this.rotationVel),r.multiplyScalar(e),r.add(this.euler),this.setEuler([r.x,r.y,r.z])}_.isFunction(this.update)&&this.update(e)},handleMouseDown:function(){this.hover&&(this.active=!0)},handleMouseUp:function(){this.active=!1},intersectRay:function(e,t){m.tempRaycaster.ray.origin.fromArray(e),m.tempRaycaster.ray.direction.fromArray(t);var i=m.tempRaycaster.intersectObject(this.glObject,!0);return i[0]},castShadows:function(){this.glObject.castShadow=!0},receiveShadows:function(){this.glObject.receiveShadow=!0},setVisibility:function(e,t){t=t||{},t.remember&&(this.savedVisibility=this.glObject.visible),t.fromMemory&&(e=this.savedVisibility),this.glObject.visible=e;for(var i=0;i<this.children.length;i++)this.children[i]&&this.children[i].setVisibility(e,t)},setChildrenMaterial:function(e){if(this.glObject&&this.glObject.children)for(var t=0;t<this.glObject.children.length;t++)this.glObject.children[t].material=e},moveInOrbit:function(e,t,i){var a=this.glObject.position.clone().negate().normalize(),s=(new THREE.Matrix4).copy(this.glObject.matrix);s.setPosition(d);var r=u.clone().applyMatrix4(s).normalize();r=p(t);var n=(new THREE.Vector3).crossVectors(r,a).normalize();return r.crossVectors(a,n).normalize(),s.makeRotationAxis(r,e[0]/i),this.glObject.position.applyMatrix4(s),r.applyMatrix4(s),s.makeRotationAxis(n,e[1]/i),this.glObject.position.applyMatrix4(s),r.applyMatrix4(s),this.glObject.position.setLength(i),[r.x,r.y,r.z]}}),m.StarField=m.Group.extend({setup:function(){var e=new THREE.Geometry;e.dynamic=!1,this.opacity=this.opacity||1,this.size=this.size||8,this.targetSize=this.size;var t=new THREE.PointsMaterial({size:this.size,color:this.color||16777215,transparent:this.opacity<1,opacity:this.opacity,depthTest:!1});this.material=t,this.glObject=new THREE.Points(e,t),this.glObject.sortParticles=!1,this.numParticles=this.numParticles||1200;for(var i=this.distance||100,a=0;a<this.numParticles;a++){var s=Math.randomReal(1,2)*i,r=Math.randomReal(0,2*Math.PI),n=Math.randomReal(-1,1);this.glObject.geometry.vertices.push(new THREE.Vector3(Math.sqrt(1-n*n)*Math.cos(r)*s,Math.sqrt(1-n*n)*Math.sin(r)*s,n*s))}},burst:function(){this.size=1.7*this.targetSize},update:function(t){this.twinkle?(this.time=this.time||0,this.time+=t,this.material.size=this.size*e*(1+.1*Math.sin(this.time*this.twinkle*Math.PI))):this.material.size=this.size*e,this.size=Math.lerp(this.size,this.targetSize,3*t)}}),m.ParticleSystem=m.Group.extend({setup:function(){var e=new THREE.Geometry;e.dynamic=!0,void 0!=this.dynamic&&(e.dynamic=this.dynamic),this.particleSize=this.particleSize||1,this.material||(this.material=new THREE.PointsMaterial({size:this.particleSize,color:this.particleColor||16777215,transparent:!0,opacity:this.particleOpacity||.5}),this.defaultMaterial=1),this.glObject=new THREE.Points(e,this.material),this.glObject.frustumCulled=!1,this.initParticles()},destroy:function(){this.glObject.geometry.dispose(),this.material.sharedAsset||this.material.dispose()},initParticles:function(){},update:function(t){this.defaultMaterial?this.material.size=this.particleSize*e:this.material&&this.material.uniforms&&this.material.uniforms.scale&&(this.material.uniforms.scale.value=this.particleSize*e)}});var f=new THREE.IcosahedronGeometry(1,0);m.makeSeedGeometry=function(e,t){var i=f.clone();for(var a in i.vertices){var s=i.vertices[a];s.x*=e,s.y*=e,s.z+=.5,s.z*=t}return i};var g=new THREE.BoxGeometry(2,2,2);m.makeBodyGeometry=function(e,t,i,a,s){var r=g.clone();for(var n in r.vertices){var o=r.vertices[n];o.z<0?(o.z=0,o.x*=t,o.y*=i):(o.z=e[2],o.x=e[0]+o.x*a,o.y=e[1]+o.y*s)}return r};var v=(new THREE.Vector2(0,0),new THREE.Vector2(0,1),.9),y=new THREE.Vector2(0,0),b=new THREE.Vector2(v,0),E=new THREE.Vector2(.33*v,0),M=new THREE.Vector2(.66*v,0),w=new THREE.Vector2(0,1),T=new THREE.Vector2(v,1),P=new THREE.Vector2(.33*v,1),S=new THREE.Vector2(.66*v,1),A=function(e,t,i){e[t+"+"+i]=e[t+"+"+i]||0,e[t+"+"+i]+=1,e[i+"+"+t]=e[i+"+"+t]||0,e[i+"+"+t]+=1};m.extrudeQuads=function(e,t,i){for(var a={},s=[],r=0;r<t.length;r++)s.push(2*t[r],2*t[r]+1);for(var n=0;n<s.length;n+=2)A(a,e.faces[s[n]].a,e.faces[s[n]].b),A(a,e.faces[s[n]].a,e.faces[s[n]].c),A(a,e.faces[s[n+1]].a,e.faces[s[n+1]].b),A(a,e.faces[s[n+1]].b,e.faces[s[n+1]].c);for(n=0;n<s.length;n+=2)m.extrudeQuad(e,s[n],s[n+1],i,a);e.mergeVertices()},m.extrudeQuad=function(e,t,i,a,s){var r=e.faces[t],n=e.faces[i];s=s||{};var o=new THREE.Vector3;o.copy(r.normal),o.setLength(a);var l,h,c,u,d=e.vertices,m=r.a,p=r.b,f=r.c,g=n.b,v=new THREE.Vector3;v.addVectors(d[m],o),l=d.length,d.push(v),v=new THREE.Vector3,v.addVectors(d[p],o),h=d.length,d.push(v),v=new THREE.Vector3,v.addVectors(d[f],o),c=d.length,d.push(v),v=new THREE.Vector3,v.addVectors(d[g],o),u=d.length,d.push(v);var y=e.faces;(s[r.a+"+"+r.b]||0)<2&&(y.push(new THREE.Face3(m,p,l)),y.push(new THREE.Face3(p,h,l))),(s[r.b+"+"+n.b]||0)<2&&(y.push(new THREE.Face3(p,g,h)),y.push(new THREE.Face3(g,u,h))),(s[r.c+"+"+n.b]||0)<2&&(y.push(new THREE.Face3(g,f,u)),y.push(new THREE.Face3(f,c,u))),(s[r.c+"+"+r.a]||0)<2&&(y.push(new THREE.Face3(f,m,c)),y.push(new THREE.Face3(m,l,c))),r.a=l,r.b=h,r.c=c,n.a=h,n.b=u,n.c=c,e.computeFaceNormals()},m.removeJoinedTiles=function(e){for(var t={},i=e.vertices,a=0;a<e.faces.length;a+=2){var s=new THREE.Vector3,r=e.faces[a];e.faces[a+1];s.add(i[r.b]),s.add(i[r.c]),s.multiplyScalar(.5);var n=i[r.a].distanceTo(i[r.b])/2,o=Math.round(s.x/n)+","+Math.round(s.y/n)+","+Math.round(s.z/n);void 0!=t[o]&&(e.faces.splice(a,2),e.faces.splice(t[o],2),a-=4),t[o]=a}},m.extrudeFace=function(e,t,i,a){var s=e.faces[t],r=s.normal.clone().setLength(i);m.perturb(r,.5*i);var n=e.vertices;a=a||0;var o=new THREE.Vector3;o.addVectors(n[s.a],n[s.b]),o.add(n[s.c]),o.multiplyScalar(1/3),o.add(r),n.push((new THREE.Vector3).addVectors(n[s.a],r));var l=n.length-1,h=s.a;n.push((new THREE.Vector3).addVectors(n[s.b],r));var c=n.length-1,u=s.b;n.push((new THREE.Vector3).addVectors(n[s.c],r));var d=n.length-1,p=s.c;n[l].lerp(o,1-a),n[c].lerp(o,1-a),n[d].lerp(o,1-a),e.faces.push(new THREE.Face3(h,u,l)),e.faces.push(new THREE.Face3(u,c,l)),e.faces.push(new THREE.Face3(u,p,c)),e.faces.push(new THREE.Face3(p,d,c)),e.faces.push(new THREE.Face3(p,h,d)),e.faces.push(new THREE.Face3(h,l,d));var f=e.faces.length;return s.a=l,s.b=c,s.c=d,e.faceVertexUvs[0][f-6]=[y,E,w],e.faceVertexUvs[0][f-5]=[E,P,w],e.faceVertexUvs[0][f-4]=[E,M,P],e.faceVertexUvs[0][f-3]=[M,S,P],e.faceVertexUvs[0][f-2]=[M,b,S],e.faceVertexUvs[0][f-1]=[b,T,S],e.computeFaceNormals(),[t]},m.perturb=function(e,t){t*=.5,e.x+=Math.randomReal(-t,t),e.y+=Math.randomReal(-t,t),e.z+=Math.randomReal(-t,t)},m.extrudeFaceToPoint=function(e,t,i){var a=e.faces[t],s=e.vertices;i=i||s[a.a].distanceTo(s[a.b]);var r=a.normal.clone().setLength(i),n=new THREE.Vector3;n.addVectors(s[a.a],s[a.b]),n.add(s[a.c]),n.multiplyScalar(1/3),n.add(r),e.vertices.push(n);var o=e.vertices.length-1,l=a.c;return a.c=o,e.faces.push(new THREE.Face3(a.b,l,o)),e.faces.push(new THREE.Face3(l,a.a,o)),[e.faces.length-1,e.faces.length-2,t]},m.makeSphereGeometry=function(e,t,i){e=e||1,t=t||1,i=i||[1,1,1];var a=new THREE.IcosahedronGeometry(e,t);return l.makeScale(i[0],i[1],i[2]),a.applyMatrix(l),a},m.transformGeometry=function(e){var t=new THREE.Vector3(1,1,1);_.isNumber(e.scale)?t.multiplyScalar(e.scale):_.isArray(e.scale)&&t.fromArray(e.scale);var i=e.euler||[0,0,0],a=new THREE.Euler(i[0],i[1],i[2],"XYZ"),s=m.ArraytoV3(e.translate||[0,0,0]);return l.compose(s,(new THREE.Quaternion).setFromEuler(a),t),e.geometry.applyMatrix(l),e.geometry},m.makePrismGeometry=function(e,t,i,a,s,r,n,o){o=o||[1,1],n=n||[0,0,i];var l=new THREE.Geometry;a=a||1;for(var h=0;t>h;h++){var c=h*(2*Math.PI/t)+.5*Math.PI;l.vertices.push(new THREE.Vector3(Math.cos(c)*e*o[0],Math.sin(c)*e*o[1],0)),l.vertices.push(new THREE.Vector3(Math.cos(c)*e*a*o[0]+n[0],Math.sin(c)*e*a*o[1]+n[1],n[2]));var u=2*h,d=(h+1)%t*2,p=u+1,f=d+1,g=2*t,v=s?2*t+1:2*t;s&&l.faces.push(new THREE.Face3(u,g,d)),r&&l.faces.push(new THREE.Face3(f,v,p)),l.faces.push(new THREE.Face3(u,d,p)),l.faces.push(new THREE.Face3(d,f,p))}return s&&l.vertices.push(new THREE.Vector3(0,0,0)),r&&l.vertices.push(m.ArraytoV3(n)),l.computeFaceNormals(),l},m.makePyramidGeometry=function(e,t,i){var a=new THREE.Geometry;a.faceVertexUvs=[];var s=!1;0>i&&(s=!0,i*=-1);for(var r=0;t>r;r++){var n=r*(2*Math.PI/t)-.5*Math.PI;a.vertices.push(new THREE.Vector3(Math.cos(n)*e,Math.sin(n)*e,0)),a.faces.push(new THREE.Face3(t,(r+1)%t,r)),a.faces.push(new THREE.Face3(r,(r+1)%t,t+1))}return a.vertices.push(new THREE.Vector3(0,0,0)),a.vertices.push(new THREE.Vector3(0,0,i)),s&&(l.makeRotationX(Math.PI),a.applyMatrix(l)),a.computeFaceNormals(),a},m.scaleGeometry=function(e,t){l.makeScale(t,t,t),e.applyMatrix(l)},m.distortGeometry=function(e,t){for(var t=t||.005,i=0,a=Math.vary(1),s=[Math.gaussReal(-i,i),Math.gaussReal(-i,i)],n=e.vertices,o=0,l=n.length;l>o;o++){var h=n[o];r.set(Math.gaussReal(-t,t)+s[0],Math.gaussReal(-t,t)+s[1],Math.gaussReal(-t,t)),h.z<.001&&(r.z=0),h.add(r),h.multiplyScalar(a)}},m.setFaceColors=function(e,t,i){var a,s=15/255,r=e.faces;i&&i.color?(a=new THREE.Color,a.setRGB(i.color[0],i.color[1],i.color[2])):_.isNumber(i)&&(s=i);for(var n=0,o=r.length;o>n;n++){var l=r[n];_.isArray(t)?l.color.setRGB(t[0],t[1],t[2]):l.color.set(t),i&&(a?l.color.lerp(a,Math.gaussReal(0,i.amount)):(l.color.r+=Math.gaussReal(-s,s),l.color.g+=Math.gaussReal(-s,s),l.color.b+=Math.gaussReal(-s,s)))}};var V=Math.floor(1e3*Math.random());m.Object3D=m.Group.extend({getGeometry:function(){return this.loaded===!1?{waitingObject:this}:this.glObject.geometry},getSeed:function(){return this.OBJSEED||(this.OBJSEED=V++),this.OBJSEED},getMaterial:function(){return this.glObject.material},useFaceColors:function(){this.glObject.material.vertexColors=THREE.FaceColors},useVertexColors:function(){this.glObject.material.vertexColors=THREE.VertexColors},prepareColladaMaterial:function(e,t){var i=e.material;if(0==e.geometry.faceVertexUvs[0].length)for(var a=0;a<e.geometry.faces.length;a++)e.geometry.faceVertexUvs[0][a]=s;if(t){e.material=t.clone();for(var r in e.material.uniforms)e.material.uniforms[r]=t.uniforms[r];i.map&&(e.material.uniforms.tex={type:"t",value:i.map}),e.material.map=i.map}},finishLoadingCollada:function(e){this.glObject=e.scene.children[0],this.glObject.material=this.material,this.glObject.geometry&&(this.glObject.geometry.sharedAsset=!0),this.setScale(this.scale||1),this.loaded=!0,this.trigger("loaded")},replaceMesh:function(e,t){var i=this.glObject;return i.visible=!1,this.glObject=new THREE.Mesh(e,t),this.geometry=e,this.material=t,i.parent&&(i.parent.add(this.glObject),this.glObject.position.copy(i.position),this.glObject.quaternion.copy(i.quaternion),this.glObject.scale.copy(i.scale.clone),console.log(i.position,i.quaternion)),i},setup:function(){if(!this.glObject){var e,t;switch(this.type){case"collada":if(!this.geometry)return this.loaded=!1,void m.colladaLoader.load(this.src,this.finishLoadingCollada);if(this.geometry.waitingObject){var i=this;this.waitingObject=this.geometry.waitingObject,this.waitingObject.loaded?e=this.waitingObject.geometries[this.geometry.name]:(this.listenTo(this.waitingObject,"loaded",function(){i.glObject.geometry=i.waitingObject.geometries[i.geometry.name],i.stopListening()}),e=m.TEMP_GEOMETRY)}else e=this.geometry;break;case"icosahedron":e=new THREE.IcosahedronGeometry(this.shapeRadius||1,this.shapeSubdivisions||0);break;case"box":e=new THREE.BoxGeometry(this.shapeDimensions[0],this.shapeDimensions[1],this.shapeDimensions[2]);break;case"plane":e=new THREE.PlaneGeomtry(this.shapeDimensions[0],this.shapeDimensions[1]);break;case"triangle":e=new THREE.Geometry,e.vertices=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],e.faces=[new THREE.Face3(0,1,2)];break;case"pyramid":e=m.makePyramidGeometry(this.shapeDimensions[0]||1,this.shapeDimensions[1]||3,this.shapeDimensions[2]||1);break;default:e=this.geometry||new THREE.Geometry}t=this.materialSpecular?new THREE.MeshPhongMaterial({color:this.materialColor||16777215,specular:this.materialSpecular||5592388,shininess:this.materialShininess||5}):this.materialColor?new THREE.MeshLambertMaterial({color:this.materialColor||16777215}):this.material||m.DefaultMaterial,void 0!=this.materialOpacity&&(t.opacity=this.materialOpacity,t.transparent=!0),this.glObject=new THREE.Mesh(e,t)}},duplicate:function(){var e=new m.Object3D({type:"none",geometry:this.glObject.geometry,material:this.glObject.material});e.type=this.type;for(var t in this.glObject.children){var i=this.glObject.children[t],a=new THREE.Mesh(i.geometry,i.material);a.scale.copy(i.scale),a.quaternion.copy(i.quaternion),a.position.copy(i.position),e.glObject.add(a)}return e.setScale(this.scale||1),e},facePlaneIntersectRay:function(e,t,i){var a=this.glObject.geometry.faces[e],s=this.glObject.geometry.vertices,r=new THREE.Ray;r.direction.set(t[0],t[1],t[2]),r.origin.set(i[0],i[1],i[2]),void 0!=a.a2?h.setFromCoplanarPoints(s[a.a2],s[a.b2],s[a.c2]):h.setFromCoplanarPoints(s[a.a],s[a.b],s[a.c]);var n=r.intersectPlane(h,!1,null);return n?m.V3toArray(n):t},faceIntersectsRay:function(e,t,i){var a=this.glObject.geometry.faces[e],s=this.glObject.geometry.vertices;c.direction.set(t[0],t[1],t[2]),c.origin.set(i[0],i[1],i[2]);var n;return n=void 0!=a.a2?c.intersectTriangle(s[a.a2],s[a.b2],s[a.c2],!1,r):c.intersectTriangle(s[a.a],s[a.b],s[a.c],!1,r),null!=n?!0:void 0},destroy:function(){this.stopListening(),this.glObject&&(this.glObject.geometry&&!this.glObject.geometry.sharedAsset&&this.glObject.geometry.dispose(),this.glObject.material&&!this.glObject.material.sharedAsset&&(this.glObject instanceof THREE.ShaderMaterial||this.glObject.material.dispose()))},mergeInGeometry:function(e,t){this.glObject.geometry.merge(e,t||m.IDENTITY,0),this.glObject.geometry.verticesNeedUpdate=!0}}),m.GeometryLoader=m.Object3D.extend({type:"collada",finishLoadingCollada:function(e){this.geometries={};for(var t=e.scene.children,i=0;i<t.length;i++)t[i].geometry&&(this.geoRotate&&m.transformGeometry({geometry:t[i].geometry,euler:this.geoRotate}),t[i].geometry.sharedAsset=!0,this.geometries[t[i].name]=t[i].geometry);this.trigger("loaded"),this.loaded=!0},getGeometry:function(e){return{name:e,waitingObject:this}}}),m.getRenderer=function(){return m.WEBGL?new THREE.WebGLRenderer({antialias:!1}):void 0},m.HumanoidParts=["head","body","rightUpperLeg","rightLowerLeg","rightUpperArm","rightLowerArm","leftUpperLeg","leftLowerLeg","leftUpperArm","leftLowerArm"],m.Humanoid=m.Group.extend({resetBodyPoints:function(){this.bodyPoints={leftFoot:[-this.hipWidth,0,0],rightFoot:[this.hipWidth,0,0],leftHip:[-this.hipWidth,0,this.legLength],rightHip:[this.hipWidth,0,this.legLength],leftKnee:[-this.hipWidth,0,.5*this.legLength],rightKnee:[this.hipWidth,0,.5*this.legLength],leftShoulder:[-this.shoulderWidth,0,this.legLength+this.torsoLength],rightShoulder:[this.shoulderWidth,0,this.legLength+this.torsoLength],leftHand:[-this.shoulderWidth,0,this.legLength+this.torsoLength-this.armLength],rightHand:[this.shoulderWidth,0,this.legLength+this.torsoLength-this.armLength],leftElbow:[-this.shoulderWidth,0,this.legLength+this.torsoLength-.5*this.armLength],rightElbow:[this.shoulderWidth,0,this.legLength+this.torsoLength-.5*this.armLength],head:[0,0,this.legLength+this.torsoLength+this.neckLength],butt:[0,0,this.legLength]}},setup:function(){return this.glObject=new THREE.Object3D,this.bodyMeshes={},this.lastWalkT=0,this.src?(this.loaded=!1,void m.colladaLoader.load(this.src,this.finishLoadingCollada)):(this.loaded=!0,this.computeProportions(),this.resetBodyPoints(),void this.incrementLoaded())},setSpeechAnimation:function(){var e=this.legLength+this.torsoLength*Math.randomReal(.5,1.3),t=this.shoulderWidth*Math.randomReal(.5,1.4),i=this.armLength*Math.randomReal(.4,.85);this.rightHandSpeechTarget=[t,i,e],e=this.legLength+this.torsoLength*Math.randomReal(.5,1.3),t=-this.shoulderWidth*Math.randomReal(.5,1.5),i=this.armLength*Math.randomReal(.4,.85),this.leftHandSpeechTarget=[t,i,e]},updateSpeechAnimation:function(e){var t=TW.scheduler.clock-this.speechStartTime,i=this.bodyPoints.leftHand,a=this.bodyPoints.rightHand;if(this.leftHandSpeechTarget&&Vec.distance(i,this.leftHandSpeechTarget)>0){var s=Vec.scale(Vec.sub(this.leftHandSpeechTarget,i),1*e);this.placeBodyPoint("leftHand",Vec.add(i,s))}if(this.rightHandSpeechTarget&&Vec.distance(a,this.rightHandSpeechTarget)>0){var s=Vec.scale(Vec.sub(this.rightHandSpeechTarget,a),1*e);this.placeBodyPoint("rightHand",Vec.add(a,s))}this.headIncline=Math.sin(10*t)},duplicate:function(){var e=this,t=new TW.Humanoid({computeProportions:this.computeProportions,loadMeshes:function(){},createBodyMeshes:function(){},bodyScale:this.bodyScale});t.loaded=-1,t.unloaded=0;for(var i in m.HumanoidParts){var a=m.HumanoidParts[i];t.bodyMeshes[a]=e.bodyMeshes[a].duplicate()}return t.incrementLoaded(),t=_.extend(t,this.originalDefinition)},holdEntity:function(e){this.add(e),this.heldEntity=e},computeProportions:function(){this.height=.36,this.shoulderWidth=this.height*(16/68)*.5,this.hipWidth=this.height*(16/68)*.3,this.legLength=this.height*(35/68),this.armLength=this.height*(23/68),this.limbRadius=.022*this.height,this.torsoLength=this.height*(22/68),this.neckLength=this.height*(6.5/68),this.kneeDirection=1},stareAtPoint:function(e){if(e=this.getLocalPosition(e),this.bodyMeshes.head){var t=Vec.normalize(Vec.sub(e,this.bodyPoints.head));if(Vec.dot(this.forwardDir,t)>.2){var i=Vec.add([0,0,1],Vec.scale(t,.1*this.headIncline)),a=this.bodyMeshes.head.glObject.quaternion.clone();this.bodyMeshes.head.lookAt(i,t),a.slerp(this.bodyMeshes.head.glObject.quaternion,.1),this.bodyMeshes.head.glObject.quaternion.copy(a)}}},finishLoadingCollada:function(e){for(var t=e.scene.children,i={},a=0;a<t.length;a++){var s=t[a].name;i[s]=t[a].position,this.bodyMeshes[s]=new m.Object3D({glObject:t[a]}),t[a].material=this.material,this.bodyMeshes[s].setChildrenMaterial(this.material),this.bodyMeshes[s].setScale(this.bodyScale||1)}this.noArms&&(i.rightUpperArm={z:.7*(i.head.z-i.body.z)+i.body.z},i.rightLowerArm={z:.5*(i.rightUpperArm.z+i.body.z)});var r,n,o;i.leftUpperArm?(r=i.leftUpperArm.x,n=i.leftUpperArm.z,o=i.leftLowerArm.z):(this.noLeftArm=!0,r=i.rightUpperArm.x,n=i.rightUpperArm.z,o=i.rightLowerArm.z),i.rightUpperArm||(this.noRightArm=!0),this.computeProportions=function(){this.shoulderWidth=this.bodyScale*Math.abs(r-i.body.x),this.hipWidth=this.bodyScale*Math.abs(i.rightUpperLeg.x-i.body.x),this.legLength=this.bodyScale*(i.rightUpperLeg.z-i.rightLowerLeg.z)*2,this.armLength=this.bodyScale*(n-o)*2,this.torsoLength=this.bodyScale*(n-i.body.z),this.neckLength=this.bodyScale*(i.head.z-n),this.kneeDirection=1,this.height=this.legLength+this.torsoLength+this.neckLength},this.computeProportions(),this.resetBodyPoints(),this.incrementLoaded()},getBoundingBox:function(){var e=this.shoulderWidth||this.hipWidth||this.height*(8/70);return new THREE.Box3(new THREE.Vector3(-e,-e,0),new THREE.Vector3(e,e,this.height))},incrementLoaded:function(){this.createBodyMeshes();for(var e in this.bodyMeshes)this.add(this.bodyMeshes[e]);this.updateBody(),this.trigger("loaded"),this.loaded=!0},faceDirection:function(e){var t=this.getPosition();this.setPosition([0,0,0]),this.lookAt([0,1,0],e),this.setPosition(t)},createBodyMeshes:function(){for(var e in m.HumanoidParts){var t=m.HumanoidParts[e];if(!this.bodyMeshes[t]){switch(t){case"leftUpperLeg":if(this.bodyMeshes.rightUpperLeg){this.bodyMeshes.leftUpperLeg=this.bodyMeshes.rightUpperLeg.duplicate();break}case"leftLowerLeg":if(this.bodyMeshes.rightLowerLeg){this.bodyMeshes.leftLowerLeg=this.bodyMeshes.rightLowerLeg.duplicate();break}case"rightUpperLeg":case"rightLowerLeg":this.bodyMeshes[t]=new GAME.GFX.Object3D,this.bodyMeshes[t].glObject.geometry=m.makePrismGeometry(this.limbRadius,4,.5*-this.legLength,1,!0,!0);break;case"leftUpperArm":if(this.noArms||this.noLeftArm)return;this.bodyMeshes.rightUpperArm&&(this.bodyMeshes.leftUpperArm=this.bodyMeshes.rightUpperArm.duplicate());case"leftLowerArm":if(this.noArms||this.noLeftArm)return;if(this.bodyMeshes.rightLowerArm){this.bodyMeshes.leftLowerArm=this.bodyMeshes.rightLowerArm.duplicate();break}case"rightUpperArm":case"rightLowerArm":if(this.noArms||this.noRightArm)return;this.bodyMeshes[t]=new GAME.GFX.Object3D,this.bodyMeshes[t].glObject.geometry=m.makePrismGeometry(this.limbRadius,4,.5*-this.armLength,1,!0,!0);break;case"body":this.bodyMeshes[t]=new GAME.GFX.Object3D,this.bodyMeshes.body.glObject.geometry=m.makePrismGeometry(1.2*this.hipWidth,6,this.torsoLength,1*this.shoulderWidth/this.hipWidth,!0,!0,0,[1,.4]);break;case"head":this.bodyMeshes[t]=new GAME.GFX.Object3D,this.bodyMeshes.head.glObject.geometry=m.makeSphereGeometry(.8*this.neckLength,1,[.7,.7,1])}this.bodyMeshes[t].glObject.material=this.material||m.DefaultMaterial}}},orientPart:function(e,t,i){if(this.bodyMeshes[e]){var a=this.bodyPoints[t],s=this.bodyPoints[i];this.bodyMeshes[e].setPosition(a);var r=Vec.sub(a,s),n=[0,1,0];("rightLowerArm"==e||"leftLowerArm"==e)&&(n=[0,1,1]),this.armsUp>.5&&(("rightLowerArm"==e||"leftLowerArm"==e)&&(n=[0,-1,.5]),("rightUpperArm"==e||"leftUpperArm"==e)&&(n=[0,-1,.5])),this.bodyMeshes[e].lookAt(Vec.add(r,a),n)}},setStanding:function(){this.resetBodyPoints(),this.flagUpdateBody=!0},setArmsOut:function(){this.setStanding()},updateBody:function(){if(this.orientPart("leftUpperLeg","leftHip","leftKnee"),this.orientPart("rightUpperLeg","rightHip","rightKnee"),this.orientPart("rightLowerLeg","rightKnee","rightFoot"),this.orientPart("leftLowerLeg","leftKnee","leftFoot"),this.orientPart("leftUpperArm","leftShoulder","leftElbow"),this.orientPart("rightUpperArm","rightShoulder","rightElbow"),this.orientPart("leftLowerArm","leftElbow","leftHand"),this.orientPart("rightLowerArm","rightElbow","rightHand"),this.heldEntity){this.heldEntity.setPosition(this.bodyPoints.rightHand);var e=Vec.sub(this.bodyPoints.rightHand,this.bodyPoints.rightElbow);this.heldEntity.lookAt(Vec.normalize(e),[0,0,1])}this.bodyMeshes.body.setPosition(this.bodyPoints.butt),this.bodyMeshes.head.setPosition(this.bodyPoints.head)},setAxeCycle:function(e){.6>e?e=Math.min(1,2*e):(e-=.6,e*=2.5,e=1-e);var t=[this.shoulderWidth+.9*this.armLength,.2*-this.armLength,this.bodyPoints.butt[2]+1.2*this.torsoLength],i=[this.shoulderWidth+.7*this.armLength,.7*this.armLength,this.bodyPoints.butt[2]+1*this.torsoLength],a=[this.shoulderWidth,.9*this.armLength,this.bodyPoints.butt[2]+.8*this.torsoLength];this.placeBodyPoint("rightHand",Vec.bezier([t,i,a],e),Vec.bezier([[0,1,0],[-1,0,0]],e))},update:function(e){if(this.loaded){if(this.flagUpdateBody&&(this.flagUpdateBody=!1,this.updateBody()),this.jumpStart&&this.jumpT)return this.placeBodyPoint("leftFoot",[-this.hipWidth,0,0]),void this.placeBodyPoint("rightFoot",[this.hipWidth,0,0]);if(this.squat>0&&(this.placeBodyPoint("leftFoot",[-this.hipWidth,0,this.legLength*this.squat]),this.placeBodyPoint("rightFoot",[this.hipWidth,0,this.legLength*this.squat])),this.speed>1e-4){this.walkRate=this.walkRate||1;var t=1/(this.speed*this.walkRate)*.1;this.setWalkCycle(this.lastWalkT+e/t%1);var i=t;this.timeToLastStepSound>i?(this.timeToLastStepSound=0,this.playSound("step2"),this.stepIndex=(this.stepIndex+1)%4):this.timeToLastStepSound=(this.timeToLastStepSound||0)+e}this.armsUp&&(this.placeBodyPoint("leftHand",[1.5*-this.shoulderWidth,.5*this.shoulderWidth,1.25*this.height*this.armsUp]),this.placeBodyPoint("rightHand",[1.5*this.shoulderWidth,.5*this.shoulderWidth,1.25*this.height*this.armsUp]))}},playSound:function(){},setWalkCycle:function(e){this.lastWalkT=e;var t=1-.5*(.5-this.speed);t*=this.walkIntensity||1;var i=.25*this.legLength*t*2,a=.1*this.legLength*t*2,s=.05,r=e*Math.PI*2,n=this.legLength*(1+Math.cos(2*r+Math.PI)*t*s);this.placeBodyPoint("butt",[0,0,n]),this.placeBodyPoint("head",[0,0,n+this.torsoLength+this.neckLength]);var o=Math.sin(r)*i,l=Math.sin(r+Math.PI)*i;this.kneeDirection>0?(0>o&&(o*=1.5),0>l&&(l*=1.5)):(o>0&&(o*=1.5),l>0&&(l*=1.5));var h=this.legTurnOut||0;this.placeBodyPoint("leftFoot",[-this.hipWidth,o,n-this.legLength+(Math.cos(r)+1)*a],[-1,-h,0]),this.placeBodyPoint("rightFoot",[this.hipWidth,l,n-this.legLength+(Math.cos(r+Math.PI)+1)*a],[-1,h,0]),h=this.armTurnOut||0;var c=this.handDistance||1;if(!this.armsUp){i=.25*this.armLength*t*2,a=.5*this.armLength*t*1.5;var u=this.legLength+this.torsoLength-this.armLength,d=Math.sin(r+Math.PI)*i,m=Math.sin(r)*i,p=1,f=1;0>d&&(p*=.5),d>0&&(d*=1.5),0>m&&(f*=.5),m>0&&(m*=1.5),this.placeBodyPoint("leftHand",[-this.shoulderWidth*c,d,u+(1-Math.abs(Math.cos(r+Math.PI)))*a*p],[-1,h,0]),this.placeBodyPoint("rightHand",[this.shoulderWidth*c,m,u+(1-Math.abs(Math.cos(r)))*a*f],[-1,-h,0])}},pointPlaceHelper:function(e,t,i,a,s,r){var n=this.bodyPoints[i],o=Vec.sub(e,n),l=Vec.length(o);if(Vec.length(o)>s){var h=Vec.add(Vec.setLength(o,s),n);this.bodyPoints[t]=h}else Vec.copyInto(this.bodyPoints[t],e);var c=this.bodyPoints[t];o=Vec.sub(c,n),l=Vec.length(o);var u=Vec.add(n,Vec.scale(o,.5)),d=Vec.setLength(Vec.perpendicular(o,this.pointPlacePerp),r*Math.sqrt(s*s/4-l*l/4)||0);this.bodyPoints[a]=Vec.add(u,d)},placeBodyPoint:function(e,t,i,a){if(this.flagUpdateBody=!0,a){var s=TW.state.get("planet").getWorldPosition(t);t=this.getLocalPosition(s)}switch(t[2]<0&&(t[2]=0),this.pointPlacePerp=i||[-1,0,0],e){case"head":Vec.copyInto(this.bodyPoints.head,t),this.bodyPoints.leftShoulder=Vec.add([-this.shoulderWidth,0,-this.neckLength],this.bodyPoints.head),this.bodyPoints.rightShoulder=Vec.add([this.shoulderWidth,0,-this.neckLength],this.bodyPoints.head),
this.placeBodyPoint("rightHand",this.bodyPoints.rightHand),this.placeBodyPoint("leftHand",this.bodyPoints.leftHand);break;case"butt":Vec.copyInto(this.bodyPoints.butt,t),this.bodyPoints.leftHip=Vec.add([-this.hipWidth,0,0],this.bodyPoints.butt),this.bodyPoints.rightHip=Vec.add([this.hipWidth,0,0],this.bodyPoints.butt);break;case"leftFoot":this.pointPlaceHelper(t,"leftFoot","leftHip","leftKnee",this.legLength,this.kneeDirection);break;case"rightFoot":this.pointPlaceHelper(t,"rightFoot","rightHip","rightKnee",this.legLength,this.kneeDirection);break;case"rightHand":this.pointPlaceHelper(t,"rightHand","rightShoulder","rightElbow",this.armLength,-1);break;case"leftHand":this.pointPlaceHelper(t,"leftHand","leftShoulder","leftElbow",this.armLength,-1);break;default:Vec.copyInto(this.bodyPoints[e],t)}}}),m.Scene3D=GAME.Views.View.extend({setup:function(){this._scene=new THREE.Scene,this._renderer=m.getRenderer(),this._renderer.sortObjects=!1,this.width=this.$el.width(),this.height=this.$el.height(),this._camera=new THREE.PerspectiveCamera(60,this.width/this.height,.001,2e3),this._camera.position.set(0,0,5),this._camera.lookAt(new THREE.Vector3(0,0,0)),this._ambient=new THREE.AmbientLight(16777215),this._ambient.intensity=1,this._scene.add(this._camera),this._cameraLight=new THREE.SpotLight(10066329,1,0,Math.PI/3,50),this._cameraLight.position.set(0,0,0),this._cameraLight.target.position.set(0,0,0),this._scene.add(this._ambient),this.children=[],this.backgroundColor?this.setBackgroundColor(this.backgroundColor):this._renderer.setClearColor(a,1),this._renderer.setSize(this.width,this.height),this._renderer.shadowMap.enabled=t,this.$el.append(this._renderer.domElement),this._renderer.domElement.className="viewport",this._rayCaster=new THREE.Raycaster,this.zoom=1;var e=1/60;this.elapsedTimes=[e,e,e,e,e,e,e,e,e],i&&this.showStats()},setBackgroundColor:function(e){var t=new THREE.Color;_.isNumber(e)?t.setHEX(e):t.setColor(e),this._renderer.setClearColor(t,1),this.backgroundColor=t.getHex()},pause:function(){this.paused=!0,cancelAnimationFrame(this.frameRequest)},unpause:function(){(this.paused||void 0==this.paused)&&(this.paused=!1,this.startAnimating())},setCamera:function(e,t,i){this._camera.position.set(e[0],e[1],e[2]),this._camera.up.set(i[0],i[1],i[2]),this._camera.lookAt(new THREE.Vector3(t[0],t[1],t[2]))},setCanvasScale:function(t){e=t,this.canvasScale=t,this.resize(),this.renderScene()},hide:function(){this.canvasSwap?$(this.$swapCanvas).hide():$(this._renderer.domElement).hide()},show:function(){this.canvasSwap?$(this.$swapCanvas).show():$(this._renderer.domElement).show()},resize:function(){this.width=this.$el.width(),this.height=this.$el.height(),this._renderer.setSize(this.width*e,this.height*e),this._camera.aspect=this.width/this.height,$(this._renderer.domElement).css({width:"100%",height:"100%",position:"fixed",top:0}),!this.canvasSwap&&1>e?($(this._renderer.domElement).hide(),this.canvasSwap=1,this.$swapCanvas=this.$swapCanvas||$("<canvas class='viewport'>"),this.$el.append(this.$swapCanvas),this.$swapCanvas.attr("width",this.width),this.$swapCanvas.attr("height",this.height),this.$swapCanvas.css({position:"absolute",top:0,left:0})):this.canvasSwap&&(e>=1?(this.$swapCanvas.remove(),$(this._renderer.domElement).show(),this.canvasSwap=0):(this.$swapCanvas.attr("width",this.width),this.$swapCanvas.attr("height",this.height))),this._camera.updateProjectionMatrix(),this.renderScene()},togglePause:function(){return this.paused?(this.unpause(),!1):(this.pause(),!0)},startAnimating:function(){this.lastTick=GAME.now(),this.animate()},updateMouseCaster:function(e,t){r.set(e||0,t||0,1),r.unproject(this._camera),this._rayCaster.set(this._camera.position,r.sub(this._camera.position).normalize())},renderScene:function(){if(this._renderer.render(this._scene,this._camera),this.canvasSwap){var e=this.$swapCanvas[0].getContext("2d");e.drawImage(this._renderer.domElement,0,0,this.width,this.height)}},animate:function(){if(!this.paused){var e=GAME.now(),t=.001*(e-this.lastTick);t=Math.clamp(t,1/140,.1),this.lastTick=e,this.elapsedTimes.shift(),this.elapsedTimes.push(t);var i=Math.sum(this.elapsedTimes)/this.elapsedTimes.length;this.stats&&this.stats.begin();for(var a=0,s=this.children.length;s>a;a++)this.children[a]._update(i);_.isFunction(this.updateFn)&&this.updateFn(i),this.renderScene(),this.paused||(this.frameRequest=requestAnimationFrame(this.animate)),this.stats&&this.stats.end()}},add:function(e){e&&(this._scene.add(e.glObject),this.children.push(e))},removeObject3D:function(e){this._scene.remove(e.glObject),this.children=_.reject(this.children,function(t){return t.glObject.id==e.glObject.id})},showStats:function(){this.stats=new Stats,this.stats.setMode(0),this.stats.domElement.style.position="absolute",this.stats.domElement.style.right="0px",this.stats.domElement.style.top="0px",document.body.appendChild(this.stats.domElement)},setFOV:function(e){this._camera.fov=e,this._camera.updateProjectionMatrix()},zoomBy:function(e){this.zoom=Math.clamp(this.zoom+.01*e,.7,2),this._camera.position.z=141.42/this.zoom,this._headLight.position.z=200/this.zoom;var t=Math.asin(141.42*Math.sin(Math.radians(25))/this._camera.position.z);this._camera.fov=Math.degrees(2*t),this._camera.updateProjectionMatrix()}}),m.createCanvasLabel=function(e,t,i){var a=document.createElement("canvas");a.width=t,a.height=i;var s=a.getContext("2d");return s.clearRect(0,0,t,i),s.fillStyle="#ffffcc",s.textAlign="center",s.shadowColor="black",s.shadowOffsetX=0,s.shadowOffsetY=0,s.shadowBlur=10,s.font="bold 20px Trebuchet MS",s.fillText(e,.5*t,.5*i),a.toDataURL("image/png")}}();var Overlay=function(e){var t=99999999,i={name:"sorghum",point_price:0,directory:"avatars",description:"Over decades that seem but a moment in time, lines of scarlet figures shuttled among the sorghum stalks to weave a vast human tapestry.<br> -Mo Yan",video:"1fq3q6OAR3U",difficulty:"easy",item_id:-1,img:"/images/shop/avatars/default.png"},a="&#9733;",s={shop:[{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B00I19QZX8&asins=B00I19QZX8&linkId=3ea5c9c0016e5e0aba0bf896bbe524a0&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B00NW2Q6ZG&asins=B00NW2Q6ZG&linkId=b1d5552fb52eaafb99c32b5521a4b5b9&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B00Q70D7OI&asins=B00Q70D7OI&linkId=89ff4499faa3107ff5eb97f0bd7bec31&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B01G4QW150&asins=B01G4QW150&linkId=730dc237c128dde5c3c18b695e889eba&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B000HDOPYM&asins=B000HDOPYM&linkId=103d03b3edcbe6dbb62d12b078982d39&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B00D3MGYR0&asins=B00D3MGYR0&linkId=bfd314d325a6627383ac85abbc638e9e&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B0167ZBBSG&asins=B0167ZBBSG&linkId=196d2207d0c7a53882fab6df35784812&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B000P1PVMQ&asins=B000P1PVMQ&linkId=e8c9820f4b67af1a5564bca53a558c2c&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B005QBQBXS&asins=B005QBQBXS&linkId=23a97762d4166f294d354f951adc2312&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B01C01PZUQ&asins=B01C01PZUQ&linkId=dfcad50e74013d5b575ef2848d38a180&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'},{code:'<iframe style="width:120px;height:240px;" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" src="//ws-na.amazon-adsystem.com/widgets/q?ServiceVersion=20070822&OneJS=1&Operation=GetAdHtml&MarketPlace=US&source=ac&ref=tf_til&ad_type=product_link&tracking_id=baanfell-20&marketplace=amazon&region=US&placement=B009MP2ALG&asins=B009MP2ALG&linkId=2de547fe2a6dc3d0b602511a10b7c079&show_border=false&link_opens_in_new_window=true&price_color=00bbff&title_color=141414&bg_color=ffffff"></iframe>'}]};e.LevelMenu=GAME.Views.View.extend({setup:function(){var e=this;this.$el.on("click",".level",function(){var t=$(this).attr("index");e.parent.shuffleList=e.select(e.parent.activeSelector),e.parent.shuffleList=_.reject(e.parent.shuffleList,function(e){return e.level_id==t}),e.parent.playLevel(t)}),this.$el.on("click",".selector",function(){e.parent.shuffleList=e.select($(this).attr("tag"))})},hide:function(){this.$el.hide()},render:function(){this.$el.html(GAME.templates["level-menu"]()),this.$el.show(),this.select(this.parent.activeSelector),this.fixCSS()},fixCSS:function(){var e=this.$el.height()-this.$(".selectors").height()-5;this.$(".levels").css("height",e)},select:function(t){var i=e.user.get("levels"),a=e.user.get("levelHistory");this.parent.activeSelector=t;var s=[];switch(this.$(".selector").removeClass("selected"),this.$('.selector[tag="'+t+'"]').addClass("selected"),t){case"easy":case"intermediate":case"advanced":case"insane":for(var r in i)i[r].difficulty==t&&s.push(i[r]);break;case"solved":for(var r in i)a[r].completed>=i[r].puzzles.length&&s.push(i[r]);break;case"unsolved":for(var r in i)(!a[r]||a[r].completed<i[r].puzzles.length)&&s.push(i[r]);break;case"all":s=_.values(i)}return s.sort(function(e,t){return e.name.localeCompare(t.name)}),this.$(".levels").html(GAME.templates.levels({levels:s})),e.EDITOR||_.size(i)>=e.menu.gameInfo.numLevels&&this.$(".button.shop").hide(),s}}),e.ShoppingCart=GAME.Models.Model.extend({items:[],addItem:function(e){if(!this.hasItem(e)){if(this.items.push(e),"999"==e.item_id){this.hasLevelPass=!0;for(var t=0;t<this.items.length;t++)this.items[t].contents&&this.items[t].contents.level_ids&&(this.items.splice(t,1),t-=1)}this.updateOverlay()}},updateOverlay:function(){this.isEmpty()?($("#line-cart").hide(),$(".gimbles .back").show()):($("#cart-count").html(this.items.length),$("#line-cart").show(),$(".gimbles .back").hide())},hasItem:function(e){if(e.contents&&e.contents.level_ids&&this.hasLevelPass)return!0;for(var t=0;t<this.items.length;t++)if(this.items[t].item_id==e.item_id)return!0;return!1},isEmpty:function(){return 0==this.items.length},getFee:function(){var e=this.getItemCost();return 100>e?30:0},checkPurchases:function(){for(var t=e.user.get("purchases"),i=0;i<this.items.length;i++)t[this.items[i].item_id]&&(this.items.splice(i,1),i-=1);this.updateOverlay()},removeItemID:function(e){this.items=_.reject(this.items,function(t){return t.item_id==e}),"999"==e&&(this.hasLevelPass=!1),this.updateOverlay()},getTotalCost:function(){return this.getItemCost()+this.getFee()},getItemCost:function(){for(var e=0,t=0;t<this.items.length;t++)e+=this.items[t].cash_price;return e},packageData:function(){return{items:this.items,totalPrice:this.getTotalCost(),fee:this.getFee()}}}),e.Overlay=GAME.Views.View.extend({clientVersion:e.CLIENT_VERSION,setup:function(){var i=this;this.activeSelector="all",this.clientVersion=e.CLIENT_VERSION,this.multiplier=1,this.shoppingCart=new e.ShoppingCart,Handlebars.registerPartial("game-settings",function(){return GAME.templates["settings-list"]()}()),Handlebars.registerHelper("time-left",function(e){return e&&e.expires?"("+GAME.Format.timeFromMS(Math.max(0,e.expires-GAME.now()),0)+")":void 0}),Handlebars.registerHelper("level-stats",function(i){var a=e.user.get("levelHistory")[i.level_id];a||(a={completed:0,retry_record:t,time_record:t,turn_record:t});var s=a.retry_record;s>=t?s="--":0==s&&(s="PERFECT");var r=a.time_record;r=r>=t?"-:-":GAME.Format.timeFromMS(r);var n=a.turn_record;n>=t&&(n="--");var o={completed:a.completed+"/"+i.puzzles.length,retry_record:s,time_record:r,turn_record:n};return GAME.templates["level-stats"](o)}),Handlebars.registerHelper("ifPurchased",function(t,i){var a=e.user.get("purchases");if("avatars"!=t.directory){if(a[t.item_id]||a[999]){if("999"==t.item_id)return"";var s=t.contents.level_ids[0];return i.fn({level_id:s})}return i.inverse(t)}if("avatars"==t.directory&&(a[t.item_id]||t.item_id<0)){if(e.gamePlayer.flagUpdateAvatar){if(t.name==e.gamePlayer.flagUpdateAvatar.name)return'<div class="button">up next</div>'}else if(t.name==e.user.get("activeAvatar").name)return"";return i.fn(t)}return i.inverse(t)}),Handlebars.registerHelper("solved",function(t,i){var a=e.user.get("levelHistory");return a[t.level_id]&&a[t.level_id].completed>=t.puzzles.length?0==a[t.level_id].retry_record?"&#9733;&#9733;":"&#9733;":""}),Handlebars.registerHelper("decimal",function(e){return e.toFixed(2)}),Handlebars.registerHelper("cashPurchase",function(e,t){return i.shoppingCart.hasItem(e)?t.inverse(e):e.cash_price?t.fn(e):""}),Handlebars.registerHelper("cash",function(e,t){var i=Number(e)/100;return"$"+i.toFixed(2)}),this.shuffleList=_.values(e.user.get("levels")),this.factors={winloss:{reason:"win - loss",factor:1}},this.draw(),this.$el.on("click",".button.menu-return",function(){e.menu.reloadMenu()}),$("#view").on("click","#settings .option",function(){var e=$(this).parent().attr("name");i.modifySetting(e,$(this).text()),i.saveSettings(),$(this).parent().find(".option").removeClass("selected"),$(this).addClass("selected")}),this.$el.on("click",".cart-checkout",function(){i.showCheckoutView()}),this.$el.on("click",".button.badges",function(){e.menu.showBadges()}),this.$el.on("click",".level-entry .preview",function(){e.menu.displayAlert({type:"LEVEL_OVERVIEW",level:e.user.get("levels")[$(this).attr("index")]})}),this.shopReminderShown=0,this.showShopReminder=0,e.user.onChange("points",function(t){var a=Number(i.$("#gimbles").text());i.pointAnim.setElement(i.$("#gimbles")),i.pointAnim.animateNumber(a,t,2e3);var s=e.user.get("user_id");0>s&&GAME.storage.setItem("points_"+s,t)}),e.state.onChange("currentPuzzle",function(e){i.updateLevelDisplay(e)}),this.$el.on("click",".button.shuffle",function(){i.shuffle()}),this.$el.on("click",".button.restart",function(){e.gamePlayer.restartLevel()}),this.$el.on("click",".button.shop",function(){i.togglePauseMenu(!0),i.loadShop()}),this.$el.on("click",".pause-button",function(){i.togglePauseMenu()}),this.$el.on("click","#settings.condensed .header",function(){$(".box.settings").length||e.menu.displayAlert({type:"SETTINGS"})}),this.$el.on("click",".leveldisplay",function(){i.togglePauseMenu()}),this.$el.on("click",".use-avatar",function(){var t=($(this).attr("item_id"),$(this).attr("name")),a=e.user.get("avatars");a[t]&&(e.gamePlayer.queueNextAvatar(a[t]),i.saveSettings()),i.drawShopItems()}),this.rewardTextAnim=new GAME.HTMLAnim.TypeAnimator({el:this.$rewardText}),this.pointAnim=new GAME.HTMLAnim.NumberScroller({el:this.$("#gimbles")}),this.multiplierAnim=new GAME.HTMLAnim.NumberScroller({el:$("#multiplier .display .number"),places:2}),this.$el.on("click",".play-level",function(){i.leaveShop()&&i.playLevel(Number($(this).attr("level_id")))}),this.$el.on("click",".purchase-points",function(){i.clickPointPurchase($(this))}),this.$el.on("click",".purchase-cash",function(){i.clickCashPurchase($(this))}),this.$el.on("click",".button.back",function(){history?i.historyBack():i.leaveShop()}),this.$el.on("click",".shop-section.levels .selectors .button",function(){i.levelItemsTag=$(this).attr("tag"),$(".shop-section.levels .selectors .button").removeClass("selected"),$(this).addClass("selected"),i.drawShopItems(),$(".levels .shop-list").scrollLeft(0)}),this.$el.on("click",".shop-section.avatars .selectors .button",function(){i.avatarItemsTag=$(this).attr("tag"),$(".shop-section.avatars .selectors .button").removeClass("selected"),$(this).addClass("selected"),i.drawShopItems(),$(".avatars .shop-list").scrollLeft(0)}),$("#view").on("click",".read-manual",function(){e.menu.displayAlert({type:"MANUAL"})}),$("#view").on("click",".contact-us",function(){var t=e.menu.displayAlert({type:"CONTACT"}),a=0;t.on("click",".submit",function(){if(!a){a=1,t.find(".submit").html("One Moment"),t.find(".ok").hide();var e=function(e){t.find(".form").remove(),t.find(".submit").remove(),t.find(".ok").html("ok"),t.find(".ok").show(),e.success?t.find(".info").html("Thank you. We have received your message."):t.find(".info").html("Sorry. There was an error processing your message")};i.postAPI("/api/contact_us",{email:t.find(".email").val(),subject:t.find(".subject").val(),message:t.find(".message").val()},e)}})}),this.avatarItemsTag="all",this.levelItemsTag="all",this.updateSettings(this.settings)},considerShopPrompt:function(){var t=e.user.get("purchases");if(_.isEmpty(t)&&!e.SHOP_REMINDER_SHOWN&&!GAME.SYSTEM.MOBILE)try{var i=0,a=e.user.get("levelHistory"),s=e.user.get("levels");for(var r in a){var n=a[r].completed;"core"==s[r].directory&&n>=s[r].puzzles.length&&i++}i>=3&&(e.menu.displayAlert({type:"TUTORIAL",number:0}),e.SHOP_REMINDER_SHOWN=!0)}catch(o){console.log(o)}},clickPointPurchase:function(t){if(!t.hasClass("disabled")){if(!e.menu.signedIn)return void e.menu.showLoginMenu();t.hasClass("button")?t.html("processing..."):(t.find(".pointpurchase").html("processing..."),t.find(".pointprice").hide()),t.addClass("disabled");var i=t.attr("item_id");this.handlePurchaseWithPoints(i)}},clickCashPurchase:function(t){if(!e.menu.signedIn)return void e.menu.showLoginMenu();var i=t.attr("item_id");if(i){t.hasClass("button")&&t.html("in cart!"),t.addClass("disabled");var a=this;t.click(function(){a.removeItemDescription(),a.showCheckoutView()});var s=this.shopItemsByID[i];s&&s.cash_price&&(this.shoppingCart.addItem(s),this.drawShopItems())}},setupBraintree:function(t){var i=this;braintree.setup(this.braintreeClientToken,"dropin",{container:"braintree-area",onPaymentMethodReceived:t,onReady:function(t){$("#checkout-layer .submit").show(),e.menu.resizeBoxes(),i.braintreeReadyObj=t},onError:function(e){console.log("bt error",e)}}),this.braintreeSetup=!0},refreshCheckoutView:function(){if(this.shoppingCart.isEmpty())return void this.removeCheckoutView();$(".cart-review-boxes").html(GAME.templates["checkout-review"](this.shoppingCart.packageData()));var e=this.shoppingCart.getTotalCost()/100;$(".checkout-form .submit").val("Pay $"+e.toFixed(2));var t=this;$("#checkout-layer .remove").click(function(){var e=$(this).attr("item_id");t.shoppingCart.removeItemID(e),t.refreshCheckoutView(),t.drawShopItems()})},stopAdBonus:function(){clearInterval(this.adBonusInterval),this.adBonusStart=void 0},adBonusTick:function(){if(this.adBonusStart){var e=GAME.now()-this.adBonusStart,t=15e3;e>=t?(this.stopAdBonus(),this.setFactor("ad_bonus",{type:"add",factor:.5,reason:"watched ad",expires:GAME.now()+9e5}),$(".ad-bonus-counter").html("received!")):$(".ad-bonus-counter").html("in "+GAME.Format.timeFromMS(Math.max(t-e,0),0))}},startAdBonus:function(){this.adBonusStart=GAME.now(),this.adBonusInterval=setInterval(this.adBonusTick,1e3)},ytVideoReady:function(){},ytVideoStateChange:function(e){e.data==YT.PlayerState.PLAYING&&this.startAdBonus()},adBonusOnPlay:function(){this.ytPlayer=new YT.Player("yt-player",{events:{onReady:this.ytVideoReady,onStateChange:this.ytVideoStateChange}})},loadYoutubeAPI:function(){window.YT?this.adBonusOnPlay():(window.onYouTubeIframeAPIReady=this.adBonusOnPlay,$.getScript("https://www.youtube.com/iframe_api"))},showItemDescription:function(t){$("#checkout-layer").html(GAME.templates["item-description"](t)),e.audioManager.setSequenceVolume(.1),t.video&&this.loadYoutubeAPI(),$(".fade").show(),this.showingItem=t,$("#checkout-layer .back").click(this.removeItemDescription),e.menu.resizeBoxes();var i=this;if($(window).width()<$(".description").width()&&($(".box.description").css({width:"32em",marginLeft:"-17em"}),$(".box.description .text").css({marginLeft:"1em"})),$(".description .pointpurchase").click(function(){i.clickPointPurchase($(this))}),$(".description .cashpurchase").click(function(){i.clickCashPurchase($(this))}),"999"==t.item_id){var a=0,s=e.user.get("purchases");if(s[t.item_id])return void $(".box.description .description").append($("<br><span> Thank you for playing and supporting roTópo.</span>"));for(var r in s){var t=this.shopItemsByID[r];t.contents&&t.contents.level_ids&&(a+=t.point_price)}$(".box.description .description").append($("<br><span> You will also be refunded the total cost (<b>+"+a+"</b>) in gimbles of your previoulsy purchased levels.<span>"))}},removeItemDescription:function(){$("#checkout-layer").html(""),$(".fade").hide(),this.showingItem=0,e.audioManager.setSequenceVolume(1)},showCheckoutView:function(){if(!this.showingCheckout){var e=this.shoppingCart.packageData();this.showingCheckout=1,$("#checkout-layer").html(GAME.templates["checkout-box"](e)),$(".checkout-area").prepend($(GAME.templates["checkout-review"](e)));var t=this;$("#checkout-layer .remove").click(function(){var e=$(this).attr("item_id");t.shoppingCart.removeItemID(e),t.refreshCheckoutView(),t.drawShopItems()}),$(".fade").show(),this.setupBraintreeForm(),$("#checkout-layer .back").click(this.removeCheckoutView),$(window).width()<$(".checkout-area").width()&&($(".box.cart-checkout").css({position:"relative",left:0,top:"2em"}),$(".box.cart-review").css({width:"25em","max-height":"25em"}),$(".box.cart-review .item-list").css({"max-height":"15em"}),$(".checkout-area").css({"margin-left":"-14.5em"}))}},removeCheckoutView:function(){var e=this;this.showingCheckout=0,e.braintreeReadyObj?e.braintreeReadyObj.teardown(function(){e.braintreeReadyObj=void 0,$("#checkout-layer").html(""),$(".fade").hide()}):($("#checkout-layer").html(""),$(".fade").hide()),this.stopAdBonus()},alertNoBraintree:function(){e.menu.displayAlert({error:"BRAINTREE_OFFLINE"}),this.getBraintreeTimeout=0},setupBraintreeForm:function(){var e=this;if(!window.braintree&&!this.getBraintreeTimeout)return $.getScript("https://js.braintreegateway.com/v2/braintree.js",this.setupBraintreeForm),void(this.getBraintreeTimeout=setTimeout(this.alertNoBraintree,3e3));clearTimeout(this.getBraintreeTimeout);var t=function(t){e.handlePurchaseWithCash(t)};return this.braintreeClientToken?void e.setupBraintree(t):void this.getAPI("/api/get_braintree_client_token",{},function(i){i.success&&(e.braintreeClientToken=i.token,e.setupBraintree(t))})},updateLevelDisplay:function(t){if(t){var i=e.user.get("levelHistory");this.$(".leveldisplay").html(t.level.name+"//"+t.name+" ("+(t.puzzleIndex+1)+"/"+t.level.puzzles.length+")"),i[t.level.level_id]&&i[t.level.level_id].completed>t.puzzleIndex&&this.$(".leveldisplay").append($("<span>&#9733;</span>"))}},updateSettings:function(e){for(var t in e)this.modifySetting(t,e[t])},modifySetting:function(t,i){"antialiasing"==t&&("low"==i?e.gamePlayer.scene.setCanvasScale(1):"med"==i?e.gamePlayer.scene.setCanvasScale(1.25):"hi"==i?e.gamePlayer.scene.setCanvasScale(1.5):"retro"==i&&e.gamePlayer.scene.setCanvasScale(.5)),"music"==t&&("on"==i?e.audioManager.enableSounds():e.audioManager.disableSounds()),"fullscreen"==t&&("on"==i?e.gamePlayer.goFullScreen():"off"==i&&e.gamePlayer.exitFullScreen()),this.settings[t]=i},deleteFactor:function(e){delete this.factors[e],this.updateMultiplier()},setFactor:function(e,t){this.factors[e]=t,this.updateMultiplier()},handlePurchaseWithPoints:function(e){!e||this.awaitingPurchaseConfirmation||(this.awaitingPurchaseConfirmation=e,this.postAPI("/api/purchase_items",{item_ids:[e],method:"POINTS"},this.confirmPurchase))},handlePurchaseWithCash:function(e){if(!this.purchaseUnderway){var t=this.shoppingCart.items,i=this;t.length&&($("#checkout-layer .submit").hide(),$("#checkout-layer .back").hide(),$("#checkout-layer .cart-checkout .header").html("Processing..."),this.purchaseUnderway=!0,i.postAPI("/api/purchase_items",{item_ids:_.pluck(t,"item_id"),method:"CASH",data:e,amount_payed:this.shoppingCart.getTotalCost()},function(e){i.purchaseUnderway=!1,i.confirmPurchase(e),$("#checkout-layer .back").show(),e.success?($("#checkout-layer .cart-checkout .header").html("SUCCESS!"),$("#checkout-layer .back").html("ok"),i.braintreeClientToken=void 0,i.braintreeReadyObj.teardown(function(){i.braintreeReadyObj=void 0})):($("#checkout-layer .cart-checkout .header").html("PAY"),$("#checkout-layer .submit").show())}))}},confirmPurchase:function(t){t.success?(e.audioManager.playSound("thank_you"),this.awaitingPurchaseConfirmation&&(this.recentlyPurchased[this.awaitingPurchaseConfirmation]=1),t.content&&(e.menu.initUserData(t.content,!0),this.remakeShuffleList(),this.drawShopItems(),this.shoppingCart.checkPurchases())):(e.menu.displayAlert(t),this.drawShopItems()),this.awaitingPurchaseConfirmation=void 0,this.showingItem&&this.showItemDescription(this.showingItem)},leaveShop:function(){return this.purchaseUnderway?!1:(this.stopShopMusic(),this.removeCheckoutView(),this.removeItemDescription(),this.inShop=!1,this.draw(),e.gamePlayer.show(),e.gamePlayer.removingPuzzle&&e.gamePlayer.removingPuzzle.show(),e.gamePlayer.activePuzzle&&(e.gamePlayer.activePuzzle.show(),e.gamePlayer.scene.renderScene()),e.gamePlayer.effectsGroup&&e.gamePlayer.effectsGroup.setVisibility(!0),e.state.popFocus(),this.pauseMenuOpen=!1,this.togglePauseMenu(!0),!0)},playLevel:function(t){var i=e.user.get("levels");e.gamePlayer.playLevel(i[t]),this.togglePauseMenu(!1)},updateFactorList:function(){$("#multiplier .factor-list").html(GAME.templates["factor-list"]({factors:this.factors}))},togglePauseMenu:function(t){if(void 0==t||!!this.pauseMenuOpen!=!!t){var i=$("#settings"),a=$("#multiplier .factor-list");if(this.pauseMenuOpen)return this.levelMenu&&this.levelMenu.hide(),i.hide(),a.hide(),this.pauseMenuOpen=!1,e.gamePlayer.unpause(),e.state.setFocus("gamePlayer"),this.$(".fade").hide(),this.$(".pause-button").hide(),this.$(".tasks").addClass("condensed"),void clearInterval(this.updateFactorListInterval);this.drawOptions(this.$el),e.state.setFocus("pauseMenu"),$("#overlay").show(),i.show(),a.show(),this.$(".fade").fadeIn(100),this.$(".pause-button").fadeIn(100),this.updateTasks("show"),a.html(GAME.templates["factor-list"]({factors:this.factors})),this.updateFactorListInterval=setInterval(this.updateFactorList,1e3),e.gamePlayer.pause(),this.pauseMenuOpen=!0,this.levelMenu.render(),$(window).width()<350*e.state.get("window").fontSize+$(".line.levels").width()?($("#settings").addClass("condensed"),$(".pause-button").css({top:"18em",fontSize:"0.7em"}),$("#level-menu").css({fontSize:"1em",bottom:"4em"})):(i.removeClass("condensed"),$(".pause-button").css({top:"",fontSize:""}),$("#level-menu").css({fontSize:"",bottom:""}))}},loadShop:function(e){this.loadShopCallback=e,this.getAPI("/api/get_shop_items",{},this.drawShop)},updateTasks:function(i){var a=e.gamePlayer.activeLevelData;if(a){"show"==i&&this.$(".tasks").removeClass("condensed"),this.$(".current.retries").html(a.retries),this.$(".current.time").html(GAME.Format.timeFromMS(a.time)),this.$(".current.turns").html(a.turns);var s=e.user.get("levelHistory"),r="/-:-",n="/-",o="/-";s[a.level_id]&&(r=s[a.level_id].time_record,n=s[a.level_id].retry_record,o=s[a.level_id].turn_record,this.$(".current.time").toggleClass("ahead",a.time<=r),this.$(".current.retries").toggleClass("ahead",a.retries<=n),this.$(".current.turns").toggleClass("ahead",a.turns<=o),r=r>=t?"/-:-":"/"+GAME.Format.timeFromMS(r),this.$(".record-retries").removeClass("bold"),0==n||"finish"==i&&0==a.retries?(n="PERFECT",this.$(".record-retries").addClass("bold"),this.$(".current.retries").html("")):n=n>=t?"/-":"/"+n),o=o>=t?"/-":"/"+o,this.$(".record-retries").html(n),this.$(".record-time").html(r),this.$(".record-turns").html(o)}},markPurchased:function(){var t=e.user.get("purchases"),i=e.user.get("levelHistory");for(var a in t)$('.shop-item[item_id="'+a+'"]').addClass("purchased");t[999]&&($(".shop-item.levels").addClass("purchased"),$('.shop-item[item_id="999"]').removeClass("levelhide")),$('.shop-item[item_id="-1"]').addClass("purchased");for(var s=$(".shop-item.levels.purchased"),r=0;r<s.length;r++){var n=$(s.get(r)),o=Number(n.attr("item_id")),l=this.shopItemsByID[o];if(l&&l.contents&&l.contents.level_ids){var h=l.contents.level_ids[0],c=i[h];c&&c.completed>0&&n.addClass("levelhide")}}},drawShopItems:function(){if(this.inShop){var t=this.shopItems.level_packs,a=this.shopItems.avatars,s=[],r=[];if("all"!=this.levelItemsTag)for(var n in t)t[n].difficulty==this.levelItemsTag&&s.push(t[n]);else s=_.values(t);var o=e.user.get("purchases");if(o[999],s=_.sortBy(s,function(e){return e.point_price||.01*e.cash_price}),"all"!=this.avatarItemsTag)for(var l in a){var h=o[a[l].item_id];(!a[l].hidden||h)&&(h?"purchased"==this.avatarItemsTag&&r.push(a[l]):"locked"==this.avatarItemsTag&&r.push(a[l]));
}else for(var l in a){var h=o[a[l].item_id];(!a[l].hidden||h)&&r.push(a[l])}"locked"!=this.avatarItemsTag&&r.push(i),r=_.sortBy(r,function(e){return void 0!=e.point_price?e.point_price:e.cash_price}),this.$(".levels .shop-list").html(GAME.templates["level-items"]({level_packs:s})),this.$(".avatars .shop-list").html(GAME.templates["avatar-items"]({avatars:r})),this.markPurchased(),$('.shop-section.levels .selectors .button[tag^="'+this.levelItemsTag+'"]').addClass("selected"),$('.shop-section.avatars .selectors .button[tag^="'+this.avatarItemsTag+'"]').addClass("selected");var c=this;$(".preview").click(function(){var e=$(this).closest('div[class^="shop-item"]').attr("item_id"),t=c.shopItemsByID[e];t?c.showItemDescription(t):-1==e&&c.showItemDescription(i)}),$(".shop-item").on("touchend",function(){return $(this).hasClass("active")||$(this).hasClass("dragging")||$(this).hasClass("purchased")?!0:($(".shop-item").removeClass("active"),$(this).addClass("active"),!1)}),$(".shop-item").on("touchstart",function(){$(this).removeClass("dragging"),$(this).addClass("touchscreen")}),$(".shop-item").on("touchmove",function(){$(this).addClass("dragging")}),$(".shop-item").on("mouseover",function(){$(".shop-item").removeClass("active"),$(this).addClass("active")}),$(".shop-item").on("mouseleave",function(){$(this).hasClass("touchscreen")||$(this).removeClass("active")})}},placeShopAds:function(){for(var e=$(".shop-item.levels"),t=0,i=_.shuffle(s.shop),a=0,r=0;r<e.length;r++){var n=$(e[r]);if(!n.hasClass("levelhide")&&(t++,t%8==0)){var o=$("<div class='shop-item-ad'></div>"),l=i[a++%i.length];o.html(l.code),o.insertAfter(n)}}},drawShop:function(t){window.braintree||$.getScript("https://js.braintreegateway.com/v2/braintree.js"),e.audioManager.hasSound("thank_you")||e.audioManager.loadSounds({thank_you:{src:"/assets/sounds/thank_you",volume:33*e.VOLUME}}),this.inShop=!0,t=t.items,this.shopItems=t,this.recentlyPurchased={},this.shopItemsByID={};for(var i in t.avatars)this.shopItemsByID[t.avatars[i].item_id]=t.avatars[i];for(var a in t.level_packs)this.shopItemsByID[t.level_packs[a].item_id]=t.level_packs[a];this.pauseMenuOpen=!1,this.$el.html(GAME.templates["overlay-shop"]()),this.drawShopItems(),this.$("#gimbles").text(e.user.get("points")),$(".shop-list").mousewheel(function(e,t){var i=this.scrollLeft;this.scrollLeft-=80*t,this.scrollLeft!=i&&e.preventDefault()}),e.state.pushFocus("shop"),e.gamePlayer.pause(),e.gamePlayer.activePuzzle&&e.gamePlayer.activePuzzle.hide(),e.gamePlayer.removingPuzzle&&e.gamePlayer.removingPuzzle.hide(),e.gamePlayer.effectsGroup&&e.gamePlayer.effectsGroup.setVisibility(!1),e.gamePlayer.scene.renderScene(),this.shoppingCart.updateOverlay(),this.pushHistory({state:"shop"},"roTopo Shop","/shop"),this.playShopMusic(),this.loadShopCallback&&this.loadShopCallback(),this.resize()},stopShopMusic:function(){e.audioManager.stopSequence()},playShopMusic:function(){e.audioManager.playSequence({info:{duration:36},notes:[{n:56,st:0,et:36},{n:57,st:12,et:96},{n:61,st:96,et:144},{n:57,st:144,et:192},{n:56,st:192,et:216},{n:57,st:216,et:240},{n:56,st:240,et:264},{n:61,st:288,et:336},{n:57,st:432,et:480},{n:59,st:480,et:528},{n:62,st:528,et:576},{n:61,st:576,et:624},{n:57,st:648,et:672},{n:54,st:672,et:768},{n:56,st:768,et:804},{n:57,st:780,et:864},{n:61,st:864,et:912},{n:57,st:912,et:960},{n:56,st:960,et:984},{n:57,st:1008,et:1032},{n:56,st:1032,et:1056},{n:61,st:1056,et:1104},{n:57,st:1200,et:1248},{n:59,st:1248,et:1296},{n:62,st:1296,et:1344},{n:61,st:1344,et:1392},{n:57,st:1392,et:1440},{n:56,st:1440,et:1488},{n:59,st:1488,et:1536},{n:56,st:1536,et:1572},{n:57,st:1548,et:1632},{n:61,st:1632,et:1680},{n:57,st:1680,et:1728},{n:56,st:1728,et:1752},{n:57,st:1752,et:1776},{n:56,st:1776,et:1800},{n:61,st:1824,et:1872},{n:57,st:1968,et:2016},{n:59,st:2016,et:2064},{n:62,st:2064,et:2112},{n:61,st:2112,et:2160},{n:57,st:2184,et:2208},{n:54,st:2208,et:2268},{n:52,st:2292,et:2304},{n:54,st:2304,et:2352},{n:49,st:2352,et:2448},{n:52,st:2448,et:2544},{n:54,st:2544,et:2592},{n:49,st:2592,et:2640},{n:47,st:2640,et:2688},{n:45,st:2688,et:3312},{n:50,st:2688,et:3312},{n:57,st:2688,et:2832},{n:59,st:2832,et:2976},{n:61,st:2976,et:3072},{n:62,st:3072,et:3120},{n:64,st:3120,et:3192},{n:64,st:3216,et:3312},{n:62,st:3312,et:3360},{n:64,st:3360,et:3408},{n:66,st:3408,et:3456},{n:59,st:3456,et:3600},{n:64,st:3456,et:3600},{n:57,st:3600,et:3696},{n:62,st:3600,et:3696},{n:61,st:3696,et:3744},{n:62,st:3744,et:3792},{n:64,st:3792,et:3840},{n:56,st:3840,et:3984},{n:62,st:3840,et:3984},{n:57,st:3984,et:4056},{n:61,st:3984,et:4080},{n:57,st:4080,et:4128},{n:59,st:4128,et:4176},{n:56,st:4176,et:4224},{n:50,st:4224,et:4752},{n:57,st:4224,et:4368},{n:59,st:4368,et:4512},{n:61,st:4512,et:4608},{n:62,st:4608,et:4656},{n:64,st:4656,et:4752},{n:61,st:4752,et:4992},{n:54,st:4992,et:5040},{n:49,st:5040,et:5136},{n:52,st:5136,et:5232},{n:54,st:5232,et:5256},{n:52,st:5256,et:5280},{n:49,st:5280,et:5328},{n:59,st:5328,et:5376},{n:57,st:5376,et:5616}]},{volume:7.5*e.VOLUME,loop:1,delay:1.5,rate:1.2})},savePuzzleFailed:function(t){this.factors.winloss.factor=Math.clamp(this.factors.winloss.factor-.05,1,3),this.updateMultiplier();var i=t.level.level_id,a=t.puzzleIndex,s=this,r=e.user.get("user_id");if(GAME.storage.setItem(r+"_levelsave_"+i,JSON.stringify({puzzle_index:a,retries:e.gamePlayer.activeLevelData.retries,time:e.gamePlayer.activeLevelData.time,turns:e.gamePlayer.activeLevelData.turns})),i>0&&e.menu.signedIn){var n={level_id:i,puzzle_index:a,multiplier:this.multiplier,winloss:this.factors.winloss.factor};n.retry_record=e.gamePlayer.activeLevelData.retries,n.time_record=e.gamePlayer.activeLevelData.time,n.turn_record=e.gamePlayer.activeLevelData.turns,this.postAPI("/api/save",{type:"fail",data:n},function(e){return function(t){s.confirmSave(t,e)}}(t))}},savePuzzleCompleted:function(t){var i=r;this.showShopReminder=1;var a=t.reward||0,s=Math.floor(a*this.multiplier),n=t.level.level_id,o=t.puzzleIndex,l=o==t.level.puzzles.length-1;this.factors.winloss.factor=Math.clamp(this.factors.winloss.factor+.2,1,3);var h=e.user.get("levelHistory"),c=e.user.get("user_id");if(o==t.level.puzzles.length-1?GAME.storage.removeItem(c+"_levelsave_"+t.level.level_id):GAME.storage.setItem(c+"_levelsave_"+n,JSON.stringify({puzzle_index:o+1,retries:e.gamePlayer.activeLevelData.retries,time:e.gamePlayer.activeLevelData.time,turns:e.gamePlayer.activeLevelData.turns})),n>0&&e.menu.signedIn){this.savingPuzzle=t;var u={level_id:n,puzzle_index:o,multiplier:this.multiplier,winloss:this.factors.winloss.factor};u.ts=i(t.ts),u.retry_record=e.gamePlayer.activeLevelData.retries,u.time_record=e.gamePlayer.activeLevelData.time,u.turn_record=e.gamePlayer.activeLevelData.turns,this.postAPI("/api/save",{type:"pass",data:u},function(e){return function(t){d.confirmSave(t,e)}}(t))}else t.saveFlag=!0,e.user.increase("points",s);if(!(0>n)){this.$rewardBar=$(".reward-bar"),this.$rewardText=$(".reward-text"),this.$rewardBar.css({maxWidth:0,opacity:"0em",paddingLeft:"0em"}),this.$rewardBar.show();var d=this;this.$rewardBar.html(HTML.tag("+"+s,"b")+HTML.tag("("+a+"&times;"+this.multiplier.toFixed(2)+")","smaller")),this.$rewardText.html(""),this.rewardTextAnim.setElement(this.$rewardText[0]);var m="puzzle completed",p=(e.user.get("levels")[n],e.gamePlayer.activeLevelData),f=h[n];if(l){m="level completed",this.updateTasks("finish");var g=!1,v=!1;if(f.completed<=o&&(g=!0,v=!0),v||p.retries<f.retry_record){f.retry_record=p.retries;var y=this.$(".gimbles .retry-record");this.animateTask(y),g=!0}if(v||p.time<f.time_record){f.time_record=p.time;var y=this.$(".gimbles .time-record");this.animateTask(y),g=!0}if(v||p.turns<f.turn_record){f.turn_record=p.turns;var y=this.$(".gimbles .turn-record");this.animateTask(y),g=!0}g&&e.audioManager.playSound("new_record",{delay:3})}if(!t.alreadyBeaten&&(f.completed=o+1,m="new puzzle completed!",l&&(m="new level completed!",this.animateStar()),l)){var d=this;_.delay(function(){d.considerShopPrompt()},5e3)}this.$rewardBar.animate({maxWidth:"10em",paddingLeft:"6.9em",opacity:1},600,function(){d.$rewardText.show(),d.rewardTextAnim.animateText(m,"type"),d.updateMultiplier()}),this.rewardFadeTimeout=_.delay(function(){d.$rewardBar.fadeOut(),d.$rewardText.fadeOut()},6e3),this.updateLevelDisplay(t),0>c&&GAME.storage.setItem(c+"_levelHistory",JSON.stringify(h))}},saveSettings:function(){var t=e.user.get("activeAvatar").name;e.gamePlayer.flagUpdateAvatar&&(t=e.gamePlayer.flagUpdateAvatar.name);var i=({data:{settings:this.settings,avatar:t}},e.user.get("user_id"));GAME.storage.setItem(i+"_settings",JSON.stringify(this.settings)),GAME.storage.setItem(i+"_avatar",t),e.menu.storedSettings=this.settings,e.menu.storedAvatarName=t},animateTask:function(e){var t=new GAME.HTMLAnim.TypeAnimator({el:e});e.addClass("animating"),t.animateText(e.html())},updateMultiplier:function(){var e=1;for(var t in this.factors)this.factors[t]&&(this.factors[t].expires&&GAME.now()>this.factors[t].expires?this.factors[t]=void 0:"add"==this.factors[t].type?(e+=this.factors[t].factor,this.factors[t].symbol="+"):(e*=this.factors[t].factor,this.factors[t].symbol="&times;"));var i=this.multiplier;return this.multiplier=e,this.multiplierAnim?(this.multiplierAnim.setElement($("#multiplier .display .number")),this.multiplierAnim.animateNumber(i,this.multiplier,1e3)):$("#multiplier .display .number").html("&times;"+this.multiplier.toFixed(2)),this.pauseMenuOpen&&$("#multiplier .factor-list").html(GAME.templates["factor-list"]({factors:this.factors})),e},confirmSave:function(t,i){t.success?(t.points&&e.user.set("points",t.points),i&&(i.saveFlag=!0)):(e.menu.displayAlert(t),i&&(i.saveFlag=!0))},animateStar:function(){var e=$('<div class = "level-star">');this.$el.append(e),e.html(a),e.css({position:"fixed",top:"48%",right:"50%",transform:"scale(20,20)",opacity:0}),e.animate({opacity:1},{step:function(e,t){var i=Math.lerp(20,5,e);$(this).css("transform","scale("+i+","+i+")")},duration:1500,easing:"linear",complete:function(){var t=GAME.now();e.animate({top:"92%",right:"0%"},{step:function(e){var i=Math.lerp(5,.5,(GAME.now()-t)/700);$(this).css("transform","scale("+i+","+i+")")},duration:700,easing:"linear",complete:function(){e.remove()}})}})},handlePopHistory:function(e){e||(this.purchaseUnderway&&this.pushHistory({state:"shop"},"roTopo Shop","/shop"),this.leaveShop())},remakeShuffleList:function(){if(this.shuffleList=this.levelMenu.select(this.activeSelector),e.gamePlayer.activePuzzle){var t=e.gamePlayer.activePuzzle.level;this.shuffleList=_.reject(this.shuffleList,function(e){return e.level_id==t.level_id})}else console},shuffle:function(t){this.shuffleList&&0!=this.shuffleList.length||(this.shuffleList=this.levelMenu.select(this.activeSelector));for(var i=[],a=1e5,s=e.user.get("levelHistory"),r=0;r<this.shuffleList.length;r++){var n=this.shuffleList[r],o=-1;s[n.level_id]&&(o=s[n.level_id].completed/n.puzzles.length),a>o?(a=o,i=[n]):o==a&&i.push(n)}var n=_.sample(i);n&&(this.playLevel(n.level_id),this.shuffleList=_.without(this.shuffleList,n))},draw:function(){this.$el.html(GAME.templates.overlay()),this.$("#gimbles").text(e.user.get("points")),this.updateMultiplier(),this.updateLevelDisplay(e.state.get("currentPuzzle")),this.levelMenu=new e.LevelMenu({el:$("#level-menu"),parent:this}),this.resize()},drawOptions:function(e){$(".setting .option").removeClass("selected");for(var t in this.settings)e.find(".setting .options[name~="+t+"]").find("."+this.settings[t]).addClass("selected")},resize:function(){this.levelMenu&&this.levelMenu.fixCSS(),$(".line.gimbles").width()+$("#multiplier").width()>$(window).width()?$("#multiplier").css("font-size","0.5em"):$("#multiplier").css("font-size","1em");var e=$(".shop-list").height()/216*.9;$(".shop-item-ad").css({transform:"scale("+e+","+e+")"}),$(window).width()<$(".line.gimbles").width()+468?$(".shop-ad").hide():$(".shop-ad").show()}});var r=function(e){var t=0;if(0==e.length)return t;for(var i=0;i<e.length;i++){var a=e.charCodeAt(i);t=(t<<5)-t+a,t&=t}return t}},Camera=function(e){var t=GAME.GFX;e.GimbleCamera=GAME.Models.Model.extend({setup:function(){this.tempMat4=new THREE.Matrix4},saveRemovingState:function(){this.removeCameraPos=_.clone(this.cameraPos),this.removeCameraUpBasic=_.clone(this.cameraUp),this.removeCameraUp=this.getRealUp();var e=this.controller.scene._camera;this.removeCameraTarget=this.cameraTarget,this.removeCameraDistance=Vec.distance(this.cameraPos,this.cameraTarget),this.removingQuat=e.quaternion.clone()},getRealUp:function(){var e=Vec.sub([0,0,0],this.cameraPos),t=Vec.perpendicular(e,this.cameraUp);return Vec.perpendicular(t,e)},saveVictoryState:function(){this.victoryCameraPos=_.clone(this.cameraPos),this.victoryCameraUp=this.getRealUp(),this.victoryCameraTarget=_.clone(this.cameraTarget);var e=this.controller.scene._camera;this.victoryQuat=e.quaternion.clone()},updateVictory:function(){var t=this.controller,i=t.player.getPosition(),a=i,s=Vec.invert(t.playerIn),r=t.activePuzzle.victoryTime,n=Vec.add(i,Vec.setLength(Vec.lerp(s,t.playerDir,.5),e.CAMERA_DIST)),o=Math.inOut(r/e.VICTORY_DUR,1.5),l=this.controller.scene._camera;t.scene.setCamera(n,a,s),l.quaternion.slerp(this.victoryQuat,1-o);var h=l.getWorldDirection(),c=new THREE.Vector3;c.fromArray(Vec.lerp(this.victoryCameraTarget,a,o));var u=Math.lerp(Vec.distance(this.victoryCameraPos,this.victoryCameraTarget),Vec.distance(n,a),o);l.position.copy(c.add(h.setLength(-u))),this.cameraPos=n,this.cameraTarget=a,this.cameraUp=s},getPosition:function(){return t.V3toArray(e.gamePlayer.scene._camera.position)},updateRemoving:function(e,t,i,a){var s=this.controller,r=Math.inOut(s.removingAmount,2),n=s.scene._camera;s.scene.setCamera(e,t,i);var o=new THREE.Vector3;o.fromArray(Vec.lerp(this.removeCameraTarget,t,r)),n.quaternion.slerp(this.removingQuat,1-r);var l=n.getWorldDirection(),h=Math.lerp(this.removeCameraDistance,Vec.distance(e,t),r);n.position.copy(o.add(l.setLength(-h))),this.cameraPos=e,this.cameraUp=i,this.cameraTarget=t,s.scene.setFOV(65)},gameUpdate:function(i){var a=this.controller;if(a.screenSaver||!a.activePuzzle)return this.cameraPos=[0,0,-2.5],this.cameraUp=[0,1,0],this.cameraTarget=[0,0,0],this.scene.setCamera(this.cameraPos,this.cameraTarget,this.cameraUp),void this.scene.setFOV(90);if(a.activePuzzle.state==e.PUZZLE_STATE.INSPECT)return this.cameraPos=[0,0,-a.activePuzzle.inspectDistance],this.cameraUp=[0,1,0],this.cameraTarget=[0,0,0],this.scene.setCamera(this.cameraPos,this.cameraTarget,this.cameraUp),void this.scene.setFOV(80);var s=a.activePuzzle.state,r=a.player.getPosition();a.activity==e.GAME_ACTIVITY.REMOVING&&(r=e.gamePlayer.activePuzzle.startPos);var n=Vec.normalize(r),o="float",l=Vec.invert(a.playerIn),h=Vec.clone(a.playerForward);o=a.activePuzzle.cameraType||"float";var c=a.activePuzzle.targetScale||.5,u=90,d=0,m=0;if("float"==o?u=a.activePuzzle.cameraAngle||90:"follow"==o?(o="float",c=1,d=1,u=a.activePuzzle.cameraAngle||45):"orbit"==o?c=0:"track"==o&&(m=1,o="float",c=1,u=a.activePuzzle.cameraAngle||45),"follow"==e.overlay.settings.camera&&(c=1,o="float"),"float"==o)for(var p=a.playerTile,f=Vec.sub(r,p.center),g=a.playerDir,v=.5*p.sideLength,y=p.neighbors,b=Vec.axisString(Vec.toAxis(a.playerDir)),E=.35,M=["x","y","z"],w=0;w<M.length;w++){var T="p"+M[w],P="n"+M[w];if(b!=T||!y[T]||m&&!y[T].cameraData.movecam)if(b!=P||!y[P]||m&&!y[P].cameraData.movecam);else{var S=-(f[w]-v)*E/v;l=t.slerpVec2(l,p.normal,y[P].normal,S,g),h=t.slerpVec2(h,p.normal,y[P].normal,S,g)}else{var S=(f[w]+v)*E/v;l=t.slerpVec2(l,p.normal,y[T].normal,S,g),h=t.slerpVec2(h,p.normal,y[T].normal,S,g)}}l=Vec.normalize(l);var A=Vec.angleBetween(l,n),V=A/Math.PI;A>Math.PI/2&&(V=.85);var _=V,z=t.slerpVec(n,l,_),k=[0,0,0];"float"==o&&(z=l,k=Vec.scale(r,c),90>u&&!e.gamePlayer.playerTile.cameraData.movecam&&(z=Vec.add(Vec.scale(l,Math.sin(Math.radians(u))),Vec.scale(h,-Math.cos(Math.radians(u))))));var x=h;d&&(x=l),m&&(e.gamePlayer.playerTile.cameraData.movecam?(m=0,d=1,u=90,x=a.playerForward):x=a.activePuzzle.cameraUp),m&&(z=Vec.add(Vec.scale(a.activePuzzle.cameraUp,Math.sin(Math.radians(u))),Vec.scale(a.activePuzzle.cameraDir,-Math.cos(Math.radians(u))))),d&&(z=Vec.add(Vec.scale(l,Math.sin(Math.radians(u))),Vec.scale(h,-Math.cos(Math.radians(u)))));var L=e.state.get("window").ar,R=a.activePuzzle.cameraDist||e.CAMERA_DIST;1>L&&(R*=1/L);var C=Vec.setLength(z,R),O=Vec.add(r,C);this.cameraUp=this.cameraUp||a.playerForward,this.cameraPos=this.cameraPos||O,this.cameraTarget=this.cameraTarget||k,this.cameraOffset=this.cameraOffset||Vec.sub(O,r);var D=65,I=e.gamePlayer.activePuzzle.cameraSpeed||1;if(a.activity==e.GAME_ACTIVITY.REMOVING)this.updateRemoving(O,k,x,i),this.cameraOffset=C;else if(s==e.PUZZLE_STATE.VICTORY)this.updateVictory();else if(s==e.PUZZLE_STATE.PLAY||s==e.PUZZLE_STATE.VICTORY){if(e.gamePlayer.avatarData.frozen)return;this.cameraUp=t.slerpVec(this.cameraUp,x,Math.clamp(2.5*i*I,0,1),.5*i,void 0,a.playerDir),this.cameraOffset=t.slerpVec(this.cameraOffset,C,Math.clamp(2.5*i*I,0,1),.5*i,void 0,a.playerDir),this.cameraPos=Vec.add(r,this.cameraOffset),this.cameraTarget=k,a.scene.setCamera(this.cameraPos,this.cameraTarget,this.cameraUp),a.scene.setFOV(D);this.controller.scene._camera}}})},Puzzle=function(e){var t=GAME.GFX;e.PUZZLE_STATE=Enum(["ENTER","PLAY","DIE","FAIL","VICTORY","PASS","INSPECT"]),e.LIGHT_VEC=new THREE.Vector4(.1,1,.1,0),e.PLAYER_VEC=new THREE.Vector4,e.MUSIC={MAJOR:[261.63,293.66,329.63,349.23,392,440,493.88,523.25],MINOR:[220,246.94,261.63,293.66,329.63,349.23,392,440]};var i=new THREE.BoxGeometry(1,1,1),a={coloredHex:15624021,ghostHex:34816,eraseHex:0,justBorderHex:255,errorHex:16746496,stepHex:65280,leaveHex:49152,failHex:12481128,finishHex:5605631};e.TILE_STATE=a;var s={background:[.812,.839,.807],colored:[.933,.403,.333],ghost:[.85,.8,.8],ghostAlpha:.75,style:0,nearGradient:[.63,.23,.31],farGradient:[.99,.53,.25]};e.COLOR_THEME=s;var r=new THREE.ShaderMaterial({uniforms:{time:{type:"f",value:0},playerPos:{type:"v3",value:new THREE.Vector3(0,0,0)},playerDir:{type:"v3",value:new THREE.Vector3(0,0,0)},playerForward:{type:"v3",value:new THREE.Vector3(0,0,0)},playerRight:{type:"v3",value:new THREE.Vector3(0,0,0)},explodeAmount:{type:"f",value:0},ghostAlpha:{type:"f",value:.95},aliasScale:{type:"f",value:1},cameraDist:{type:"f",value:1},drawWindow:{type:"i",value:0},tex:{type:"t",value:void 0},coloredColor:{type:"c",value:new THREE.Color},ghostColor:{type:"c",value:new THREE.Color},nearGradient:{type:"c",value:new THREE.Color(0)},farGradient:{type:"c",value:new THREE.Color(16777215)},state:{type:"i",value:0},style:{type:"i",value:0},AOEffect:{type:"f",value:1},scale:{type:"f",value:1},eyeLight:{type:"v3",value:new THREE.Vector3(0,0,0)},eyePlayer:{type:"v3",value:new THREE.Vector3(0,0,0)}},vertexShader:$("#vertexShader").text(),fragmentShader:$("#fragmentShader").text(),vertexColors:THREE.FaceColors,shading:THREE.FlatShading,side:THREE.DoubleSide,transparent:!0});e.TileMaterial=r,r.sharedAsset=!0,e.SceneryMaterial=new THREE.ShaderMaterial({uniforms:{time:{type:"f",value:0},aliasScale:{type:"f",value:1},explodeAmount:{type:"f",value:0},nearGradient:{type:"c",value:new THREE.Color(0)},farGradient:{type:"c",value:new THREE.Color(16777215)},cameraDist:{type:"f",value:1},playerPos:{type:"v3",value:new THREE.Vector3},style:{type:"i",value:0},state:{type:"i",value:0},drawWindow:{type:"i",value:0},opacity:{type:"f",value:1},eyeLight:{type:"v3",value:new THREE.Vector3(0,0,0)},eyePlayer:{type:"v3",value:new THREE.Vector3(0,0,0)}},vertexShader:$("#sceneryVertexShader").text(),fragmentShader:$("#sceneryFragmentShader").text(),vertexColors:THREE.FaceColors,transparent:!0});var n=new THREE.Matrix4;t.addTileToGeometry=function(e,i,a,s,r,o){var l=e.vertices,h=e.faces,c=new THREE.Vector3,u=new THREE.Vector3;u.fromArray(r),c.fromArray(a);var d=l.length;n.lookAt(t.ZERO,c,u),n.elements[12]=i[0],n.elements[13]=i[1],n.elements[14]=i[2],l.push(new THREE.Vector3(.5*-s,.5*-s,0)),l[l.length-1].applyMatrix4(n),l.push(new THREE.Vector3(.5*-s,.5*s,0)),l[l.length-1].applyMatrix4(n),l.push(new THREE.Vector3(.5*s,.5*-s,0)),l[l.length-1].applyMatrix4(n),l.push(new THREE.Vector3(.5*s,.5*s,0)),l[l.length-1].applyMatrix4(n),h.push(new THREE.Face3(d+0,d+1,d+2,c)),h.push(new THREE.Face3(d+1,d+3,d+2,c)),h[h.length-1]._myDir=r,h[h.length-2]._myDir=r,o.movecam&&(h[h.length-1]._movecam=1,h[h.length-2]._movecam=1)},t.createGeometryForPath=function(e,i){var a=e.split(" "),s=new THREE.Geometry,r=(s.vertices,s.faces,[0,0,0]),n=[0,1,0],o=[0,0,-1],l=[],h={movecam:0};a.length&&"<cam>"==a[0]&&(h.movecam=1);var c=!1;t.addTileToGeometry(s,r,n,i,o,h);for(var u=0;u<a.length;u++){var d=a[u];if("{"!=d[0])if("}"!=d[0]){if(!c&&"_"!=d[0]){var m=0;if("z"==d[0]&&(m=1,d=d.substr(1)),"n"==d[0]&&(h.invertFlag=1,d=d.substr(1)),"<cam>"!=d)if("</cam>"!=d)if("x"!=d[0]){if(l.push({center:r,normal:n,direction:o}),"f"==d[0]||"r"==d[0]||"l"==d[0]||"b"==d[0]){if("s"==d[1])"f"==d[0]||("l"==d[0]?o=Vec.toAxis(Vec.perpendicular(n,o)):"r"==d[0]?o=Vec.toAxis(Vec.perpendicular(o,n)):"b"==d[0]&&(o=Vec.invert(o))),r=Vec.add(Vec.setLength(o,i),r);else{var p=Vec.setLength(n,.5*i),f=_.clone(n);"d"==d[1]&&(p=Vec.invert(p),f=Vec.invert(n)),"f"==d[0]?(r=Vec.add(r,Vec.add(Vec.setLength(o,.5*i),p)),n=Vec.invert(o)):"l"==d[0]?(n=Vec.toAxis(Vec.perpendicular(o,n)),r=Vec.add(r,Vec.add(Vec.setLength(n,.5*-i),p))):"r"==d[0]?(n=Vec.toAxis(Vec.perpendicular(n,o)),r=Vec.add(r,Vec.add(Vec.setLength(n,.5*-i),p))):"b"==d[0]&&(r=Vec.add(r,Vec.add(Vec.setLength(o,.5*-i),p)),n=o),"d"==d[1]&&(n=Vec.invert(n)),o=f}h.invertFlag&&(n=Vec.invert(n),h.invertFlag=0),m||t.addTileToGeometry(s,r,n,i,o,h)}}else{var g=l.pop();o=g.direction,r=g.center,n=g.normal}else h.movecam=0;else h.movecam=1}}else c=!1;else c=!0}return s.mergeVertices(),s},e.Puzzle=t.Group.extend({loadGeometry:function(e,i){var a=function(e){var t=e.scene.children[0].children[0].geometry;i(t)};t.colladaLoader.load(e,a)},makeNotes:function(t){if(e.TEST_SHAPE||e.gamePlayer.screenSaver)Math.srand(5);else{var i=e.user.get("activeAvatar");i.theme&&i.theme.musicSeed?Math.srand(1e4*i.theme.musicSeed+100*this.level.level_id+t):Math.srand(100*this.level.level_id+t)}this.baseNotes=_.clone(Math.randomReal(0,1)<.5?_.clone(e.MUSIC.MAJOR):_.clone(e.MUSIC.MINOR));var a=_.randomShuffle(_.clone(this.baseNotes));this.noteShift=[.75,1,1.333,1.5][Math.randomInt(0,3)];var s=_.randomShuffle(a.slice(3,7));a=a.concat(a),a.length=12,a=a.concat(s),this.notes=a},inspect:function(){this.state=e.PUZZLE_STATE.INSPECT,this.resetTileColors(),this.inspectTime=0,e.gamePlayer.human.setVisibility(!1),this.inspectDistance=5.5*this.sideLength},isValidMove:function(e,t,i){var a=e.normal,s=t.normal,r=Vec.angleBetween(a,s);if(.01>r)return!0;if(r>Math.PI-.1)return!1;if(r>.01&&r<Math.PI-.1){var n=Vec.perpendicular(a,s),o=Vec.perpendicular(Vec.sub(t.center,e.center),i);return Vec.angleBetween(o,n)<.01?!1:!0}},makePuzzle:function(a,s){this.ts=e.user.get("user_id")+"+"+this.level.level_id+"+"+a,this.player&&this.add(this.player),this.avatar=e.user.get("activeAvatar"),this.state=e.PUZZLE_STATE.ENTER,a%=this.level.puzzles.length,this.puzzleIndex=a;var r=this.level.puzzles[a],n=e.user.get("levelHistory");if(e.overlay&&(n[this.level.level_id]&&n[this.level.level_id].completed>this.puzzleIndex?(this.alreadyBeaten=1,delete e.overlay.deleteFactor("new_puzzle")):e.overlay.setFactor("new_puzzle",{type:"add",factor:1,reason:"new puzzle"})),this.name=r.name,this.reward=r.reward,this.makeNotes(a),this.playerSpeed=1,this.cameraDist=e.CAMERA_DIST,this.drawWindow="auto",this.cutWindow=0,this.windowCutTimer=0,_.extend(this,r.opts),this.originalStartTile=r.opts.startTile,this.originalStartDir=r.opts.startDir,this.alreadyBeaten&&s)_.extend(this,s);else if(this.alreadyBeaten&&r.altStarts){var o=_.union(r.altStarts,{st:this.startTile,dir:this.startDir}),l=_.sample(o);this.startTile=l.st,this.startDir=l.dir}"always"==this.drawWindow?this.cutWindow=1:"never"==this.drawWindow&&(this.cutWindow=0),this.cameraDir=this.startDir;var h;if(this.sideLength=r.s,r.path)h=t.createGeometryForPath(r.path,r.s);else if(r.box){for(var c=[],u=0;u<r.box.length;u++)_.isString(r.box[u])&&"s"==r.box[u][0]?c[u]=r.s*(Number(r.box[u].substr(1))||1):c[u]=r.box[u];h=new THREE.BoxGeometry(c[0],c[1],c[2],c[3],c[4],c[5])}else if(r.cubes){h=new THREE.Geometry;for(var d=0;d<r.cubes.length;d++){var m=r.cubes[d];t.tempMat4.makeTranslation(m[0],m[1],m[2]),h.merge(i,t.tempMat4,0)}h.mergeVertices(),h.computeFaceNormals(),t.transformGeometry({geometry:h,scale:r.s})}if(r.extrudes)for(var p=0;p<r.extrudes.length;p++)"j"==r.extrudes[p]?t.removeJoinedTiles(h):t.extrudeQuads(h,r.extrudes[p],r.s);if(r.removes){for(var f=0;f<r.removes.length;f++){var g=r.removes[f];"c"!=g?(h.faces[2*g]=void 0,h.faces[2*g+1]=void 0):h.faces=_.compact(h.faces)}h.faces=_.compact(h.faces)}this.processGeometry(h)},processGeometry:function(i){function s(e,i,a){var s=Vec.toAxis(Vec.sub(Vec.lerp(t.V3toArray(l[i]),t.V3toArray(l[a]),.5),e.center)),r=e.neighbors[Vec.axisString(s)];if(!r)return 0;var n=Vec.distance(Vec.displace(r.center,r.normal,.5*e.sideLength),Vec.displace(e.center,e.normal,.5*e.sideLength));return n<.1*e.sideLength?2:n<1.1*e.sideLength?0:1}i.center();var n=[],o=new THREE.Color;i.faceVertexUvs=[[]];var l=i.vertices,h={},c={},u=function(e){return e[0]<e[1]?e[0]+"+"+e[1]:e[1]+"+"+e[0]},d=function(e,t){var a=i.vertices[t[0]],s=i.vertices[t[1]],r=Vec.toAxis([.5*(a.x+s.x)-e.x,.5*(a.y+s.y)-e.y,.5*(a.z+s.z)-e.z]);return Vec.axisString(r)};e.JOIN_TILES&&t.removeJoinedTiles(i);for(var m=0;m<i.faces.length;m+=2){var p=new THREE.Vector3,f=i.faces[m],g=i.faces[m+1];p.add(l[f.b]),p.add(l[f.c]),p.multiplyScalar(.5);var v=l[f.a].distanceTo(l[f.b]);i.faces[m].color.setHex(e.TILE_STATE.coloredHex),i.faces[m+1].color.setHex(e.TILE_STATE.coloredHex),i.faceVertexUvs[0][m]=[new THREE.Vector2(0,0),new THREE.Vector2(0,1),new THREE.Vector2(1,0)],i.faceVertexUvs[0][m+1]=[new THREE.Vector2(0,1),new THREE.Vector2(1,1),new THREE.Vector2(1,0)],i.uvsNeedUpdate=!0,f.originalIndex=m,g.originalIndex=m+1,n.push({facea:f,faceb:g,normal:t.V3toArray(f.normal),activated:!1,number:n.length,center:t.V3toArray(p),sideLength:v,neighbors:{},neighborsLists:{},cameraData:{}});var y=_.last(n);y.facea._movecam&&(y.cameraData.movecam=y.facea._myDir);for(var b=[[f.a,f.b],[f.a,f.c],[g.a,g.b],[g.b,g.c]],E=0;4>E;E++){var M=u(b[E]),w=d(p,b[E]);if(h[M]){var T=h[M],P=T.tile;if(T.otherTile){c[M]=c[M]||[{tile:T.tile,dir:h[M].dir},{tile:T.otherTile,dir:h[M].otherDir}],c[M].push({tile:y,dir:w});continue}this.isValidMove(y,P,Vec.STRING_AXIS[w])?(P.neighbors[h[M].dir]=y,y.neighbors[w]=P):(P.neighbors[h[M].dir]=0,y.neighbors[w]=0),h[M].otherDir=w,h[M].otherTile=y}else h[M]={tile:y,dir:w}}}for(var S in c)for(var A=c[S],V=0;V<A.length;V++){for(var z=A[V],k=[],x=0;x<A.length;x++)if(x!=V){var L=A[x],y=z.tile,P=L.tile,R=Vec.dot(y.normal,Vec.normalize(Vec.sub(P.center,y.center)));k.push({tile:P,angle:R,isValid:this.isValidMove(y,P,Vec.STRING_AXIS[z.dir])})}k.sort(function(e,t){return e.angle<t.angle?1:e.angle>t.angle?-1:0}),z.tile.neighborsLists[z.dir]=k,k[0]&&k[0].isValid?z.tile.neighbors[z.dir]=k[0].tile:z.tile.neighbors[z.dir]=0}this.tiles=n;for(var V=0;V<this.tiles.length;V++){var y=this.tiles[V],C=s(y,y.facea.a,y.facea.b),O=s(y,y.facea.a,y.facea.c),D=s(y,y.faceb.b,y.faceb.c),I=s(y,y.faceb.a,y.faceb.b);o.setHex(a.coloredHex);var G=o.b=(27*C+9*O+3*D+I)/255;y.coloredHex=o.getHex(),o.setHex(a.ghostHex),o.b=G,y.ghostHex=o.getHex(),o.setHex(a.leaveHex),o.b=G,y.leaveHex=o.getHex(),o.setHex(a.stepHex),o.b=G,y.stepHex=o.getHex(),o.setHex(a.justBorderHex),o.b=G,y.justBorderHex=o.getHex(),y.aoinfo={lowX:C,lowY:O,hiX:D,hiY:I},y.facea.color.setHex(y.coloredHex),y.faceb.color.setHex(y.coloredHex)}if(this.tiles.length<=this.startTile)console.log("Warning: Starting tile off"),this.startTile=this.originalStartTile,this.startDir=this.originalStartDir;else{var H=Vec.dot(this.tiles[this.startTile].normal,this.startDir);(H>.9||-.9>H)&&(console.log("Warning: Starting tile off"),this.startTile=this.originalStartTile,this.startDir=this.originalStartDir)}this.miniMe=new t.Object3D({geometry:i,material:e.MiniMeMaterial}),this.alreadyBeaten?e.MiniMeMaterial.uniforms.opacity.value=.5:e.MiniMeMaterial.uniforms.opacity.value=1,this.miniMe.setScale(.01),this.miniMe.setVisibility(!1),this.cube&&this.remove(this.cube),this.originalShader=r,r.uniforms.tex.value&&(r.uniforms.tex.value.needsUpdate=!0),this.cube=new t.Object3D({geometry:i,material:r.clone()}),void 0!=this.ghostAlpha&&(this.cube.glObject.material.uniforms.ghostAlpha.value=this.ghostAlpha),this.add(this.cube),this.prepareForAvatar(),this.activeTile=-1,this.activatedTiles=0,this.cameraUp=this.tiles[this.startTile].normal;var $=_.last(this.tiles);e.TEST_SHAPE&&$.faceb._myDir&&(this.arrowMarker=new t.Object3D({geometry:t.makePyramidGeometry(.1*this.sideLength,6,.4*this.sideLength),materialColor:6710886}),this.add(this.arrowMarker),this.arrowMarker.setPosition($.center),this.arrowMarker.faceDirection($.faceb._myDir,$.normal)),this.updateTileTexture()},moveAlong:function(i,a){if(this.state==e.PUZZLE_STATE.PLAY){var s=Vec.axisString(i.direction);if(Vec.dot(i.direction,Vec.sub(i.position,i.tile.center))>.5*i.tile.sideLength){var r=i.tile.neighbors[s];if(r){var n=i.tile.normal,o=r.normal,l=Vec.angleBetween(n,o);if(l>.01){var h=Vec.perpendicular(n,o);i.up;i.up=o,i.direction=Vec.toAxis(t.rotateV3AxisAngle(i.direction,h,l))}i.tile=r}else i.direction=Vec.invert(i.direction)}i.animUp=t.slerpVec(i.animUp,i.up,0,Math.clamp(4*a,0,1));var c=Vec.angleBetween(i.up,i.animUp);c>.01||(i.position=Vec.displace(i.position,i.direction,i.speed*a))}},prepareForAvatar:function(){this.avatarData={};e.user.get("activeAvatar");e.themes.applyAvatar.call(this)},hide:function(){this.setVisibility(!1,{remember:!0})},show:function(){this.setVisibility(!0,{fromMemory:!0});for(var e=0;e<this.tiles.length;e++)this.tiles[e].scenery&&this.tiles[e].scenery.setVisibility(!this.tiles[e].activated)},cleanUpForAvatar:function(){e.themes.cleanUpHazards.call(this)},sortTiles:function(){var i=this.getLocalPosition(e.gamePlayer.camera.getPosition());if(this.sceneryGroup)this.sceneryGroup.sortChildren(i);else{if(this.count=(this.count||-1)+1,this.count%20!=0)return;var a=this.tiles,s=this.cube.glObject.geometry;if(!s._bufferGeometry)return;var r=a.length;this.sortIndices=this.sortIndices||_.range(0,r),this.swapFaces=this.swapFaces||_.range(0,s.faces.length);for(var n=0;r>n;n++)a[n].camDist=Vec.distancesq(a[n].center,i);this.sortIndices.sort(function(e,t){return a[e].camDist<a[t].camDist?1:a[e].camDist>a[t].camDist?-1:0});for(var o=!1,n=0;r>n;n++)this.sortIndices[n]!=s.faces[2*n].originalIndex/2&&(o=!0);if(!o)return;for(var n=0;r>n;n++)s.faces[2*n]=this.tiles[this.sortIndices[n]].facea,s.faces[2*n+1]=this.tiles[this.sortIndices[n]].faceb;t.remakeGeometry(s)}},updateForPlayer:function(t,i,a,s,r){if(this.fadingSceneries){for(var n=0,o=0;o<this.fadingSceneries.length;o++)this.fadingSceneries[o].glObject.material.uniforms.opacity.value-=7.5*t,this.fadingSceneries[o].glObject.material.uniforms.opacity.value<0&&(this.fadingSceneries[o].setVisibility(!1),this.fadingSceneries[o]=void 0,n=1);n&&(this.fadingSceneries=_.compact(this.fadingSceneries))}var l=Vec.scale(i.getPosition(),this.getScale()),h=e.user.get("activeAvatar");this.explodeAmount>0&&(l=Vec.add(l,Vec.setLength(this.tiles[this.startTile].normal,8*this.explodeAmount))),this.tileSceneries&&this.tileSceneries[0]&&(this.tileSceneries[0].material.uniforms.playerPos.value.fromArray(l),this.tileSceneries[0].material.uniforms.state.value=this.state);var c=this.cube.glObject.material.uniforms;c.playerPos.value.fromArray(l),a||(a=[0,0,-1]),c.scale.value=this.getScale(),c.playerForward.value.fromArray(a||[0,0,-1]),c.playerDir.value.fromArray(r||[0,0,-1]),c.playerRight.value.fromArray(s||[1,0,0]),c.aliasScale.value=Math.max(1,e.gamePlayer.scene.canvasScale||1),c.state.value=this.state,e.LIGHT_VEC.set(.1,1,.1,0),e.LIGHT_VEC.applyMatrix4(e.gamePlayer.scene._camera.matrixWorldInverse),
c.eyeLight.value.set(e.LIGHT_VEC.x,e.LIGHT_VEC.y,e.LIGHT_VEC.z),c.eyeLight.value.normalize(),e.PLAYER_VEC.set(l[0],l[1],l[2],1),e.PLAYER_VEC.applyMatrix4(e.gamePlayer.scene._camera.matrixWorldInverse),c.eyePlayer.value.set(e.PLAYER_VEC.x,e.PLAYER_VEC.y,e.PLAYER_VEC.z),this.sceneryMaterial&&(this.sceneryMaterial.uniforms.eyeLight.value.copy(c.eyeLight.value),this.sceneryMaterial.uniforms.eyePlayer.value.copy(c.eyePlayer.value));var u=e.state.get("window"),d=this.cameraDist;u&&u.ar<1&&(d/=u.ar),c.cameraDist.value=d,this.state==e.PUZZLE_STATE.INSPECT&&(c.cameraDist.value=this.inspectDistance),e.gamePlayer.human.material.uniforms.aliasScale.value=e.gamePlayer.scene.canvasScale||1,this.cube.glObject.material.uniforms.time.value+=t,e.themes.updateHazards.call(this,t,i,h)},playFailSound:function(){e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[3]*this.noteShift}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[2]*this.noteShift,delay:.2}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[0]*this.noteShift,delay:.3})},fail:function(){this.state=e.PUZZLE_STATE.FAIL,this.cleanUpForAvatar()},die:function(){e.gamePlayer.activeLevelData&&(e.gamePlayer.activeLevelData.retries++,e.overlay.savePuzzleFailed(this)),this.state!=e.PUZZLE_STATE.FAIL&&this.state!=e.PUZZLE_STATE.DIE&&(this.dyingTime=0,this.state=e.PUZZLE_STATE.DIE,this.playFailSound(),this.colorForFail())},colorForFail:function(){for(var e=0;e<this.tiles.length;e++);},pass:function(){if(e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[0]*this.noteShift}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[2]*this.noteShift,delay:.2}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[4]*this.noteShift,delay:.3}),this.puzzleIndex==this.level.puzzles.length-1){var t=.6;e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[0]*this.noteShift,delay:t}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[2]*this.noteShift,delay:t+.2}),e.audioManager.playSynth({volume:8*e.VOLUME,frequency:this.baseNotes[7]*this.noteShift,delay:t+.3})}this.state=e.PUZZLE_STATE.PASS},playVictory:function(t){this.state=e.PUZZLE_STATE.VICTORY,this.completed=!0,this.victoryTime=0,this.victoryTile=t;for(var i=this,a=0;a<this.tiles.length;a++)this.changeTileColor(this.tiles[a],this.tiles[a].ghostHex);e.audioManager.playSynth({volume:10*e.VOLUME,frequency:this.baseNotes[6]*this.noteShift,prepare:function(e,t){e.duration=3.5,e.osc.frequency.setTargetAtTime(i.baseNotes[1]*i.noteShift*2,t+1.5,.05),e.osc2.frequency.setTargetAtTime(i.baseNotes[1]*i.noteShift*2,t+1.5,.05),e.humpTime=1.5},delay:1.3}),this.miniMeTime=0,e.gamePlayer.player.add(this.miniMe),this.cleanUpForAvatar(),e.gamePlayer.handleActivePuzzleVictory()},updateVictory:function(t){this.victoryTime+=t;var i=this.victoryTime/e.VICTORY_DUR;if(this.saveFlag&&this.victoryTime>e.VICTORY_DUR+e.POSE_DUR)return this.miniMe.setVisibility(!1),e.gamePlayer.player.remove(this.miniMe),void this.pass();var a=i;if(this.victoryTime>1.3){var s=1;this.victoryTime>2.8&&(s*=3),this.miniMeTime+=t*s,this.miniMe.setVisibility(!0);var a=this.miniMeTime/4.5;if(this.miniMe.setEuler([.5*Math.PI,3*-a*Math.PI,0]),a>1)return;this.miniMe.setScale(.006+.04*a);var r=1+.6*a;this.miniMe.setPosition([0,0,r*e.gamePlayer.human.height+e.gamePlayer.human.getPosition()[2]])}},update:function(t){if(this.sortTiles(),this.state==e.PUZZLE_STATE.INSPECT)return this.inspectTime=(this.inspectTime||0)+t,this.rotateAxisAngle(Vec.normalize([1,1,0]),Math.PI*(3/8)*this.inspectTime),void(this.inspectTime>8/3&&e.gamePlayer.quickSwapNextPuzzle());if(this.state==e.PUZZLE_STATE.VICTORY&&this.updateVictory(t),this.windowCutTimer>0)this.windowCutTimer-=t;else if(!e.gamePlayer.screenSaver&&"auto"==this.drawWindow&&this.state==e.PUZZLE_STATE.PLAY){var i=e.gamePlayer.player.getPosition();i=Vec.displace(i,e.gamePlayer.playerCharacterUp,.5*e.gamePlayer.human.height);var a=e.gamePlayer.camera.getPosition(),s=this.getTile(i,Vec.sub(a,i),!0);s?(this.cutWindow=1,this.windowCutTimer=1):this.cutWindow=0}this.cube.glObject.material.uniforms.drawWindow.value=this.cutWindow,this.sceneryMaterial&&(this.sceneryMaterial.uniforms.drawWindow.value=this.cutWindow)},explode:function(t){this.explodeAmount=t,t>0&&this.cube.glObject.material.uniforms.playerPos.value.set(0,0,0),this.cube.glObject.material.uniforms.explodeAmount.value=t,e.themes.explodeHazards.call(this,t);for(var i=0;i<this.tiles.length;i++){var a=this.tiles[i],s=a.scenery;s&&s.setPosition(Vec.add(s.originalPosition,Vec.scale(a.normal,8*t)))}},markTileCleared:function(e){this.changeTileColor(e,e.leaveHex),e.cleared=!0,this.lastGhosted&&this.changeTileColor(this.lastGhosted,this.lastGhosted.ghostHex),this.lastGhosted=e},updateForLastPuzzle:function(t){if(t&&this.tiles.length==t.length)for(var i=0;i<this.tiles.length;i++)t[i].activated||(this.changeTileColor(this.tiles[i],e.TILE_STATE.eraseHex),this.tiles[i].scenery&&this.tiles[i].scenery.setVisibility(!1))},resetTileColors:function(){for(var t=0;t<this.tiles.length;t++)this.tiles[t].scenery?(this.changeTileColor(this.tiles[t],e.TILE_STATE.eraseHex),this.tiles[t].scenery.setVisibility(!0)):this.changeTileColor(this.tiles[t],this.tiles[t].coloredHex)},changeTileColor:function(e,t){e.facea.color.setHex(t),e.faceb.color.setHex(t),this.cube.glObject.geometry.colorsNeedUpdate=!0},updateTileTexture:function(e){e&&(this.cube.glObject.material.uniforms.tex.value=e),this.cube.glObject.material.uniforms.tex.value&&(this.cube.glObject.material.uniforms.tex.value.needsUpdate=!0)},fadeTileColor:function(i){if(i.activated=!i.activated,i.activated){this.activatedTiles++,this.activatedTiles==this.tiles.length&&this.playVictory(i);var a=t.ArraytoV3(e.gamePlayer.player.getPosition());e.gamePlayer.scene._camera.worldToLocal(a),e.audioManager.playSynth({volume:9*e.VOLUME,frequency:this.notes[this.activatedTiles%this.notes.length]*this.noteShift}),i.scenery&&(this.fadingSceneries=this.fadingSceneries||[],i.scenery.glObject.material=this.sceneryMaterial.clone(),this.fadingSceneries.push(i.scenery)),e.handleTileStepForAvatar.call(this,i),this.changeTileColor(i,i.stepHex),this.cube.glObject.material.uniforms.time.value=0,e.gamePlayer.handleTileCleared(),this.updateNeighborTiles(i)}else this.die(),this.changeTileColor(i,e.TILE_STATE.errorHex),i.activated=!i.activated;this.cube.glObject.geometry.colorsNeedUpdate=!0},updateNeighborTiles:function(e){var t=function(e){for(var t in e.neighbors)for(var i=e.neighborsLists[t]||[],a=0;a<i.length;a++)if(!i[a].tile.activated){i[a].isValid&&(e.neighbors[t]=i[a].tile);break}};for(var i in e.neighbors){var a=e.neighborsLists[i];if(a)for(var s=0;s<a.length;s++)t(a[s].tile);else t(e.neighbors[i])}},updateTrackVecs:function(t){t.cameraData.movecam&&(this.cameraDir=e.gamePlayer.playerForward,this.cameraUp=t.normal)},getTile:function(e,t,i){GAME.GFX.tempRaycaster.ray.origin.fromArray(e),GAME.GFX.tempRaycaster.ray.direction.fromArray(Vec.normalize(t)),GAME.GFX.tempRaycaster.near=0,GAME.GFX.tempRaycaster.far=Vec.length(t),i&&(this.cube.glObject.material.side=THREE.DoubleSide);var a=GAME.GFX.tempRaycaster.intersectObject(this.cube.glObject,!1),s=a[0],r=Vec.length(t);if(s&&s.distance<=1.35*r&&s.faceIndex>=0){var n=Math.floor(this.cube.glObject.geometry.faces[s.faceIndex].originalIndex/2);return this.tiles[n]}return null}})},AvatarEffects=function(e){var t=GAME.GFX;e.BasicMaterial=new THREE.ShaderMaterial({uniforms:{color:{type:"c",value:new THREE.Color(4534344)},ambient:{type:"f",value:.8},gloss:{type:"f",value:0},specularColor:{type:"v3",value:new THREE.Vector3(0,0,0)},backfaceColor:{type:"c",value:new THREE.Color(4534344)},dissolve:{type:"f",value:0},aliasScale:{type:"f",value:1},opacity:{type:"f",value:1}},vertexShader:$("#avatarVertexShader").text(),fragmentShader:$("#avatarFragmentShader").text(),shading:THREE.FlatShading,transparent:!0}),e.BasicMaterial.sharedAsset=!0,e.MiniMeMaterial=e.BasicMaterial.clone(),e.MiniMeMaterial.side=THREE.DoubleSide,e.MiniMeMaterial.sharedAsset=!0,e.urchinMaterial=e.BasicMaterial.clone(),e.urchinMaterial.uniforms.color.value.fromArray([.9,.9,.9]),e.urchinMaterial.uniforms.specularColor.value.fromArray([.5,.5,.6]),e.urchinMaterial.uniforms.gloss.value=10,e.urchinMaterial.uniforms.ambient.value=.8,e.urchinMaterial.uniforms.dissolve.value=0,e.urchinMaterial.sharedAsset=!0,e.urchinGeometry=new THREE.IcosahedronGeometry(.02),e.urchinGeometry.sharedAsset=!0;for(var i=e.urchinGeometry,a=e.urchinMaterial,s=i.faces.length,r=0;s>r;r++){var n=i.faces[r];n.normal.z>=0&&t.extrudeFaceToPoint(i,r,.075)}i.computeFaceNormals(),i.faceVertexUvs[0]=[],e.Urchin=t.Object3D.extend({geometry:i,radius:.075,material:a,wiggle:function(){this.wiggleTime=0,e.audioManager.playSynth({synthType1:"square",synthType2:"sawtooth",frequency:1680,volume:9*e.VOLUME})},update:function(e){if(void 0!=this.wiggleTime){this.wiggleTime+=e;var t=Math.sin(25*Math.pow(this.wiggleTime,.5))*(.6-.2*this.wiggleTime);0>t&&(t*=.5),this.setScale(1+t)}}});var o=e.BasicMaterial.clone();o.uniforms.color.value.fromArray([.33,.3,.3]),o.uniforms.ambient.value=.6,o.uniforms.specularColor.value.fromArray([.5,.5,.4]),o.uniforms.gloss.value=10;var l=e.BasicMaterial.clone();l.uniforms.color.value.fromArray([.8,.23,.16]);var h=t.makeSphereGeometry(.03,1);t.transformGeometry({geometry:h,translate:[0,0,.15]}),e.Bullet=t.Object3D.extend({material:o,geometry:h,radius:.03,lift:.15,active:!0,update:function(e){this.fadeTime>2||(this.puzzle.moveAlong(this.state,e),this.orient(),this.active||(this.fadeTime+=e,this.material.uniforms.dissolve.value+=.5*this.fadeTime))},orient:function(){this.setPosition(this.state.position),this.faceDirection(this.state.animUp,this.state.direction)},hit:function(){this.glObject.material=l},fadeOut:function(){this.active=!1,this.fadeTime=0,this.material=this.material.clone(),this.glObject.material=this.material}}),e.bombBlast=t.ParticleSystem.extend({particleCount:40,particleSize:.2,particleOpacity:1,particleColor:16777215,initParticles:function(){this.velocities=[],this.glObject.geometry.vertices.length=this.particleCount,this.velocities.length=this.particleCount;for(var e=0;e<this.particleCount;e++)this.velocities[e]=new THREE.Vector3,this.velocities[e].fromArray(Vec.randomAngle()),this.glObject.geometry.vertices[e]=new THREE.Vector3},update:function(e){t.ParticleSystem.prototype.update.call(this,e);for(var i=this.glObject.geometry.vertices,a=0,s=i.length;s>a;a++)i[a].addScaledVector(this.velocities[a],1.5*e),this.glObject.geometry.verticesNeedUpdate=!0;this.material.opacity-=2*e,this.material.opacity<0&&(this.material.opacity=0)}}),e.jetpackFireMaterial=e.BasicMaterial.clone(),e.jetpackFireMaterial.uniforms.color.value.fromArray(Color255([47,199,255])),e.jetpackFireMaterial.uniforms.ambient.value=1,e.GradientMaterial=new THREE.ShaderMaterial({vertexShader:$("#oceanVertexShader").text(),fragmentShader:$("#gradientFragmentShader").text(),side:THREE.BackSide,uniforms:{loColor:{type:"c",value:new THREE.Color},hiColor:{type:"c",value:new THREE.Color}}}),e.OceanMaterial=new THREE.ShaderMaterial({vertexShader:$("#oceanVertexShader").text(),fragmentShader:$("#oceanFragmentShader").text(),side:THREE.BackSide,shading:THREE.FlatShading,transparent:!0}),e.CoinGeometry=new THREE.IcosahedronGeometry(.05,0),e.CoinMaterial=e.BasicMaterial.clone(),e.CoinMaterial.uniforms.color.value.setHex(15121427),e.CoinMaterial.uniforms.gloss.value=2,e.CoinMaterial.uniforms.specularColor.value.set(.2,.2,.2),e.Coin=t.Group.extend({height:.15,radius:.05,setup:function(){this.glObject=new THREE.Object3D,this.coin=new t.Object3D({type:"collada",material:e.CoinMaterial,geometry:this.geometryLoader.getGeometry("coin")}),this.add(this.coin),this.coin.setPosition([0,0,this.height]),this.coin.setScale(.07),this.clock=0},update:function(e){this.clock+=e,this.coin.setPosition([0,0,this.height+Math.sin(5*this.clock)*this.radius]),this.coin.setEuler([0,0,5*this.clock])}}),e.Bubbles=t.ParticleSystem.extend({particleCount:15,particleSize:.05,particleOpacity:.8,particleColor:15987711,initParticles:function(){this.velocities=[],this.glObject.geometry.vertices.length=this.particleCount,this.velocities.length=this.particleCount;for(var e=0;e<this.particleCount;e++)this.velocities[e]=new THREE.Vector3,this.velocities[e].fromArray([0,1,0]),this.glObject.geometry.vertices[e]=this.getStartingPoint()},getStartingPoint:function(e){return e=e||new THREE.Vector3,e.fromArray([0,0,.05]),this.object.glObject.matrixWorld&&e.applyMatrix4(this.object.glObject.matrixWorld),e},update:function(e){t.ParticleSystem.prototype.update.call(this,e);for(var i=this.glObject.geometry.vertices,a=0,s=i.length;s>a;a++)i[a].addScaledVector(this.velocities[a],.6*e),this.glObject.geometry.verticesNeedUpdate=!0,Math.random()<.1*e&&this.getStartingPoint(i[a])}}),e.jetpackSmoke=t.ParticleSystem.extend({particleCount:30,particleSize:.02,decayRate:0,initParticles:function(){this.velocities=[],this.glObject.geometry.vertices.length=this.particleCount,this.velocities.length=this.particleCount;for(var e=0;e<this.particleCount;e++)this.velocities[e]=new THREE.Vector3,this.velocities[e].fromArray(this.particleDir),this.glObject.geometry.vertices[e]=this.getStartingPoint()},getStartingPoint:function(e){return e=e||new THREE.Vector3,e.x=this.particleDir[0],e.y=this.particleDir[1],e.z=this.particleDir[2],e.applyMatrix4(this.object.matrixWorld),t.perturb(e,.025),e},update:function(e){t.ParticleSystem.prototype.update.call(this,e);for(var i=this.glObject.geometry.vertices,a=0,s=i.length;s>a;a++)if(i[a].addScaledVector(this.velocities[a],2*e),this.glObject.geometry.verticesNeedUpdate=!0,Math.random()<.5){this.getStartingPoint(i[a]);var r=Vec.copy(this.particleDir);t.perturb(r,.1),this.velocities[a].fromArray(r)}}}),e.themes={};e.SceneryMaterial.clone();e.FlameMaterial=new THREE.ShaderMaterial({vertexShader:$("#particleVertexShader").text(),fragmentShader:$("#particleFragmentShader").text(),transparent:!0,blending:THREE.AdditiveBlending,uniforms:{scale:{type:"f",value:15},playerPos:{type:"v3",value:new THREE.Vector3}}}),e.CloudMaterial=new THREE.ShaderMaterial({vertexShader:$("#cloudVertexShader").text(),fragmentShader:$("#cloudFragmentShader").text(),uniforms:{scale:{type:"f",value:1e4}},transparent:!0,depthTest:!1}),e.CloudMaterial.sharedAsset=!0,e.CloudSystem=t.ParticleSystem.extend({dynamic:!1,material:e.CloudMaterial,particleSize:1e4,initParticles:function(){for(var e=this.glObject.geometry,t=0;30>t;t++)for(var i=Math.randomReal(60,200),a=Math.randomReal(1,2)*i,s=Math.randomReal(0,2*Math.PI),r=Math.randomReal(-1,1),n=[Math.sqrt(1-r*r)*Math.cos(s)*a,Math.sqrt(1-r*r)*Math.sin(s)*a,r*a],o=0;10>o;o++)for(var l=Vec.vary(n,10),h=0;10>h;h++){var c=new THREE.Vector3;c.fromArray(Vec.vary(l,5)),e.vertices.push(c)}}}),e.handleTileStepForAvatar=function(t){if(this.avatar&&this.avatar.slots&&(this.slotArray.length>2&&(this.slotArray=[]),this.slotArray.push(t.slotType),this.slotArray.length>2)){e.overlay.factors.slots=e.overlay.factors.slots||{reason:"Slots",factor:1};var i=e.overlay.factors.slots.factor;this.slotArray[0]==this.slotArray[1]==this.slotArray[2]?e.overlay.factors.slots.factor=Math.clamp(i+.25,.5,5/3):e.overlay.factors.slots.factor=Math.clamp(i-.1,.5,5/3),e.overlay.updateMultiplier()}},e.themes.addHazards=function(){var t=this.avatar;if(t){if(this.avatarData={},t.slots){this.slotArray=[],this.avatarData.slots=[];for(var i=0;i<this.tiles.length;i++)this.tiles[i].slotType=i%3}if(t.coins){this.avatarData.coins=[],this.avatarData.numCoins=0,this.coinMap={},e.overlay&&e.overlay.setFactor("coins",{type:"add",factor:0,reason:"gold coins"});for(var i=0;i<this.tiles.length;i++)if(!(Math.randomReal(0,1)<.8)){this.avatarData.numCoins++;var a=this.tiles[i],s=Vec.displace(a.center,a.normal,.5*a.sideLength),r=.5*a.sideLength,n=Math.round(s[0]/r)+","+Math.round(s[1]/r)+","+Math.round(s[2]/r);if(!this.coinMap[n]){var o=new e.Coin({geometryLoader:this.avatar.theme.sceneryGeometries});o.setPosition(this.tiles[i].center),o.faceDirection(this.tiles[i].normal,Vec.swapAxes(this.tiles[i].normal)),o.tile=this.tiles[i],o.center=Vec.displace(this.tiles[i].center,this.tiles[i].normal,o.height),this.add(o),this.avatarData.coins.push(o),this.coinMap[n]=o}}}if(t.bullets){this.avatarData.bullets=[];for(var i=0;i<this.tiles.length;i++)if(i!=this.startTile){var a=this.tiles[i];if(Math.randomReal(0,1)<.1){var l=new e.Bullet({type:"collada",geometry:t.theme.bulletGeometry.getGeometry("bullet")});l.setScale(.04);var h=_.randomKey(a.neighbors);l.puzzle=this,l.state={tile:a,up:a.normal,animUp:a.normal,direction:Vec.STRING_AXIS[h],speed:1,position:a.center},l.orient(),this.avatarData.bullets.push(l),this.add(l)}}}if(t.urchins){this.avatarData.urchins=[];for(var i=0;i<this.tiles.length;i++)if(Math.randomReal(0,1)<.25&&i!=this.startTile){var c=new e.Urchin;this.add(c),c.tile=this.tiles[i];var r=.8*c.tile.sideLength,u=Vec.sub([1,1,1],Vec.abs(c.tile.normal)),d=[0,0,0];u[0]&&(d[0]=(.5-Math.randomReal(0,1))*r),u[1]&&(d[1]=(.5-Math.randomReal(0,1))*r),u[2]&&(d[2]=(.5-Math.randomReal(0,1))*r),d=Vec.add(d,Vec.setLength(c.tile.normal,.04*r)),c.originalPosition=Vec.add(c.tile.center,d),c.setPosition(c.originalPosition),c.lookAt(Vec.add(c.originalPosition,c.tile.normal),[0,1,0]),this.avatarData.urchins.push(c)}}}},e.themes.cleanUpHazards=function(){function e(e){this.remove(e)}this.avatar;this.avatarData&&(_.each(this.avatarData.urchins,e,this),_.each(this.avatarData.bullets,e,this),_.each(this.avatarData.coins,e,this))},e.themes.explodeHazards=function(e){if(this.avatarData){if(this.avatarData.urchins)for(var t=this.avatarData.urchins,i=0;i<t.length;i++){var a=t[i].tile;t[i].setPosition(Vec.add(t[i].originalPosition,Vec.scale(a.normal,8*e)))}if(this.avatarData.bullets)for(var s=this.avatarData.bullets,r=0;r<s.length;r++){var a=s[r].state.tile;s[r].setPosition(Vec.add(a.center,Vec.scale(a.normal,8*e)))}if(this.avatarData.coins)for(var n=this.avatarData.coins,o=0;o<n.length;o++){var a=n[o].tile;n[o].setPosition(Vec.add(a.center,Vec.scale(a.normal,8*e)))}}},e.themes.updateHazards=function(i,a){var s=this.avatar;if(s&&!_.isEmpty(this.avatarData)){Vec.displace(a.getPosition(),e.gamePlayer.playerCharacterUp||e.gamePlayer.playerIn||[0,1,0],.65*e.gamePlayer.human.height);if(e.gamePlayer.human.getBoundingBox){var r=e.gamePlayer.human.getBoundingBox();if(this.state==e.PUZZLE_STATE.PLAY){if(s.bullets)for(var n=this.avatarData.bullets,o=0;o<n.length;o++){var l=n[o];if(l.active){var h=Vec.displace(l.getPosition(),l.state.animUp,l.lift),c=a.getLocalPosition(h);!l.state.invertFlag&&r.distanceToPoint(t.ArraytoV3(c))<l.radius&&(e.audioManager.playSynth({volume:12*e.VOLUME,frequency:100,duration:.5}),l.hit(),this.die()),l.state.tile.cleared&&n[o].fadeOut()}}if(this.avatarData.coins)for(var u=this.avatarData.coins,d=0;d<u.length;d++){var m=u[d],p=m.center,f=a.getLocalPosition(p);if(r.distanceToPoint(t.ArraytoV3(f))<m.radius){e.overlay.factors.coins.factor+=1/this.avatarData.numCoins,e.overlay.updateMultiplier();var g=this;return e.audioManager.playSynth({frequency:this.baseNotes[4]*this.noteShift*8,duration:.25,prepare:function(e,t){e.duration=.25,e.osc.frequency.setTargetAtTime(g.baseNotes[6]*g.noteShift*8,t+.1,4),e.osc2.frequency.setTargetAtTime(g.baseNotes[6]*g.noteShift*8,t+.1,4),e.humpTime=0},volume:8*e.VOLUME}),this.remove(m),void(this.avatarData.coins=_.without(u,m))}}if(this.avatarData.urchins)for(var v=this.avatarData.urchins,y=0;y<v.length;y++){var b=v[y];a.distanceTo(b)<b.radius&&(b.wiggle(),this.die())}}}}},e.themes.applyAvatar=function(){e.overlay&&delete e.overlay.factors.slots,e.themes.addHazards.call(this),e.themes.addTileScenery.call(this,this.avatar.theme)},e.themes.addTileScenery=function(i){if(i&&i.scenery){this.sceneryGroup=new t.Group,this.add(this.sceneryGroup);var a=e.TILE_MODE||"mix";this.sceneryMaterial=e.SceneryMaterial.clone(),this.sceneryMaterial.uniforms.nearGradient.value.setHex(this.originalShader.uniforms.nearGradient.value.getHex()),this.sceneryMaterial.uniforms.farGradient.value.setHex(this.originalShader.uniforms.farGradient.value.getHex()),this.sceneryMaterial.uniforms.cameraDist.value=this.cameraDist,this.tileSceneries=[];for(var s=i.scenery.count,r=0;r<this.tiles.length;r++){var n=this.tiles[r],o=0;if(n.normal[1]<.5){if("mixTop"==a)continue;"top"==a&&(o=-1)}else"top"==a&&(o=1);var l;l=1==o||0==o&&Math.randomReal(0,1)<.35?new t.Object3D({type:"collada",geometry:i.sceneryGeometries.getGeometry("tile"+r%s),material:this.sceneryMaterial}):new t.Object3D({type:"collada",geometry:i.sceneryGeometries.getGeometry("disp"+r%s),material:this.sceneryMaterial}),this.tileSceneries.push(l),n.scenery=l,this.changeTileColor(n,0),l.setPosition(n.center),l.originalPosition=l.getPosition();var h=Vec.multiply(Vec.sub([1,1,1],Vec.abs(n.normal)),[Math.randomReal(-1,1),Math.randomReal(-1,1),Math.randomReal(-1,1)]);l.lookAt(Vec.add(n.center,n.normal),Vec.toAxis(h)),l.setScale(.5*this.sideLength),this.sceneryGroup.add(l)}}},e.trail=t.ParticleSystem.extend({particleCount:100,particleSize:.02,particleOpacity:.6,particleColor:16711935,decayRate:1,speed:.1,spread:.05,initParticles:function(){this.velocities=[],this.glObject.geometry.vertices.length=this.particleCount,this.velocities.length=this.particleCount;for(var t=e.gamePlayer.player.getWorldPosition(),i=0;i<this.particleCount;i++)this.velocities[i]=new THREE.Vector3,this.velocities[i].fromArray(Vec.scale(Vec.randomAngle(),this.speed)),this.glObject.geometry.vertices[i]=new THREE.Vector3,this.glObject.geometry.vertices[i].fromArray(t);this.setVisibility(!1)},update:function(i){t.ParticleSystem.prototype.update.call(this,i);var a=(e.gamePlayer.activePuzzle,e.gamePlayer.playerCharacterUp||[0,1,0]),s=0,r=e.gamePlayer.player.getWorldPosition();s=1,this.setVisibility(!0);for(var n=this.glObject.geometry.vertices,o=0,l=n.length;l>o;o++){if(n[o].addScaledVector(this.velocities[o],1.5*i),s&&Math.random()<i*this.decayRate){var h=Vec.displace(Vec.vary(r,this.spread),a,Math.random()*e.gamePlayer.human.height*.5);n[o].fromArray(h),this.goUp&&this.velocities[o].fromArray(Vec.scale(Vec.add(Vec.randomAngle(),a),.5*this.speed))}this.glObject.geometry.verticesNeedUpdate=!0}this.material&&this.material.uniforms&&this.material.uniforms.playerPos&&this.material.uniforms.playerPos.value.fromArray(e.gamePlayer.player.getPosition())}}),e.themes.applyTheme=function(i){var a=i.theme;if(e.overlay&&e.overlay.deleteFactor("coins"),i.bullets&&(a.bulletGeometry=a.bulletGeometry||new t.GeometryLoader({src:i.bullets.src})),i.trail&&(this.themeObjects.trail=new e.trail(i.trail),this.effectsGroup.add(this.themeObjects.trail)),i.scatter){var s=i.scatter,r=e.BasicMaterial.clone();r.uniforms.color.value.setHex(16777215),r.uniforms.ambient.value=.9,a.scatterGeometries=a.scatterGeometries||new t.GeometryLoader({src:s.src,geoRotate:[.5*Math.PI,0,0]});for(var n=0,o=[r],l=s.groups||[],h=0;h<l.length;h++)o[h]=e.BasicMaterial.clone(),o[h].uniforms.color.value.setHex(l[h].color),o[h].uniforms.gloss.value=s.gloss,o[h].uniforms.specularColor.value.fromArray(s.specular),o[h].uniforms.ambient.value=.9;for(var c=0;c<s.number;c++){s.groups&&s.groups[n]&&s.groups[n].number<c&&n++;var u=this.themeObjects["cloud"+c]=new t.Object3D({type:"collada",geometry:a.scatterGeometries.getGeometry("cloud"+c%s.count),material:o[n]}),d=Vec.randomSphere(10,20,s.bounds||1),m=d[1];d[1]=d[2],d[2]=m,u.setPosition(d),u.lookAt([0,0,0],[0,1,0]),u.setScale(s.scale||1),this.themeGroup.add(u)}}if(i.scape){var s=i.scape,r=e.BasicMaterial.clone();r.uniforms.color.value.setHex(14540253),r.uniforms.ambient.value=.9,a.scatterGeometries=a.scatterGeometries||new t.GeometryLoader({src:s.src});var p=this.themeObjects.scape=new t.Object3D({type:"collada",geometry:a.scatterGeometries.getGeometry("cloud0"),material:r});p.faceDirection([0,-1,0],[1,0,0]),p.setScale(1.2),this.themeGroup.add(p)}i.flame&&(this.themeObjects.flame=new e.trail({particleCount:500,particleSize:15,decayRate:13,spread:.03,speed:.2,goUp:1,particleColor:16711680,material:e.FlameMaterial}),this.effectsGroup.add(this.themeObjects.flame)),a.colors&&a.colors.background2&&(this.themeObjects.gradient=new t.Object3D({type:"icosahedron",shapeRadius:1e3,shapeSubdivisions:1,material:e.GradientMaterial.clone()}),this.themeObjects.gradient.glObject.material.uniforms.loColor.value.fromArray(a.colors.background),this.themeObjects.gradient.glObject.material.uniforms.hiColor.value.fromArray(a.colors.background2),this.themeGroup.add(this.themeObjects.gradient)),a.synthType1&&(e.audioManager.synthType1=a.synthType1),a.synthType2&&(e.audioManager.synthType2=a.synthType2),a.detune&&(e.audioManager.synthDetune=a.detune),a.synth2Gain&&(e.audioManager.synth2Gain=a.synth2Gain);var f=this;a.scenery&&!a.sceneryGeometries&&(a.sceneryGeometries=new t.GeometryLoader({src:a.scenery.src})),a.starfield&&(f.themeObjects.starField=new t.StarField({color:8947848,opacity:1,milkyway:1,twinkle:1,distance:800,numParticles:1e3}),f.themeObjects.starField2=new t.StarField({color:16777215,opacity:1,milkyway:1,twinkle:1,distance:400,numParticles:50}),f.themeGroup.add(f.themeObjects.starField),f.themeGroup.add(f.themeObjects.starField2)),a.clouds&&(f.themeObjects.cloudField=new e.CloudSystem,f.themeObjects.cloudField.setEuler([0,.2,0]),f.themeGroup.add(f.themeObjects.cloudField)),a.ocean&&(f.themeObjects.oceanBox=new t.Object3D({type:"box",shapeDimensions:[1e3,20,1e3],material:e.OceanMaterial}),f.themeGroup.add(f.themeObjects.oceanBox),f.themeObjects.bubbles=new e.Bubbles({object:f.player}),f.effectsGroup.add(f.themeObjects.bubbles))},e.themes.addNoise=function(e,i){var a=.8;e.noiseField=new t.StarField({color:14408405,opacity:1,size:a,twinkle:1,distance:30,numParticles:1e3}),e.noiseField2=new t.StarField({color:13946310,opacity:1,size:2*a,twinkle:2,distance:100,numParticles:2e3}),e.noiseField3=new t.StarField({color:13288637,opacity:1,size:5*a,twinkle:3,distance:300,numParticles:2e3}),i.add(e.noiseField3),i.add(e.noiseField2),i.add(e.noiseField)};var c=0;e.updateGameForAvatar=function(t){void 0!=this.avatarData.jetpackTime&&this.updateJetpack(t),void 0!=this.avatarData.bombTime&&this.updateBomb(t),this.avatarData.dashStartPos&&this.updateDash(t);var i=e.user.get("activeAvatar");if(i.tail){var a=8*t;e.gamePlayer.activePuzzle.victory&&(a*=3),c+=a,this.avatarData.tail&&this.avatarData.tail.rotation.set(0,0,.5*Math.sin(c))}}},Visuals=function(e){e.CLIENT_VERSION=1;var t=GAME.GFX,i=99999999,a=.002,s=1,r=0;e.REMOVING_DUR=2.2,e.DEATH_DUR=1,e.VICTORY_DUR=3,e.POSE_DUR=3,e.CAMERA_DIST=2,e.JOIN_TILES=1,e.TEST_SHAPE=0;var n=.9,o=.01;e.VOLUME=o,e.GAME_ACTIVITY=Enum(["DEFAULT","REMOVING"]),e.INVERTED_DIRECTIONS={UP:"DOWN",DOWN:"UP",LEFT:"RIGHT",RIGHT:"LEFT"},e.ACHIEVEMENTS={COMPLETIONIST:{ALL_EASY:{text:"COMPLETE ALL EASY LEVELS"},ALL_INTERMEDIATE:{text:"COMPLETE ALL INTERMEDIATE LEVELS"},ALL_ADVANCED:{text:"COMPLETE ALL ADVANCED LEVELS"},ALL_INSANE:{text:"COMPLETE ALL INSANE LEVELS"},ALL_AVATARS:{text:"UNLOCK ALL AVATARS"},PERFECT_EASY:{text:"SET PERFECT RETRY RECORD ON ALL EASY LEVELS"},PERFECT_INTERMEDIATE:{text:"SET PERFECT RETRY RECORD ON ALL INTERMEDIATE LEVELS"},PERFECT_ADVANCED:{text:"SET PERFECT RETRY RECORD ON ALL ADVANCED LEVELS"},PERFECT_INSANE:{text:"SET PERFECT RETRY RECORD ON ALL INSANE LEVELS"},MANY_GIMBLES:{text:"GET 500,000 GIMBLES"}}},$(document).on("visibilitychange",function(){if("hidden"==document.visibilityState){if(e.audioManager&&(e.audioManager.stopSynth(),e.gamePlayer)){var t=e.state.get("focus");"menu"==t?e.gamePlayer.pause():"gamePlayer"==t&&e.overlay.togglePauseMenu(!0)}}else if(e.gamePlayer){var t=e.state.get("focus");"menu"==t&&e.gamePlayer&&e.gamePlayer.readyToGo&&!e.overlay?e.gamePlayer.unpause():"shop"==t&&e.overlay.playShopMusic()}}),$(window).blur(function(){if(e.gamePlayer){var t=e.state.get("focus");"gamePlayer"==t&&e.overlay.togglePauseMenu(!0)}});var l={wrappers:[{wrapper_side:"/images/menu/amzn/wrapper_zippy_left.png",wrapper_top:"/images/menu/amzn/wrapper_zippy_top.png",label:"zippy_trexo recommends"},{wrapper_side:"/images/menu/amzn/wrapper_orby_left.png",wrapper_top:"/images/menu/amzn/wrapper_orby_top.png",label:"orby recommends"},{wrapper_side:"/images/menu/amzn/wrapper_andi_left.png",wrapper_top:"/images/menu/amzn/wrapper_andi_top.png",label:"andi_oxturn recommends"},{wrapper_side:"/images/menu/amzn/wrapper_queen_left.png",wrapper_top:"/images/menu/amzn/wrapper_queen_top.png",label:"queen_azelfi recommends"},{wrapper_side:"/images/menu/amzn/wrapper_duncan_left.png",wrapper_top:"/images/menu/amzn/wrapper_duncan_top.png",label:"duncan_plunder recommends"},{wrapper_side:"/images/menu/amzn/wrapper_pawlo_left.png",wrapper_top:"/images/menu/amzn/wrapper_pawlo_top.png",label:"pawlo recommends"}],amzn:["//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=primemain&banner=097TDSG20MH99VMHNX82&f=ifr&lt1=_new&linkID=ca64ae43ee40bcd796b58f5306e2eedd&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=kuft&banner=19P4Y3M8FNN5JYX3PJ82&f=ifr&lt1=_new&linkID=db8e53f07fa7e6c70a67c2b5e966028d&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=primegift&banner=0DHKFFV9MZ6GTWBFZK82&f=ifr&lt1=_new&linkID=8b0a250281560e7ce5406d6bc7a34852&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=primemain&banner=1PREMK5A0BD4VB6F8Y02&f=ifr&lt1=_new&linkID=654d9d81d09a3b0355b28c89d98b7293&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=audible&banner=0JYEMDNC49A58GM3J902&f=ifr&lt1=_new&linkID=1b9de5658e1abb01406327932c411240&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=primeent&banner=13E898KKBGT2Q3TD6G02&f=ifr&lt1=_new&linkID=ff72e76c65f5b0345722fda1f84c7a73&t=baanfell-20&tracking_id=baanfell-20","//rcm-na.amazon-adsystem.com/e/cm?o=1&p=48&l=ur1&category=student_usa&banner=0S7P6QRT4G5FFQ3HVX02&f=ifr&lt1=_new&linkID=4f2478010179d89daa2506ff519bf050&t=baanfell-20&tracking_id=baanfell-20"]};e.TEST_LEVEL={name:"testpuzzle",level_id:-1,directory:"testdir",puzzles:[{name:"dip",s:.7,path:"fs rd fs rs fu fd fu fs ls rs fu fd fu fs fs fu rd fd ld ru fs ru ls ls fs ru fs fu ld rd fd ld ru fu fs ls fs rs fs fu ls fs rs fs fu fd fu fs fs ls ru fs fu ld rd fd ld ru",reward:30,opts:{startTile:0,startDir:[0,0,-1],cameraType:"follow",playerSpeed:2,cameraAngle:20}}]};var h=new GAME.AudioManager;e.SAID_ROTOPO=0,e.audioManager=h,h.loadSounds({rotopo:{src:"/assets/sounds/rotopo",volume:33*o,callback:function(){-1==e.SAID_ROTOPO&&e.audioManager.playSound("rotopo")}},new_record:{src:"/assets/sounds/new_record",volume:33*o}}),e.User=GAME.User.extend({}),e.HumanObject=t.Object3D.extend({setArmsOut:function(){},setStanding:function(){}}),e.Menu=GAME.Views.View.extend({clientVersion:e.CLIENT_VERSION,setup:function(){if(Handlebars.registerPartial("bknfr-footer",function(){return GAME.templates["bknfr-footer"]()}()),console.log(GAME.templates.console()),GAME.SYSTEM.MOBILE&&$("#view").addClass("mobile"),$(document).on("focus",".button",function(t){e.$focusedButton=$($(this)[0])}),$("#view").on("mouseover",".button",function(){}),$(window).resize(this.resizeBoxes),this.user=new GAME.User,e.menu=this,e.state=new GAME.State,e.state.setFocus("menu"),e.user=this.user,!GAME.GFX.WEBGL)return void this.displayAlert({error:"NO_WEBGL"});this.gamePlayer=new e.GamePlayer({el:this.$el}),e.gamePlayer=this.gamePlayer,this.initUserData(this.content),document.hasFocus()||this.gamePlayer.pause();var t=this;if(this.on("api-error",function(){t.displayAlert({error:"CONNECTION_ERROR"})}),e.TEST_SHAPE)return this.createMenu(),this.play(),this.gamePlayer.activity=e.GAME_ACTIVITY.DEFAULT,this.gamePlayer.unpause(),void(this.gamePlayer.readyToGo=1);e.gamePlayer.screenSaver=!0;var i=new e.Puzzle({level:e.TEST_LEVEL});i.makePuzzle(0),this.gamePlayer.showScreenSaver(i),this.gamePlayer.unpause(),this.gamePlayer.readyToGo=1,
this.signedIn?(this.createMenu(),this.swapOutTryButton()):(this.user.on("status-change",this.handleNetworkStatus),this.createMenu(),t.$(".button.fblogin").css("opacity",.5),t.$(".button.gglogin").css("opacity",.5),this.user.connectFacebook(this.networkKeys.facebookAppID,function(e){return e?void t.displayAlert(e):void t.$(".button.fblogin").css("opacity",1)}),this.user.connectGoogle(t.networkKeys.googleAppID,t.networkKeys.googleClientID,function(e){return e?void t.displayAlert(e):void t.$(".button.gglogin").css("opacity",1)})),e.audioManager.hasSound("rotopo").buffer?(e.SAID_ROTOPO=1,e.audioManager.playSound("rotopo")):e.SAID_ROTOPO=-1},buttonTabbing:function(){$(".button").attr("tabindex",0)},showBadges:function(){var t=this.gameInfo.numAvatars+1==_.size(e.user.get("avatars")),i=e.user.get("gimbles")>=5e5,a=e.user.get("levelHistory"),s=e.user.get("levels"),r={easy:0,intermediate:0,advanced:0,insane:0},n=_.clone(r);for(var o in a){var l=s[o];a[o].completed>=l.puzzles.length&&r[l.difficulty]++,0==a[o].retry_record&&n[l.difficulty]++}this.displayAlert({type:"ACHIEVEMENTS"});var h=this.gameInfo.levelCounts;t&&$(".badge.ALL_AVATARS").addClass("done"),r.easy==h.easy&&$(".badge.ALL_EASY").addClass("done"),r.intermediate==h.intermediate&&$(".badge.ALL_INTERMEDIATE").addClass("done"),r.advanced==h.advanced&&$(".badge.ALL_ADVANCED").addClass("done"),r.insane==h.advanced&&$(".badge.ALL_INSANE").addClass("done"),i&&$(".badge.MANY_GIMBLES").addClass("done")},reloadMenu:function(){e.overlay.togglePauseMenu(!0),e.state.pushFocus("menu"),this.$menu.show(),this.createMenu(),this.signedIn&&this.swapOutTryButton(),$("#overlay").hide(),this.$(".button.try").html("continue roTopo"),this.$(".button.try").unbind();var t=this;this.$(".button.try").click(function(){e.state.popFocus(),t.$menu.hide(),$("#overlay").show()})},swapOutTryButton:function(){this.$("#menu .button.try").html("continue roTopo"),this.$("#menu .button.back").html("continue roTopo"),this.$("#menu .auth-buttons").remove(),this.$("#menu .button.logout").show(),this.$(".button.try").unbind(),this.$(".button.try").click(this.play),this.$("#menu .info").html("<user>User: "+e.user.get("displayName")+" </user>"),this.resizeBoxes()},handleNetworkStatus:function(){this.user.network&&this.login()},logout:function(){var t=this,i=function(e){t.getAPI("/api/logout",{},function(t){e?location=e:location.reload()})};"facebook"==e.menu.content.network?this.user.connectFacebook(this.networkKeys.facebookAppID,function(){FB.getLoginStatus(function(e){return"connected"!=e.status?void i():void FB.logout(function(e){i("https://www.facebook.com/logout.php?next="+location.origin+"&access_token="+e.authResponse.accessToken)})})}):"google"==e.menu.content.network&&t.user.connectGoogle(t.networkKeys.googleAppID,t.networkKeys.googleClientID,function(){var e=gapi.auth2.getAuthInstance().signOut();e.then(function(){i()})})},login:function(){var t=this.user.getCredentials(),i={};e.user.get("points")&&(i.points=e.user.get("points")),e.user.get("levelHistory")&&(i.levelHistory=JSON.stringify(e.user.get("levelHistory"))),this.postAPI("/api/login",{credentials:t,data:i},this.handleLoginResponse)},handleLoginResponse:function(e){e.success?(this.initUserData(e.content||{}),this.swapOutTryButton(),this.signedIn=!0):this.displayAlert(e)},initUserData:function(t,i){this.content=t;var a=t.user_id||-1;if(0>a){var s=Number(GAME.storage.getItem("points_"+a));s&&(t.points=s);var r=GAME.storage.getItem(a+"_levelHistory");r&&(t.levelHistory=JSON.parse(r))}try{this.storedSettings=JSON.parse(GAME.storage.getItem(a+"_settings")),this.storedAvatarName=GAME.storage.getItem(a+"_avatar")}catch(n){}if(t.signedIn&&(this.signedIn=t.signedIn),t.network&&t.network_id){var o=t.network;o=o[0].toUpperCase()+o.slice(1),this.user.set("displayName",o+"(****"+t.network_id.substr(t.network_id.length-4)+")")}this.user.set("levels",t.levels||this.content.levels),this.user.set("levelHistory",t.levelHistory||{}),this.user.set("purchases",t.purchases||{}),this.user.set("avatars",t.avatars||{}),this.user.set("user_id",a),this.user.set("points",t.points||0);var l=this.user.get("avatars");if(l.sorghum={name:"sorghum",type:"default",theme:{defaultNoise:1},material:{color:Color255([69,48,72])}},i||(this.storedAvatarName&&l[this.storedAvatarName]?e.gamePlayer.changeAvatar(l[this.storedAvatarName]):e.gamePlayer.changeAvatar(l.sorghum)),this.storedSettings){var h=this.storedSettings.music;"on"==h?e.audioManager.enableSounds():"off"==h&&e.audioManager.disableSounds()}},displayAlert:function(t){var i;if(e.gamePlayer&&e.gamePlayer.hasFocus()&&e.overlay.togglePauseMenu(!0),t.type||t.type=="ERROR - "+t.error,"CONFIRM_RESTART"==t.type)i=$(GAME.templates["confirm-restart"]());else if("TUTORIAL"==t.type){var a=t.number;if($(".glow").removeClass("glow"),0==a?e.audioManager.loadSounds({hello:{src:"/assets/sounds/hello",volume:33*o,callback:function(){e.audioManager.playSound("hello")}}}):1==a?$(".game.line.levels").addClass("glow"):2==a?$("#level-menu").addClass("glow"):3==a?$("#multiplier").addClass("glow"):4==a?$(".tasks").addClass("glow"):5==a&&($(".game.line.gimbles .gimble-count").addClass("glow"),$(".game.line.gimbles .button.shop").addClass("glow")),7==a)return;i=$(GAME.templates["tutorial-"+t.number]())}else if("MANUAL"==t.type)i=$(GAME.templates.manual());else if("SHOP_REMINDER"==t.type)i=$(GAME.templates["remind-shop"]());else if("CONTACT"==t.type)i=$(GAME.templates.contact());else if("SETTINGS"==t.type)i=$(GAME.templates["box-settings"]()),e.overlay.drawOptions(i);else if("LEVEL_OVERVIEW"==t.type)i=$(GAME.templates["level-overview"](t.level));else if("ACHIEVEMENTS"==t.type)i=$(GAME.templates.achievements(e.ACHIEVEMENTS));else switch(t.error){case"NETWORK_ERROR":i=$(GAME.templates["alert-network"](t));break;case"INVALID_CREDENTIALS":i=$(GAME.templates["alert-invalid"](t));break;case"CONNECTION_ERROR":i=$(GAME.templates["alert-connection"](t));break;case"INSUFFICIENT_FUNDS":i=$(GAME.templates["alert-insufficient-funds"](t));break;case"NO_WEBGL":i=$(GAME.templates["alert-no-webgl"](t));break;default:i=$(GAME.templates["alert-other"](t));break;case"BRAINTREE_OFFLINE":i=$(GAME.templates["alert-braintree"](t))}var s=e.state.get("window")||{height:$(window).height(),width:$(window).width()};s.height>s.width?i.addClass("vertical"):i.addClass("horizontal"),$("#alerter").append(i),"LEVEL_OVERVIEW"==t.type&&t.level.video&&e.overlay.loadYoutubeAPI(),e.state.pushFocus(t.type),$("#alerter .button.reload").click(function(){location.reload()});var r=function(){i.remove(),e.overlay&&e.overlay.stopAdBonus(),0==$(".alert").length&&($("#alerter").hide(),e.state.popFocus())};return"TUTORIAL"==t.type&&($("#alerter .button.next").click(function(){r(),t.number++,e.menu.displayAlert(t)}),$("#alerter .button.shop").click(function(){r(),e.overlay.loadShop(function(){t.number++,e.menu.displayAlert(t)})})),$("#alerter .button.menu-return").click(function(){r(),e.menu.reloadMenu()}),$("#alerter .play-level").click(function(){r();var t=$(this).attr("level_id");e.overlay.playLevel(t)}),$("#alerter .button.ok").click(function(){r()}),$("#alerter .button.restart").click(function(){r(),e.gamePlayer.restartLevel()}),$("#alerter .button").attr("tabindex",0),$("#alerter .button").addClass("mob-btn",0),$("#alerter").show(),this.resizeBoxes(),i},play:function(){var t={antialiasing:"low",music:"on",camera:"auto",fullscreen:"off",controls:"default"};if(this.storedSettings)try{for(var i in this.storedSettings)t[i]=this.storedSettings[i]}catch(a){}var s=this;if(this.overlay?($("#overlay").show(),this.overlay.updateSettings(t),this.overlay.togglePauseMenu(!1)):(this.overlay=new e.Overlay({el:this.$("#overlay"),settings:t}),e.overlay=this.overlay,this.overlay.on("api-error",function(){s.displayAlert({error:"CONNECTION_ERROR"})})),this.$menu.hide(),e.state.setFocus("gamePlayer"),e.gamePlayer.unpause(),e.TEST_SHAPE)this.gamePlayer.playLevel(e.TEST_LEVEL),this.gamePlayer.activePuzzle.state=e.PUZZLE_STATE.PLAY;else{var r="1",n=0,o={};if(this.content.lastSave){var l=this.content.lastSave,h=this.content.levels[l.level_id],c=Number(l.puzzle_index)+1;if(l.winloss&&(e.overlay.factors.winloss.factor=Number(l.winloss)),c>=h.puzzles.length)return void e.overlay.shuffle();h&&(r=l.level_id,n=c,o={retries:l.retry_record,time:l.time_record,turns:l.turn_record})}this.gamePlayer.playLevel(this.content.levels[r],n,o),this.overlay.shuffleList=_.reject(this.overlay.shuffleList,function(e){return e.level_id==r||e.level_id==Number(r)})}},showLoginMenu:function(){this.$menu.html(GAME.templates["login-menu"]()),this.$menu.show(),this.$menu.css({marginTop:""});var e=this;$("#overlay .fade").show(),this.$(".button.back").click(function(){e.$menu.hide(),$("#overlay .fade").hide()}),this.$(".button.fblogin").click(function(){e.user.loginToFacebook()}),this.$(".button.gglogin").click(function(){e.user.loginToGoogle(e.networkKeys.googleClientID)}),this.resizeBoxes()},resizeBoxes:function(){var t=$(window).width(),i=$(window).height(),a=1;i>t?(a=i/1080,a=Math.min(a,t/721),a>.85&&1.1>a&&(a=1),a>1&&(a=1+.8*(a-1))):(a=t/1900,a=Math.min(a,i/300),a>.85&&1.1>a&&(a=1),1>a&&(a=1-.6*(1-a))),e.state.set("window",{fontSize:a,width:t,height:i,ar:t/i}),$("#view").css("font-size",12*a+"pt");var s=$(".youtube");s.attr("width",s.parent().width()),s.attr("height",s.parent().height())},createMenu:function(e){$(".loading-text").remove(),this.$menu=this.$("#menu"),this.$menu.html(GAME.templates.menu(GAME.SYSTEM)),this.$menu.css({marginTop:"-17em"});var t=this;this.$(".button.try").click(this.play),this.$(".button.fblogin").click(function(){t.user.loginToFacebook()}),this.$(".button.gglogin").click(function(){t.user.loginToGoogle(t.networkKeys.googleClientID)}),this.$(".button.logout").click(function(){t.logout()}),e&&this.displayAlert({error:"NETWORK_ERROR"}),this.resizeBoxes(),_.delay(function(){$(".ad").css({display:"",opacity:"",visibility:"",backgroundPosition:""})},300)},showAd:function(){var e=_.sample(l.wrappers),t=_.sample(l.amzn),i=$("<div class='wrap_left'></div>"),a=$("<div class='wrap_top'></div>");a.html(e.label);var s=$("<div class='unit'></div>");i.css({"background-image":"url("+e.wrapper_side+")"}),a.css({"background-image":"url("+e.wrapper_top+")"}),s.html('<iframe src="'+t+'" width="728" height="90" scrolling="no" border="0" marginwidth="0" style="border:none;" frameborder="0"></iframe>'),$("#menu-ad").append(i),$("#menu-ad").append(a),$("#menu-ad").append(s),s.click(function(e){e.target==this&&window.open("https://www.amazon.com/dp/B00DBYBNEE?_encoding=UTF8&adid=0WC028HAZX3RDJT8X2C6&camp=0&creative=0&linkCode=ur1&primeCampaignId=prime_assoc_ft&tag=baanfell-20")})}}),e.GamePlayer=GAME.Views.UI.extend({showScreenSaver:function(e){this.screenSaver=!0,this.introduceNextPuzzle(e)},restartLevel:function(){var t=e.user.get("user_id"),i=this.activePuzzle.level;GAME.storage.removeItem(t+"_levelsave_"+i.level_id),this.activePuzzle&&this.playLevel(i),e.overlay.togglePauseMenu(!1)},setActiveLevelData:function(e,t){e=e||{},this.activeLevelData={retries:e.retries||0,time:e.time||0,turns:e.turns||0,level_id:t}},playLevel:function(t,a,s){s=s||{},e.menu.content.other&&e.menu.content.other.login_days&&e.overlay.setFactor("login_days",{type:"add",reason:"logged in today",factor:.5,expires:GAME.now()+10*GAME.MINUTES}),$("#overlay .gimbles .tasks .line-section").removeClass("animating");var n=e.user.get("levelHistory");n[t.level_id]=n[t.level_id]||{completed:0,retry_record:i,time_record:i,turn_record:i};var o=e.user.get("user_id");if(!e.EDITOR)try{var l=GAME.storage.getItem(o+"_levelsave_"+t.level_id);if(l){var h=JSON.parse(l);a=h.puzzle_index,s=h}}catch(c){console.log(c)}var u=0;this.activePuzzle&&(this.screenSaver||this.activePuzzle.completed?(this.screenSaver&&this.activePuzzle.fail(),this.removeActivePuzzle("pass"),u=1):(this.removeActivePuzzle("shuffle"),this.activePuzzle.fail())),this.screenSaver=!1,this.setActiveLevelData(s,t.level_id),this.puzzleIndex=a%t.puzzles.length||r,this.checkPoint=this.puzzleIndex,this.level=t;var d=this.prepareNextPuzzle();this.introduceNextPuzzle(d),u&&d.setScale(1e-4)},setup:function(){this.scene=new t.Scene3D({el:this.$el,updateFn:this.update,backgroundColor:e.COLOR_THEME.backgroundHex});this.scene;this.camera=new e.GimbleCamera({controller:this,scene:this.scene}),this.themeGroup=new t.Group,this.scene.add(this.themeGroup),this.checkPoint=this.puzzleIndex,this.puzzleGroup=new t.Group,this.scene.add(this.puzzleGroup),this.createPlayer(),this.effectsGroup=new t.Group,this.scene.add(this.effectsGroup),this.rampUpSpeed=1},createPlayer:function(){this.player=new t.Group},loadAvatar:function(i){var a,s=e.BasicMaterial.clone();if(i.material&&(s.uniforms.color.value.fromArray(i.material.color),s.uniforms.specularColor.value.fromArray(i.material.specularColor||[0,0,0]),s.uniforms.gloss.value=i.material.gloss||0,s.uniforms.ambient.value=i.material.ambient||.8),"humanoid"==i.type||"default"==i.type){if(a=new t.Humanoid(_.extend(i.params||{},{material:s})),"default"==i.type){a.armTurnOut=.3,a.legTurnOut=.05,a.handDistance=1.2,a.material.uniforms.ambient.value=.7;var r=e.BasicMaterial.clone();r.uniforms.color.value.setHex(6393276),r.uniforms.dissolve=s.uniforms.dissolve;var n=t.makePyramidGeometry(.046,12,.039),o=1;t.transformGeometry({euler:[.55,0,0],translate:[0,0,.009],scale:[o,o,o],geometry:n});var l=new t.Object3D({geometry:n,material:r});a.bodyMeshes.head.add(l)}}else a=new e.HumanObject(_.extend(i.params||{},{material:s}));return a},changeAvatar:function(t){if(t){if(e.user.set("activeAvatar",t),this.human&&this.player.remove(this.human),t.preloaded||(t.preloaded=this.loadAvatar(t)),t.lift=t.lift||0,this.themeObjects)for(var i in this.themeObjects)this.themeGroup.remove(this.themeObjects[i]),this.effectsGroup.remove(this.themeObjects[i]),this.themeObjects[i].destroy();this.themeColors=e.COLOR_THEME,e.audioManager.synthType1="triangle",e.audioManager.synthType2="sine",e.audioManager.synthDetune=5,e.audioManager.synth2Gain=.5,this.$cssThemeLink&&this.$cssThemeLink.remove(),t.theme&&(this.themeObjects={},t.theme.defaultNoise&&e.themes.addNoise(this.themeObjects,this.themeGroup),t.theme.colors&&(this.themeColors=t.theme.colors),e.themes.applyTheme.call(this,t),t.theme.stylesheet&&(this.$cssThemeLink=$('<link rel="stylesheet" type="text/css" />'),this.$cssThemeLink.attr("href","/stylesheets/avatar_styles/"+t.theme.stylesheet+".css"),$("head").append(this.$cssThemeLink))),this.updateTheme(),this.human=t.preloaded,this.player.add(this.human),t.lift&&this.human.setPosition([0,0,t.lift])}},updateTheme:function(){var i=this.themeColors;this.scene.setBackgroundColor(i.background),e.MiniMeMaterial.uniforms.color.value.setColor(i.colored),e.TileMaterial.uniforms.coloredColor.value.setColor(i.colored),e.TileMaterial.uniforms.ghostColor.value.setColor(i.ghost),e.TileMaterial.uniforms.ghostAlpha.value=i.ghostAlpha,e.TileMaterial.uniforms.style.value=i.style||0,e.TileMaterial.uniforms.AOEffect.value=i.AOEffect||1,e.TileMaterial.uniforms.nearGradient.value.setColor(i.nearGradient||i.colored),e.TileMaterial.uniforms.farGradient.value.setColor(i.farGradient||i.colored),e.SceneryMaterial.uniforms.style.value=i.scenery_style||0,i.tileTexture?t.textureLoader.load(i.tileTexture,function(t){e.TileMaterial.uniforms.tex.value=t,e.gamePlayer.activePuzzle.updateTileTexture(t)}):e.TileMaterial.uniforms.tex.value=void 0},updateCamera:function(e){this.camera.gameUpdate(e)},prepareNextPuzzle:function(){this.flagUpdateAvatar&&(this.changeAvatar(this.flagUpdateAvatar),delete this.flagUpdateAvatar,"fail"==this.removingMode&&(this.removingMode="shuffle"),this.lastPuzzleTileData=null);var t=new e.Puzzle({level:this.level,player:this.player});return t.makePuzzle(this.puzzleIndex,this.lastPuzzleStartData),t.updateForLastPuzzle(this.lastPuzzleTileData),t},introduceNextPuzzle:function(t){var i="pass"==this.removingMode;if(this.puzzleGroup.add(t,i),t.setPosition([0,0,0]),this.activePuzzle=t,!this.screenSaver){e.state.set("currentPuzzle",t);var s=t.tiles[t.startTile],r=Vec.add(s.center,Vec.setLength(s.normal,a));r=Vec.add(r,Vec.scale(t.startDir,s.sideLength*-.4)),t.startPos=r,"fail"!=this.removingMode&&this.player.setPosition(r),this.playerDir=_.clone(t.startDir),this.playerIn=Vec.invert(s.normal),this.playerForward=_.clone(this.playerDir),this.playerRight=Vec.toAxis(Vec.perpendicular(this.playerDir,s.normal)),this.playerCharacterUp=Vec.invert(this.playerIn),t.startNormal=Vec.invert(this.playerIn),this.player.lookAt(Vec.add(this.player.getPosition(),this.playerCharacterUp),this.playerForward),this.playerCharacterDir=void 0,this.playerTile=s,"fail"==this.removingMode&&this.activePuzzle.explode(1),this.human.armsUp=0,this.human.setArmsOut(),this.direction="UP",this.setupAvatar(),this.updateRemovingPuzzle(0)}},setupAvatar:function(){this.avatarData={};var t=e.user.get("activeAvatar");this.human.setPosition([0,0,t.lift||0]),this.human.loaded&&(t.jetpack&&(this.avatarData.jetpack=this.human.bodyMeshes.body.glObject.children[0],this.avatarData.jetpack.visible=!1,this.avatarData.jetpack.material=e.jetpackFireMaterial),t.tail&&(this.avatarData.tail=this.human.bodyMeshes.body.glObject.children[0]))},removeActivePuzzle:function(t){this.removingPuzzle&&(this.destroyPuzzle(this.removingPuzzle),this.removingPuzzle=void 0),this.activePuzzle?(this.cleanAvatarData(),this.activePuzzle.cube.remove(this.player),this.removingPuzzle=this.activePuzzle,this.player.remove(this.activePuzzle.miniMe),"fail"==t?(this.lastPuzzleTileData=this.activePuzzle.tiles,this.lastPuzzleStartData={startTile:this.activePuzzle.startTile,startDir:this.activePuzzle.startDir}):(this.lastPuzzleTileData=null,this.lastPuzzleStartData=null)):this.removingPuzzle=1,this.removingAmount=0,this.removingTick=0,this.removingMode=t,this.camera.saveRemovingState(),this.activity=e.GAME_ACTIVITY.REMOVING},destroyPuzzle:function(e){e.cube.remove(this.player),this.puzzleGroup.remove(e),e.clear(!0)},handleTileCleared:function(){for(var e in this.themeObjects)this.themeObjects[e].burst&&this.themeObjects[e].burst()},debug:function(){for(var t=[this.camera.cameraPos,this.camera.cameraUp,this.player.getPosition(),this.playerCharacterUp,this.playerIn,this.playerForward,this.playerDir,this.playerRight],i=0;i<t.length;i++)t[i]&&isNaN(t[i][0])&&(console.log("ERROR for Vec",i),e.menu.displayAlert({error:"PROGRAM ERROR",message:"Whoops, roTopo has crashed! Try reloading the page."}))},quickSwapNextPuzzle:function(){this.puzzleIndex++,this.destroyPuzzle(this.activePuzzle);var e=this.prepareNextPuzzle();this.introduceNextPuzzle(e),this.activePuzzle.inspect()},updateRemovingPuzzle:function(t){if(this.removingPuzzle){var i=1;e.user.get("activeAvatar");if(i&&this.removingPuzzle.updateForPlayer(t,this.player,this.playerForward,this.playerRight,this.playerDir),"fail"==this.removingMode||"shuffle"==this.removingMode){s=this.removingAmount,this.activePuzzle.explode(Math.pow(1-this.removingAmount,2)+.001);var a=this.activePuzzle.tiles[this.activePuzzle.startTile];this.player.setPosition(Vec.displace(this.activePuzzle.startPos,a.normal,8*this.activePuzzle.explodeAmount)),i&&"shuffle"==this.removingMode&&this.removingPuzzle.setScale(1.0001-Math.pow(s,.5))}else if("pass"==this.removingMode){var s=Math.max(this.removingAmount,.01);i&&this.removingPuzzle.explode(this.removingAmount),this.activePuzzle.setScale(s)}this.human.material.uniforms.dissolve.value=0,this.removingTick>1?this.removingAmount+=t/e.REMOVING_DUR:this.removingTick+=1,this.removingAmount>1&&this.beginPuzzle(i)}},beginPuzzle:function(t){t&&this.destroyPuzzle(this.removingPuzzle);var i=e.user.get("activeAvatar");i.multiplier?e.overlay.setFactor("avatar",{type:"add",reason:i.name,factor:i.multiplier}):e.overlay.deleteFactor("avatar"),e.audioManager.stopEffects(),this.playerDeathPos=void 0,this.activePuzzle.state=e.PUZZLE_STATE.PLAY,this.activePuzzle.explode(0),this.activePuzzle.setScale(1),this.activePuzzle.resetTileColors(),this.rampUpSpeed=.3,0==this.activePuzzle.puzzleIndex&&this.setActiveLevelData({},this.activePuzzle.level.level_id),this.removingPuzzle=void 0,this.removingAmount=0,this.activity=e.GAME_ACTIVITY.DEFAULT,this.human.material.uniforms.dissolve.value=0,this.activePuzzle&&this.activePuzzle.fadeTileColor(this.playerTile)},updateScreenSaver:function(t){void 0==this.screenSaverTime&&(this.screenSaverTime=.4),this.screenSaverTime+=t;var i=1.75;if(this.screenSaverTime+t>i){var a=i-this.screenSaverTime;this.screenSaverTime=-a,this.screenSaverCounter=this.screenSaverCounter||0,this.screenSaverCounter%4==0&&(void 0==this.ssTone&&(this.ssTone=-1,this.ssLoop=-1),this.ssTone=(this.ssTone+1)%4,0==this.ssTone&&this.ssLoop++,0==this.ssTone||2==this.ssTone,this.ssLoop%2!=0?(this.sst1=[0,1,2,7][this.ssTone],this.sst2=[4,5,6,3][this.ssTone]):(this.sst1=[0,2,0,1][this.ssTone],this.sst2=[0,2,0,1][this.ssTone]));var s=e.MUSIC.MAJOR[this.sst1],r=e.MUSIC.MAJOR[this.sst2];GAME.SYSTEM.MOBILE||(h.playSynth({volume:10*o,frequency:s,pan:-.5+this.sst1/7,delay:a}),h.playSynth({volume:6*o,frequency:s,delay:a+.75*(i/2),pan:-.5+this.sst1/7}),h.playSynth({volume:7*o,frequency:r,delay:a+1*(i/2),pan:-.5+this.sst2/7}),h.playSynth({volume:7*o,frequency:r,delay:a+1.5*(i/2),pan:-.5+this.sst2/7})),this.screenSaverCounter++}void 0!=this.ssTone&&(this.xxx=this.xxx||0,this.xxx+=t,this.activePuzzle.setEuler([0,this.xxx*Math.PI*1.5/64,0]))},handleActivePuzzleVictory:function(){e.overlay.savePuzzleCompleted(this.activePuzzle),this.camera.saveVictoryState(),this.updatePlayerDirection()},updateActivePuzzle:function(t){var i=this.activePuzzle.state;e.user.get("activeAvatar");if(this.activity==e.GAME_ACTIVITY.REMOVING)return!0;if(i==e.PUZZLE_STATE.INSPECT)return!0;if(i==e.PUZZLE_STATE.VICTORY){this.updatePlayerOrientation(t,!0);var s=this.player.getPosition(),r=Vec.sub(s,this.activePuzzle.victoryTile.center),n=Vec.length(r);if(!this.avatarData.frozen&&n>.5*a){this.human.speed=.2*n;var o=Vec.moveTo(s,this.activePuzzle.victoryTile.center,.25*t);this.player.setPosition(o)}return this.human.armsUp=Math.clamp(Math.pow(this.activePuzzle.victoryTime/e.VICTORY_DUR,1.4),0,1),!0}if(i==e.PUZZLE_STATE.PASS){if(this.checkPoint=this.puzzleIndex,e.TEST_SHAPE||this.puzzleIndex++,this.puzzleIndex>=this.level.puzzles.length)e.overlay.shuffle();else{this.removeActivePuzzle("pass");var l=this.prepareNextPuzzle();this.introduceNextPuzzle(l),l.setScale(1e-4)}return!0}if(i==e.PUZZLE_STATE.FAIL){this.removeActivePuzzle("fail");var l=this.prepareNextPuzzle();return this.introduceNextPuzzle(l),!0}if(i==e.PUZZLE_STATE.DIE){var h=this.activePuzzle.dyingTime+=t/e.DEATH_DUR;return this.playerDeathPos=this.playerDeathPos||this.player.getPosition(),h>1&&this.activePuzzle.fail(),this.player.setPosition(Vec.displace(this.playerDeathPos,this.playerIn,h*h*6)),this.player.setPosition(Vec.displace(this.player.getPosition(),this.playerDir,.3*Math.pow(h,.5))),this.human.material.uniforms.dissolve.value=h,!0}return!1},updatePlayerDirection:function(){switch(this.direction){case"UP":Vec.copyInto(this.playerDir,this.playerForward);break;case"DOWN":this.playerDir=Vec.invert(this.playerForward);break;case"LEFT":this.playerDir=Vec.invert(this.playerRight);break;case"RIGHT":Vec.copyInto(this.playerDir,this.playerRight)}},queueNextAvatar:function(t){e.gamePlayer.flagUpdateAvatar=t,t.preloaded||(t.preloaded=this.loadAvatar(t))},updateForAvatar:function(t){e.updateGameForAvatar.call(this,t)},deployCountermeasures:function(){var t=e.user.get("activeAvatar");t.jetpack&&!this.avatarData.jetpackUsed&&this.deployJetpack(),t.bomb&&this.deployBomb(),t.dash&&this.deployDash()},deployDash:function(){this.avatarData.dashDeployed||(this.avatarData.immune=!0,this.avatarData.autopilot=!0,this.avatarData.dashStartPos=Vec.clone(this.player.getPosition()),this.avatarData.speed=2,this.avatarData.dashDeployed=!0,this.activePuzzle.markTileCleared(this.playerTile),this.avatarData.dashSynth=e.audioManager.playEffect({type:"DASH"}))},updateDash:function(e){var t=Vec.distance(this.avatarData.dashStartPos,this.player.getPosition());if(t>1.05*this.activePuzzle.sideLength){if(this.avatarData.immune=!1,this.avatarData.autopilot=!1,this.avatarData.speed=1,this.avatarData.dashSynth&&this.avatarData.dashSynth.stop(),delete this.avatarData.dashStartPos,Vec.rectDistance(this.player.getPosition(),this.playerTile.center)>.5*this.activePuzzle.sideLength){var i=this.activePuzzle.getTile(Vec.sub(this.player.getPosition(),Vec.setLength(this.playerIn,.03)),this.playerIn);if(!i)return void this.activePuzzle.die();this.playerTile=i}this.activePuzzle.fadeTileColor(this.playerTile)}},updateBomb:function(e){this.avatarData.bombTime+=e,this.avatarData.bombTime>1&&(this.avatarData.immune=!1,this.effectsGroup.remove(this.avatarData.objs.bombBlast),this.avatarData.objs.bombBlast.destroy(),this.avatarData.bombTime=void 0,this.avatarData.bombSynth&&this.avatarData.bombSynth.stop(),this.activePuzzle.completed||this.activePuzzle.die())},deployBomb:function(){if(!this.avatarData.bombDeployed){this.avatarData.immune=!0,this.avatarData.bombTime=0,this.avatarData.bombDeployed=!0,this.avatarData.frozen=!0;var t=this.player.getPosition();this.avatarData.objs=this.avatarData.objs||{},this.avatarData.objs.bombBlast=new e.bombBlast({}),this.avatarData.objs.bombBlast.setPosition(t),this.effectsGroup.add(this.avatarData.objs.bombBlast);for(var i=this.activePuzzle.tiles,a=this.activePuzzle.sideLength,s=0;s<i.length;s++)!i[s].activated&&Vec.distance(i[s].center,t)<1.5*a&&this.activePuzzle.fadeTileColor(i[s]);this.avatarData.bombSynth=e.audioManager.playEffect({type:"ICE_BOMB"})}},cleanAvatarData:function(){if(this.avatarData&&this.avatarData.objs){var e=this.avatarData.objs;for(var t in e)this.effectsGroup.remove(e[t]),e[t].destroy()}},deployJetpack:function(){if(this.human.loaded&&!this.avatarData.jetpack)this.avatarData.jetpack=this.human.bodyMeshes.body.glObject.children[0],this.avatarData.jetpack.visible=!1,this.avatarData.jetpack.material=e.jetpackFireMaterial;else if(!this.human.loaded)return;this.avatarData.jetpackUsed=!0,this.avatarData.jetpackTime=0,this.avatarData.jetpack.visible=!0,this.avatarData.immune=!0,this.avatarData.velocity=_.clone(this.playerDir),this.human.setStanding(),this.activePuzzle.markTileCleared(this.playerTile),this.avatarData.objs=this.avatarData.objs||{},this.avatarData.objs.jetpackSmoke=new e.jetpackSmoke({object:this.avatarData.jetpack,particleDir:Vec.invert(this.playerCharacterUp)}),this.effectsGroup.add(this.avatarData.objs.jetpackSmoke),this.avatarData.jetpackSynth=e.audioManager.playEffect({type:"JETPACK"})},updateJetpack:function(t){this.avatarData.jetpackTime+=t;var i=this.human.getPosition(),a=e.user.get("activeAvatar");if(this.avatarData.jetpackTime>1.95){if(delete this.avatarData.jetpackTime,this.avatarData.immune=!1,this.avatarData.jetpack.visible=!1,this.avatarData.speed=1,this.avatarData.velocity=void 0,i[2]=a.lift,this.human.setPosition(i),this.human.squat=0,this.human.setPosition([0,0,a.lift]),this.effectsGroup.remove(this.avatarData.objs.jetpackSmoke),this.avatarData.objs.jetpackSmoke.destroy(),delete this.avatarData.objs.jetpackSmoke,this.avatarData.jetpackSynth&&this.avatarData.jetpackSynth.stop(),Vec.rectDistance(this.player.getPosition(),this.playerTile.center)>.5*this.activePuzzle.sideLength){var s=this.activePuzzle.getTile(Vec.sub(this.player.getPosition(),Vec.setLength(this.playerIn,.03)),this.playerIn);if(!s)return void this.activePuzzle.die();this.playerTile=s}this.activePuzzle.fadeTileColor(this.playerTile)}else{var r=this.avatarData.jetpackTime/2;this.avatarData.jetpack.scale.z=1+.5*Math.sin(100*r),this.avatarData.speed=.8,this.avatarData.velocity=Vec.displace(this.avatarData.velocity,this.playerDir,5*t);var n=1;this.avatarData.velocity=Vec.scale(this.avatarData.velocity,1-n*t),Vec.length(this.avatarData.velocity)>1.3&&(this.avatarData.velocity=Vec.setLength(this.avatarData.velocity,1.3));var o=.25;if(this.avatarData.objs.jetpackSmoke.particleDir=Vec.invert(this.playerCharacterUp),o>r)i[2]=Math.inOut(r/o,2),this.human.squat=Math.min(r,.2);else{var l=1-(r-o)/(1-o);i[2]=l}i[2]*=.6,i[2]+=a.lift,r>.8&&(this.human.squat=1-r),this.human.speed=0,this.human.setPosition(i)}},updatePlayerOrientation:function(i,a,s){if(!this.avatarData.frozen){var s=s||this.player.getPosition(),r=Vec.invert(this.playerIn),n=e.user.get("activeAvatar");if("rigid"==n.type,a){var o=Vec.add(s,Vec.setLength(this.playerDir,.3*this.playerTile.sideLength)),l=this.playerTile.center,h=Math.max(Math.abs(o[0]-l[0]),Math.abs(o[1]-l[1]),Math.abs(o[2]-l[2]));if(h>.5001*this.playerTile.sideLength){var c,u=Vec.axisString(this.playerDir);if(this.playerTile.neighbors[u]&&(c=this.playerTile.neighbors[u]),c&&c!=this.playerTile){var d=Vec.dot(c.normal,Vec.invert(this.playerDir));(d>.9||"follow"==this.activePuzzle.cameraType&&-.9>d)&&(r=c.normal)}}}this.playerCharacterUp=this.playerCharacterUp||r,this.playerCharacterDir=this.playerCharacterDir||this.playerDir,this.playerCharacterUp=t.slerpVec(this.playerCharacterUp,r,Math.clamp(4*i,.001,1),.5*i,void 0,this.playerCharacterDir),this.playerCharacterDir=t.slerpVec(this.playerCharacterDir,this.playerDir,Math.clamp(7*i,.001,1),.7*i,void 0,this.playerCharacterUp),"rigid"==n.type,this.player.lookAt(Vec.add(s,this.playerCharacterUp),this.playerCharacterDir)}},checkTileUnderPos:function(e,t,i){var a=this.activePuzzle.getTile(e,Vec.sub(this.playerTile.testPoint,e));return(!a||t&&a==i)&&(a=this.activePuzzle.getTile(this.playerTile.testPoint2,Vec.sub(e,this.playerTile.testPoint2))),a},gameLoop:function(i){if(this.human.speed=0,!this.freeze){if(this.activePuzzle&&this.screenSaver)return void this.updateScreenSaver(i);if(this.debug(),this.activity==e.GAME_ACTIVITY.REMOVING&&this.updateRemovingPuzzle(i),this.activePuzzle&&(this.updateForAvatar(i),!this.updateActivePuzzle(i))){this.handleKeysDown(i),this.updatePlayerDirection(),this.activeLevelData.time+=Math.floor(1e3*i);var s=this.player.getPosition(),r=e.user.get("activeAvatar");this.rampUpSpeed+=1.2*i,this.rampUpSpeed>1&&(this.rampUpSpeed=1);var o=Math.pow(this.rampUpSpeed,1.6),l=(r.speed||1)*(this.avatarData.speed||1)*o;this.avatarData.frozen||this.avatarData.jetpackTime||(this.human.speed=.14*o,this.avatarData.speed&&(this.human.speed*=this.avatarData.speed));var h,c=i*n*(this.activePuzzle.playerSpeed||1)*l;h=this.avatarData.velocity?Vec.add(s,Vec.scale(this.avatarData.velocity,c)):Vec.add(s,Vec.scale(this.playerDir,c)),this.avatarData.frozen&&(h=_.clone(s));var u=this.playerTile,d=Vec.dot(Vec.sub(h,u.center),u.normal),m=Vec.setLength(this.playerIn,d-a);if("follow"==this.activePuzzle.cameraType)var m=Vec.setLength(this.playerIn,(d-a)*Math.clamp(0,i,1));if(Vec.length(m)>1)return void this.activePuzzle.die();this.player.setPosition(Vec.add(h,m)),s=this.player.getPosition();var p=Vec.sub(s,Vec.scale(this.playerIn,a)),f=this.playerTile.center,g=Vec.scalarProject(Vec.sub(p,f),this.playerDir);if(this.updatePlayerOrientation(i,!0,p),!(g<.3*this.playerTile.sideLength)&&g/this.playerTile.sideLength>.501){var v,y=Vec.axisString(this.playerDir);if(this.playerTile.neighbors[y]&&(v=this.playerTile.neighbors[y]),(!v||v.activated)&&this.deployCountermeasures(),v){if(!this.avatarData.immune&&(this.activePuzzle.markTileCleared(this.playerTile),this.activePuzzle.fadeTileColor(v),this.activePuzzle.state==e.PUZZLE_STATE.DIE))return;var b=this.playerTile.normal,E=v.normal,M=Vec.angleBetween(b,E),w=Vec.perpendicular(b,E);if(M>.01){this.playerForward;this.playerIn=Vec.invert(E),this.playerForward=Vec.toAxis(t.rotateV3AxisAngle(this.playerForward,w,M));this.playerRight;this.playerRight=Vec.toAxis(t.rotateV3AxisAngle(this.playerRight,w,M))}this.playerTile=v,this.updatePlayerDirection(),this.activePuzzle.updateTrackVecs(v)}else this.avatarData.immune||this.activePuzzle.die()}}}},update:function(e){e*=s,this.gameLoop(e),this.activePuzzle&&this.activePuzzle.updateForPlayer(e,this.player,this.playerForward,this.playerRight,this.playerDir),this.updateCamera(e)},restartGame:function(){this.playLevel(this.level)},handleKeysDown:function(e){},
handleClick:function(){if(this.scene.updateMouseCaster(this.mouseX,this.mouseY),!e.TEST_SHAPE)return!0;if(this.activePuzzle){var t=this.scene._rayCaster.intersectObject(this.activePuzzle.cube.glObject);if(t[0]&&void 0!=t[0].faceIndex){var i=this.activePuzzle.cube.glObject.geometry.faces[t[0].faceIndex].originalIndex,a=Math.floor(i/2);console.log(this.activePuzzle.tiles[a]),console.log("tile: ",a,"normal: ",this.activePuzzle.tiles[a].normal)}}},hasFocus:function(){return"gamePlayer"==e.state.get("focus")},changeDirection:function(t){this.hasFocus()&&("inverted"==e.overlay.settings.controls&&(t=e.INVERTED_DIRECTIONS[t]),this.lastStop=void 0,this.activity!=e.GAME_ACTIVITY.REMOVING&&(this.avatarData&&(this.avatarData.autopilot||this.avatarData.frozen)||(this.activeLevelData.turns++,this.direction=t)))},handleTouchMove:function(e){if(!this.hasFocus())return!0;e=e.originalEvent;var t=e;if(e.changedTouches&&(t=e.changedTouches[0]),this.touchStart){var i=[t.clientX-this.touchStart[0],t.clientY-this.touchStart[1]];e.preventDefault();var a=50;i[0]>a?(this.changeDirection("RIGHT"),this.touchStart=void 0):i[0]<-a?(this.changeDirection("LEFT"),this.touchStart=void 0):i[1]<-a?(this.changeDirection("UP"),this.touchStart=void 0):i[1]>a&&(this.changeDirection("DOWN"),this.touchStart=void 0)}},pause:function(){this.scene.pause()},unpause:function(){this.scene.unpause()},hide:function(){this.scene.hide()},show:function(){this.scene.show()},handleTouchStop:function(t){if(e.IOS_SOUND_ON||(e.IOS_SOUND_ON=1,e.audioManager.playSynth({frequency:200,volume:1e-4})),!this.hasFocus())return!0;if("viewport"==t.target.className||"fade"==t.target.className){if(t.preventDefault(),this.lastStop){var i=GAME.now()-this.lastStop,a=e.state.get("focus");200>i&&("gamePlayer"==a||"pauseMenu"==a)&&e.overlay.togglePauseMenu()}this.lastStop=GAME.now()}return this.touchStart=void 0,!0},handleTouchStart:function(e){if(!this.hasFocus())return!0;e=e.originalEvent;var t=e;e.changedTouches&&(t=e.changedTouches[0]),this.touchStart=[t.clientX,t.clientY]},editingKeypress:function(t){if("release"!=e.APP_MODE)switch(t){case"p":this.activePuzzle.pass();break;case"v":this.activePuzzle.playVictory(this.playerTile);break;case"z":}},handleKeypress:function(t){var i=e.state.get("focus");switch(t){case"left":case"a":this.changeDirection("LEFT");break;case"down":case"s":this.changeDirection("DOWN");break;case"right":case"d":this.changeDirection("RIGHT");break;case"up":case"w":this.changeDirection("UP");break;case"tab":if("gamePlayer"==i||"pauseMenu"==i)return e.overlay.shuffle(),!1;break;case"enter":var a=$(document.activeElement);a.is(":visible")&&a.trigger("click");break;case"backspace":if("gamePlayer"==i||"pauseMenu"==i)return e.menu.displayAlert({type:"CONFIRM_RESTART"}),!1;case"space":if("gamePlayer"==i||"pauseMenu"==i)return e.overlay.togglePauseMenu(),e.TEST_SHAPE&&$(".pause-button").hide(),!1;break;default:this.editingKeypress(t)}return!0}})};